<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      #viewDiv {
        position: absolute;
        left: 75px;
        right: 0;
        top: 0;
        bottom: 0;
        height: 100%;
      }

      #titleDiv {
        position: absolute;
        height: 55px;
        left: 0px;
        right: 0px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        color: #f8f8f8;
        background: #464646;
        z-index: 1;
      }

      #title {
        margin: 15px;
        font-size: 20px;
        overflow: hidden;
      }
      #menuDiv {
        position: absolute;
        top: 55px;
        left: 0;
        right: 0;
        height: calc(100% - 55px);
        width: 75px;
        overflow-y: auto;
      }
      #menuDiv [class*="esri-icon"] {
        font-size: 25px !important;
      }
      .menu-area {
        cursor : pointer;
      }
      .menu-area:hover {
        background-color: #464646;
        color: #59d6ff;
      }
      #backDiv, #metadataDiv {
        display: none;
      }
      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        /* z-index: 4999 ; */
        position: absolute !important;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }
      .active-menu {
        background-color: #464646;
        color: #59d6ff;
      }
      button {
        background-color: #0079c1 !important;
        color: #f8f8f8 !important;
      }
      button[disabled] {
        opacity: 100 !important;
        background-color: lightgray !important;
        color: #0079c1 !important;
      } 
      #toolbarMeasureDiv {
        flex-direction: row;
        flex-wrap: nowrap;
        display: flex;
      }
      .esri-widget--button {
        background-color: #efefef !important;
        color: #464646 !important;
        width: 40px !important;
        height: 40px !important;
        font-size: 16px !important;
      }
      .esri-widget--button.active,
      .esri-widget--button.active:hover,
      .esri-widget--button.active:focus {
        cursor: default;
        background-color: #999696 !important;
      }
      .esri-widget--button.active path,
      .esri-widget--button.active:hover path,
      .esri-widget--button.active:focus path {
        fill: #e4e4e4 !important;
      }
      .esri-legend__layer-caption {
        display: none !important;
      }
      .esri-legend {
        width: 200px !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.15/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css">
    <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script>
    <!-- interactive patterns need to be initialized -->
    <script>
       calcite.init()
    </script>
    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.15/"></script>
    
    <script>
      require([
        "esri/views/MapView",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        // "esri/widgets/HistogramRangeSlider",
        // "esri/renderers/smartMapping/statistics/histogram",
        // "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel",
        "esri/widgets/Search",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
        "esri/widgets/Legend"
      ], function(
        MapView, 
        Expand,
        FeatureLayer,
        Map,
        // HistogramRangeSlider,
        // histogram,
        // HistogramRangeSliderVM,
        Search,
        GraphicsLayer,
        Graphic,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement,
        BasemapGallery,
        PortalBasemapsSource,
        Legend
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        
        // メニューのリスト
        const listMenu = [
          {'text': 'measure ment', 'icon': "esri-icon-measure", 'phone-hide': true},
          {'text': 'basemap', 'icon': "esri-icon-basemap", 'phone-hide': false},
          {'text': 'search', 'icon': "esri-icon-search", 'phone-hide': true},
          {'text': 'legend', 'icon': "esri-icon-layer-list", 'phone-hide': false},
          {'text': 'info', 'icon': "esri-icon-description", 'phone-hide': false},
          {'text': 'metadata', 'icon': "esri-icon-documentation", 'phone-hide': false},
          {'text': 'back to index map', 'icon': "esri-icon-close-circled", 'phone-hide': false}
        ];
        const menuDiv = document.getElementById("menuDiv");

        // メニューボタンを追加
        for (let i in listMenu) {

          listMenu[i].elm = document.createElement('div');
          if (listMenu[i]['phone-hide'] === false) {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area";
          } else {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area phone-hide";
          };
          listMenu[i].elm.setAttribute("menu-id", i);
          menuDiv.insertBefore(listMenu[i].elm, menuDiv.firstChild);
          
          const menuIconDiv = document.createElement('div');
          menuIconDiv.className = listMenu[i]['icon'];
          menuIconDiv.setAttribute("menu-id", i);
          listMenu[i].elm.insertBefore(menuIconDiv, listMenu[i].elm.firstChild);
          
          const menuTextDiv = document.createElement('div');
          menuTextDiv.className = "font-size--2";
          menuTextDiv.innerHTML = listMenu[i]['text'];
          menuTextDiv.setAttribute("menu-id", i);
          menuIconDiv.parentNode.insertBefore(menuTextDiv, menuIconDiv.nextSibling);

        };

        function removeActiveMenu (index) {
          for (let i in listMenu) {
            if (i !== String(index)) {
              listMenu[i].elm.classList.remove("active-menu");
            };
          };
        };

        listMenu[5].elm.style.display = "none";
        listMenu[6].elm.style.display = "none";

        // マップ 
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-vector'
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, 1.0326589312043144],
          zoom: 4,
          padding: {
            top: 55
          }
        });

        view.ui.remove("zoom");

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;

        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {

          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };

        });

        // 計測ウィジェット
        const toolbarMeasureDiv = document.getElementById("toolbarMeasureDiv");
        const measurement = new Measurement({
          view: view
        });
        
        listMenu[0].elm.onclick = function(){
          if (!listMenu[0].elm.classList.contains("active-menu")) {
            listMenu[0].elm.classList.add("active-menu");
            view.ui.add(toolbarMeasureDiv, "bottom-left");
            view.ui.add(measurement, "bottom-right");
            view.ui.remove(basemapGallery, "bottom-left");
            view.ui.remove(searchWidget, "bottom-left");
            view.ui.remove(legend, "bottom-left");
          } else {
            listMenu[0].elm.classList.remove("active-menu");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
            distanceMeasureBtn.classList.remove("active");
            areaMeasureBtn.classList.remove("active");
          }
          removeActiveMenu(0);
        };

        const distanceMeasureBtn = document.getElementById("distanceMeasureBtn");
        const areaMeasureBtn = document.getElementById("areaMeasureBtn");
        const clearMeasureBtn = document.getElementById("clearMeasureBtn");

        distanceMeasureBtn.addEventListener("click", function() {
          measurement.activeTool = "distance";
          distanceMeasureBtn.classList.add("active");
          areaMeasureBtn.classList.remove("active");
        });

        areaMeasureBtn.addEventListener("click", function() {
          measurement.activeTool = "area";
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.add("active");
        });

        clearMeasureBtn.addEventListener("click", function() {
          measurement.clear();
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.remove("active");
        });

        // ベースマップウィジェット
        const portalSource = new PortalBasemapsSource({  
          query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
        });
                 
        const basemapGallery = new BasemapGallery({       
          view: view,     
          container: document.createElement("div"),       
          source: portalSource
        }); 

        listMenu[1].elm.onclick = function(){
          if (!listMenu[1].elm.classList.contains("active-menu")) {
            listMenu[1].elm.classList.add("active-menu");
            view.ui.add(basemapGallery, "bottom-left");
            view.ui.remove(searchWidget, "bottom-left");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            view.ui.remove(legend, "bottom-left");
            measurement.clear();
          } else {
            listMenu[1].elm.classList.remove("active-menu");
            view.ui.remove(basemapGallery, "bottom-left");
          }
          removeActiveMenu(1);
        };

        // 検索ウィジェット
        const searchWidget = new Search({
          view: view
        });

        listMenu[2].elm.onclick = function(){
          if (!listMenu[2].elm.classList.contains("active-menu")) {
            listMenu[2].elm.classList.add("active-menu");
            view.ui.add(searchWidget, "bottom-left");
            view.ui.remove(basemapGallery, "bottom-left");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            view.ui.remove(legend, "bottom-left");
            measurement.clear();
          } else {
            listMenu[2].elm.classList.remove("active-menu");
            view.ui.remove(searchWidget, "bottom-left");
          }
          removeActiveMenu(2);
        };

        // 凡例
        const legend = new Legend({
          view: view,
          layerInfos: [
            {
              layer: zukakuFeatureLayer,
              title: "Printed year"
            }
          ]
        });
        

        listMenu[3].elm.onclick = function(){
          if (!listMenu[3].elm.classList.contains("active-menu")) {
            listMenu[3].elm.classList.add("active-menu");
            view.ui.add(legend, "bottom-left");
            view.ui.remove(basemapGallery, "bottom-left");
            view.ui.remove(searchWidget, "bottom-left");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
          } else {
            listMenu[3].elm.classList.remove("active-menu");
            view.ui.remove(legend, "bottom-left");
          }
          removeActiveMenu(3);
        };

        // モーダル
        const modal = document.getElementById("modal");

        listMenu[4].elm.onclick = function(){
          if (!listMenu[4].elm.classList.contains("active-menu")) {
            listMenu[4].elm.classList.add("active-menu");
            modal.classList.add("is-active");
            view.ui.remove(legend, "bottom-left");
            view.ui.remove(basemapGallery, "bottom-left");
            view.ui.remove(searchWidget, "bottom-left");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
          } else {
            listMenu[4].elm.classList.remove("active-menu");
            modal.classList.remove("is-active");
          }
          removeActiveMenu(4);
        };

        // 右上の×ボタン
        const closeModal = document.getElementById("closeModal");
        closeModal.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
        };  

        // 閉じるボタン
        const closeModalBtn = document.getElementById("closeModalBtn");
        closeModalBtn.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
        };
        

        // メニューバーの余白をクリックした時
        menuDiv.addEventListener("click", function(event) {
          if (event.path.length <= 6) {
            removeActiveMenu(-9999);
            view.ui.remove(basemapGallery, "bottom-left");
            view.ui.remove(searchWidget, "bottom-left");
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            view.ui.remove(legend, "bottom-left");

            measurement.clear();
            distanceMeasureBtn.classList.remove("active");
            areaMeasureBtn.classList.remove("active");
          }
        });
        
        // 縮尺のリスト
        const listScale = [
          {'text': "- 1:150K"}, 
          {'text': "1:150K - 1:300K"}, 
          {'text': "1:500K"}, 
          {'text': "1:750K - 1:1M"}, 
          {'text': "1:2.5M"}
        ];

        const viewDiv = document.getElementById("viewDiv");

        view.when(function(){

          // 縮尺ボタンを追加
          for (let i in listScale) {
            listScale[i].elm = document.createElement('button');
            listScale[i].elm.className = "esri-button scale-btn-switch";
            listScale[i].elm.setAttribute("scale-id", i);
            if (listScale[i].text === "- 1:150K") {
              listScale[i].elm.disabled = true;
            }
            listScale[i].elm.innerHTML = listScale[i].text;
            viewDiv.parentNode.insertBefore(listScale[i].elm, viewDiv.nextSibling);
            view.ui.add(listScale[i].elm, "top-left");
          }

          

        })

        // 縮尺の切り替え
        document
        .querySelector(".esri-ui-top-left")
        .addEventListener("click", function(event) {
          const id = event.target.getAttribute("scale-id");
          if (id) {
            const nodes = document.querySelectorAll(".scale-btn-switch");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const scaleIndex = node.getAttribute("scale-id");
              if (scaleIndex === id) {
                node.disabled = true;
                if (id === '0') {
                  whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;
                  
                } else if (id === '1') {
                  whereClause = defaultWhereClause + " AND scale_num IN (5,6,7)" ;
                  
                } else if (id === '2') {
                  whereClause = defaultWhereClause + " AND scale_num IN (8)" ;
                  
                } else if (id === '3') {
                  whereClause = defaultWhereClause + " AND scale_num IN (9,10)" ;
                  
                } else if (id === '4') {
                  whereClause = defaultWhereClause + " AND scale_num IN (11)" ;
                  
                };
                zukakuLayerView.filter = {
                  where: whereClause
                };
              } else {
                node.disabled = false;
              }
            }
          }
        });

        

        

        // ローダーの表示を止める
        const loaderDiv = document.getElementById("loaderDiv");
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');

          };
        });


        
      });
    </script>
  </head>

  <body>
    
    <div class="wrapper">

      <div class="js-modal modal-overlay" data-modal="foo" id="modal">
        <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>Modal!</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
          tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
          quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
          consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
          cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
          proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          
          <div class="right">
            <fieldset class="fieldset-checkbox padding-right-2">
              <label><input type="checkbox" id="notShowAgainChk">Don't show this message again.</label>
            </fieldset>
            <button class="btn js-modal-toggle" id="closeModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div id="titleDiv" class="esri-widget">
        <div id="title">
          Gaihozu Viewer
        </div>
      </div>
      
      <div id="viewDiv"></div>

      <div id="toolbarMeasureDiv" class="esri-component esri-widget">
        <button
          id="distanceMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-measure-line"
          title="Distance Measurement Tool"
        ></button>
        <button
          id="areaMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-measure-area"
          title="Area Measurement Tool"
        ></button>
        <button
          id="clearMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-trash"
          title="Clear Measurements"
        ></button>
      </div>

      <div class="loader is-active" id="loaderDiv">
        <div class="loader-bars"></div>
        <!-- <div class="loader-text">Loading...</div> -->
      </div>


      <div id="menuDiv" class="text-center">
        
        <!-- <div class="padding-leader-half padding-trailer-half menu-area" id="infoDiv">
          <div class="esri-icon-description"></div>
          <div class="font-size--2">
            info
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area" id="legendDiv">
          <div class="esri-icon-layer-list"></div>
          <div class="font-size--2">
            legend
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area phone-hide" id="searchDiv">
          <div class="esri-icon-search"></div>
          <div class="font-size--2">
            search
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area" id="basemapDiv">
          <div class="esri-icon-basemap"></div>
          <div class="font-size--2">
            basemap
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area phone-hide" id="measurementDiv">
          <div class="esri-icon-measure"></div>
          <div class="font-size--2">
            measure ment
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area" id="backDiv">
          <div class="esri-icon-close-circled"></div>
          <div class="font-size--2">
            back to index map
          </div>
        </div>
        <div class="padding-leader-half padding-trailer-half menu-area" id="metadataDiv">
          <div class="esri-icon-documentation"></div>
          <div class="font-size--2">
            metadata
          </div>
        </div> -->
        

      </div>

    </div>
  </body>
</html>
