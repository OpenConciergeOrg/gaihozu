<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }
      #panelDiv{        
        width: 332px;
        overflow-y: auto;
      }


      .esri-expand .esri-expand__content {
        box-shadow: none;
      }

      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        z-index: 9999 ;
        position: absolute;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }

      .esri-view-width-less-than-small .esri-zoom .esri-widget--button {
        display: none;
      }

      .svg{
        fill: white;
      }

      .esri-histogram-range-slider {
        background-color: #efefef;
      }
      .esri-histogram__content{
        background-color: #efefef;
      }
      .esri-widget--button{
        background-color: #efefef;
      }
      
      
      .histogram-title{
        background-color: #efefef;
      }
      .esri-widget{
        background-color: #efefef !important;
      }
    </style>
    
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="style.css">
    <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script>
    <!-- interactive patterns need to be initialized -->
    <script>
       calcite.init()
    </script>
    <script src="https://js.arcgis.com/4.14/"></script>
    <script>
      require([
        // "esri/WebMap",
        "esri/views/MapView",
        // "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/HistogramRangeSlider",
        "esri/renderers/smartMapping/statistics/histogram",
        "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel"
      ], function(
        // WebMap, 
        MapView, 
        // Legend, 
        Expand,
        FeatureLayer,
        Map,
        HistogramRangeSlider,
        histogram,
        HistogramRangeSliderVM
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";

        const panelDiv = document.getElementById("panelDiv");
        const scaleSlider = document.getElementById("scaleSlider");
        const yearSlider = document.getElementById("yearSlider");
        const loaderDiv = document.getElementById("loaderDiv");

        const map = new Map({
          basemap: 'streets'
        });

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, 1.0326589312043144],
          zoom: 4,
        });

        // ローダーの表示を止める
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');
          };
        });
        

        // Desktop

        const panelExpand = new Expand({
          view: view,
          content: panelDiv,
          expanded: true
        });
        
        view.when(function(){
          panelDiv.style.height = (view.height - 20) +"px";
        })

        view.watch("height", function(newVal){
          panelDiv.style.height = (newVal - 20) +"px";
        });

        // Load
        isResponsiveSize = view.widthBreakpoint === "xsmall";
        updateView(isResponsiveSize);

        // Breakpoints
        view.watch("widthBreakpoint", function(breakpoint) {
          switch (breakpoint) {
            case "xsmall":
              updateView(true);
              break;
            case "small":
            case "medium":
            case "large":
            case "xlarge":
              updateView(false);
              break;
            default:
          }
        });

        function setLegendMobile(isMobile) {
          var toAdd = isMobile ? panelExpand : panelDiv;
          var toRemove = isMobile ? panelDiv : panelExpand;

          view.ui.remove(toRemove);
          view.ui.add(toAdd, "top-right");
        }

        function updateView(isMobile) {
          setLegendMobile(isMobile);
        }

        

          // ヒストグラム
        let minYear = 1939;
        let maxYear = 1945;
        
        let minScale = 1;
        let maxScale = 12;

        const fieldPrintYear = "print_year_en";
        const fieldScale = "scale_num";

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldPrintYear,
          numBins: 6,
          classificationMethod: "equal-interval",
          minValue: minYear,
          maxValue: maxYear
        }).then(createYearHistogramSlider);

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldScale,
          numBins: 11,
          classificationMethod: "equal-interval",
          minValue: minScale,
          maxValue: maxScale
        }).then(createScaleHistogramSlider);

        function createScaleHistogramSlider (histogramResponse){
          

          
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minScale,
            max: maxScale,
            // steps: 1,
            values: [minScale, maxScale],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: scaleSlider
          });


          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "LargeScale";
            } else if (type === "max"){
              return "SmallScale";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], scaleChanged);

        };

        function createYearHistogramSlider (histogramResponse){
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minYear,
            max: maxYear,
            // steps: 1,
            values: [minYear, maxYear],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: yearSlider
          });

          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "1939";
            } else if (type === "max"){
              return "1945";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], yearChanged);

        };

        function yearChanged(event){
          const year = event.value;
          const index = event.index;
          
          if (index === 0){
            minYear = year;
          } else if (index === 1){
            maxYear = year;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale;
          zukakuLayerView.filter = {
            where: whereClause
          };

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["objectid"];

          zukakuLayerView.queryFeatures(queryParams)
            .then(function(response){
              filteredFeaturesCnt = response.features.length;
              featuresCntDiv.innerHTML = filteredFeaturesCnt;
            })
            .catch(function(error) {
              console.log(error);
            });
        };

        function scaleChanged(event){
          const scale = event.value;
          const index = event.index;
          
          if (index === 0){
            minScale = scale;
          } else if (index === 1){
            maxScale = scale;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale;
          zukakuLayerView.filter = {
            where: whereClause
          };

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["objectid"];

          zukakuLayerView.queryFeatures(queryParams)
            .then(function(response){
              filteredFeaturesCnt = response.features.length;
              featuresCntDiv.innerHTML = filteredFeaturesCnt;
            })
            .catch(function(error) {
              console.log(error);
            });
        };


      });
    </script>
  </head>

  <body>

    <div class="wrapper">
    <div class="js-modal modal-overlay modifier-class" data-modal="foo">
      <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
        <a class="js-modal-toggle right" href="#" aria-label="close-modal">
          <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
        </a>
        <h3 class='trailer-half'>Modal!</h3>
        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
        tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
        quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
        consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
        cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
        proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
        <div class="text-right">
            <button class="btn js-modal-toggle">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
        </div>
      </div>
    </div>

    <div id="viewDiv"></div>

    <div class="loader is-active" id="loaderDiv">
      <div class="loader-bars"></div>
      <!-- <div class="loader-text">Loading...</div> -->
    </div>

    <div class="esri-widget" id="panelDiv">
      <div class="panel-dark-blue modifier-class">
        <h4 class="leader-1 trailer-1 padding-left-1 padding-right-1">
          <a href="index.html" class="text-white">
            Gaihozu Viewer
          </a>
          
          <a class="right svg js-modal-toggle" data-modal="foo">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M16.5 9.5a1 1 0 1 1 1-1 1.002 1.002 0 0 1-1 1zM17 23V12h-2v1h1v10h-1v1h3v-1zm12.8-6.5A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
            <!-- Info -->
          </a>
          <a class="right svg padding-right-1">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M17 21h-1c0-2.959 1.227-3.919 2.371-5.207.916-1.031 1.639-1.846 1.629-3.264C20 10.104 18.08 9 16.167 9 14.16 9 12 10.194 12 12.817h-1a4.523 4.523 0 0 1 1.648-3.628A5.549 5.549 0 0 1 16.168 8C18.637 8 21 9.555 21 12.525a5.598 5.598 0 0 1-1.881 3.932C18.043 17.668 17 18.421 17 21zm.5 3.5a1 1 0 1 0-1 1 1.002 1.002 0 0 0 1-1zm12.3-8A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
          </a>
        </h4>
      </div>
      <div class="padding-leader-1 padding-trailer-1 padding-left-1 padding-right-1">
        <div id="sliderDiv">
          <div id="sliderYearDiv" class="esri-widget">
            <div class="histogram-title">Printed Year</div>
            <div id="yearSlider"></div>
          </div>
          <div id="sliderScaleDiv" class="esri-widget padding-leader-1">
            <div class="histogram-title">Map Scale</div>
            <div id="scaleSlider"></div>
          </div>


          <!-- <div id="featuresCntCard">
            <div class="card-content text-center">
              <div id="featuresCntDiv"></div>
            </div>
          </div> -->
        </div>
        <div id="queryResultsDiv">
        </div>
        <div id="attributeDiv">
        </div>
      </div>
      
    </div>
    </div>
  </body>
</html>
