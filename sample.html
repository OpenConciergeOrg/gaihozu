<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }
      #panelDiv{        
        width: 332px;
        overflow-y: auto;
      }


      .esri-expand .esri-expand__content {
        box-shadow: none;
      }

      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        z-index: 9999 ;
        position: absolute;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }

      .esri-view-width-less-than-small .esri-zoom .esri-widget--button {
        display: none;
      }
    </style>
    
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="style.css">
    <script src="https://js.arcgis.com/4.14/"></script>
    <script>
      require([
        // "esri/WebMap",
        "esri/views/MapView",
        // "esri/widgets/Legend",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/HistogramRangeSlider",
        "esri/renderers/smartMapping/statistics/histogram",
        "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel"
      ], function(
        // WebMap, 
        MapView, 
        // Legend, 
        Expand,
        FeatureLayer,
        Map,
        HistogramRangeSlider,
        histogram,
        HistogramRangeSliderVM
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";

        const panelDiv = document.getElementById("panelDiv");
        const scaleSlider = document.getElementById("scaleSlider");
        const yearSlider = document.getElementById("yearSlider");
        const loaderDiv = document.getElementById("loaderDiv");

        const map = new Map({
          basemap: 'streets'
        });

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, 1.0326589312043144],
          zoom: 4,
        });

        // ローダーの表示を止める
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');
          };
        });
        

        // Desktop

        const panelExpand = new Expand({
          view: view,
          content: panelDiv,
          expanded: true
        });
        // view.ui.add(panelExpand, "top-right");

        view.when(function(){
          panelDiv.style.height = (view.height - 10) +"px";
        })

        view.watch("height", function(newVal){
          panelDiv.style.height = (newVal - 10) +"px";
        });

        // Load
        isResponsiveSize = view.widthBreakpoint === "xsmall";
        updateView(isResponsiveSize);

        // Breakpoints
        view.watch("widthBreakpoint", function(breakpoint) {
          switch (breakpoint) {
            case "xsmall":
              updateView(true);
              break;
            case "small":
            case "medium":
            case "large":
            case "xlarge":
              updateView(false);
              break;
            default:
          }
        });

        function setLegendMobile(isMobile) {
          var toAdd = isMobile ? panelExpand : panelDiv;
          var toRemove = isMobile ? panelDiv : panelExpand;

          view.ui.remove(toRemove);
          view.ui.add(toAdd, "top-right");
        }

        function updateView(isMobile) {
          setLegendMobile(isMobile);
        }

        

          // ヒストグラム
        let minYear = 1939;
        let maxYear = 1945;
        
        let minScale = 1;
        let maxScale = 12;

        const fieldPrintYear = "print_year_en";
        const fieldScale = "scale_num";

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldPrintYear,
          numBins: 6,
          classificationMethod: "equal-interval",
          minValue: minYear,
          maxValue: maxYear
        }).then(createYearHistogramSlider);

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldScale,
          numBins: 11,
          classificationMethod: "equal-interval",
          minValue: minScale,
          maxValue: maxScale
        }).then(createScaleHistogramSlider);

        function createScaleHistogramSlider (histogramResponse){
          

          
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minScale,
            max: maxScale,
            // steps: 1,
            values: [minScale, maxScale],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: scaleSlider
          });


          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "LargeScale";
            } else if (type === "max"){
              return "SmallScale";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], scaleChanged);

        };

        function createYearHistogramSlider (histogramResponse){
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minYear,
            max: maxYear,
            // steps: 1,
            values: [minYear, maxYear],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: yearSlider
          });

          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "1939";
            } else if (type === "max"){
              return "1945";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], yearChanged);

        };

        function yearChanged(event){
          const year = event.value;
          const index = event.index;
          
          if (index === 0){
            minYear = year;
          } else if (index === 1){
            maxYear = year;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale;
          zukakuLayerView.filter = {
            where: whereClause
          };

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["objectid"];

          zukakuLayerView.queryFeatures(queryParams)
            .then(function(response){
              filteredFeaturesCnt = response.features.length;
              featuresCntDiv.innerHTML = filteredFeaturesCnt;
            })
            .catch(function(error) {
              console.log(error);
            });
        };

        function scaleChanged(event){
          const scale = event.value;
          const index = event.index;
          
          if (index === 0){
            minScale = scale;
          } else if (index === 1){
            maxScale = scale;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale;
          zukakuLayerView.filter = {
            where: whereClause
          };

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["objectid"];

          zukakuLayerView.queryFeatures(queryParams)
            .then(function(response){
              filteredFeaturesCnt = response.features.length;
              featuresCntDiv.innerHTML = filteredFeaturesCnt;
            })
            .catch(function(error) {
              console.log(error);
            });
        };


      });
    </script>
  </head>

  <body>

    <div id="viewDiv"></div>

    <div class="loader is-active" id="loaderDiv">
      <div class="loader-bars"></div>
      <!-- <div class="loader-text">Loading...</div> -->
    </div>

    <div class="esri-widget" id="panelDiv">
      <div class="panel-dark-blue modifier-class">
        <h4 class="leader-1 trailer-1 padding-left-1 padding-right-1">
          <a href="index.html" class="text-white">
            Gaihozu Viewer
          </a>
          <a class="text-white right" href="#">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" class="svg-icon"><path d="M31.297 16.047c0 8.428-6.826 15.25-15.25 15.25S.797 24.475.797 16.047c0-8.424 6.826-15.25 15.25-15.25s15.25 6.826 15.25 15.25zM18 24V12h-4v12h-2v2h8v-2h-2zm0-18h-4v4h4V6z"/></svg>
            <!-- Info -->
          </a>
        </h4>
      </div>
      <div class="padding-leader-1 padding-trailer-1 padding-left-1 padding-right-1">
        <div id="sliderDiv">
          <div id="sliderYearDiv" class="esri-widget">
            <div class="histogram-title">Printed Year</div>
            <div id="yearSlider"></div>
          </div>
          <div id="sliderScaleDiv" class="esri-widget padding-leader-1">
            <div class="histogram-title">Map Scale</div>
            <div id="scaleSlider"></div>
          </div>


          <!-- <div id="featuresCntCard">
            <div class="card-content text-center">
              <div id="featuresCntDiv"></div>
            </div>
          </div> -->
        </div>
        <div id="queryResultsDiv">
        </div>
        <div id="attributeDiv">
        </div>
      </div>
      
    </div>
  </body>
</html>
