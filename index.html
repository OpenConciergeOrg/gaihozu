<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }
      #panelDiv{        
        width: 332px;
        overflow-y: auto;
      }
      .esri-expand .esri-expand__content {
        box-shadow: none;
      }
      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        /* z-index: 4999 ; */
        position: absolute !important;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }
      .esri-view-width-less-than-small .esri-zoom .esri-widget--button {
        display: none;
      }
      .svg {
        fill: white;
      }
      .esri-histogram-range-slider,
      .esri-view-width-xsmall .esri-expand--auto .esri-expand__container--expanded,
      .esri-histogram__content,
      .esri-widget--button,
      .histogram-title,
      .esri-widget,
      .esri-input {
        background-color: #efefef !important;
      }
      .alert{
        position: relative;
      }
      .alert-close {
        position: absolute;
        right: 0 !important;
        top: 0 !important;
      }
      #bluepanel{
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 110;
      }
      #toolbarDiv{
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        box-shadow: none;
        margin-bottom: 0px;
      }
      #btnClose {
        background-color: #004575 !important;
        color: white !important;
      }
      .esri-search__container {
        border: solid 1px rgba(110,110,110,0.3);
      }
      a:hover {
        color: #750045 !important;
      }
      .svg:hover {
        fill: #750045 !important;
      }
      .esri-histogram-range-slider .esri-slider--horizontal .esri-slider__max, 
      .esri-histogram-range-slider .esri-slider--horizontal .esri-slider__min {
        pointer-events : none;
      }
      fieldset{
        float: left;
      }
      article, aside, details, figcaption, figure, footer, header, hgroup, nav, section, summary{
        display: revert !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css">
    <!-- <link rel="stylesheet" href="style.css"> -->
    <!-- <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script> -->
    <!-- interactive patterns need to be initialized -->
    <!-- <script>
       calcite.init()
    </script> -->
    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.14/"></script>
    
    <script>
      require([
        "esri/views/MapView",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/HistogramRangeSlider",
        "esri/renderers/smartMapping/statistics/histogram",
        "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel",
        "esri/widgets/Search",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource"
      ], function(
        MapView, 
        Expand,
        FeatureLayer,
        Map,
        HistogramRangeSlider,
        histogram,
        HistogramRangeSliderVM,
        Search,
        GraphicsLayer,
        Graphic,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement,
        BasemapGallery,
        PortalBasemapsSource
      ) {
        
        // const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/gaihozuIndex/FeatureServer/0";
        const queryTxt = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";

        const panelDiv = document.getElementById("panelDiv");
        const scaleSlider = document.getElementById("scaleSlider");
        const yearSlider = document.getElementById("yearSlider");
        const loaderDiv = document.getElementById("loaderDiv");
        const modalsvg = document.getElementById("modalsvg");
        const modal = document.getElementById("modal");
        const closeModal = document.getElementById("closeModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const modalHelp = document.getElementById("modalHelp");
        const closeModalHelp = document.getElementById("closeModalHelp");
        const closeModalHelpBtn = document.getElementById("closeModalHelpBtn");
        const nextModalHelpBtn = document.getElementById("nextModalHelpBtn");
        const backModalHelpBtn = document.getElementById("backModalHelpBtn");
        const sliderScaleDiv = document.getElementById("sliderScaleDiv");
        const helpsvg = document.getElementById("helpsvg");
        const sliderDiv = document.getElementById("sliderDiv");
        const imgInst = document.getElementById("imgInst");
        const txtInst = document.getElementById("txtInst");
        const notShowAgainChk = document.getElementById("notShowAgainChk");

        const strp1_1 = "Click a index to see a map image.";
        const strp1_2 = "Sliding the thumb on the histogram on the right pane filters indexes by printed year or map scale.";
        const strp2 = "Select a card to see map image.";
        const strp3_1 = "Sliding the thumb on the slider on the right pane transparents the map image.";
        const strp3_2 = "Click Back button on the top left corner to go back to index selection map."
        const strp4 = "Please click a index."

        /////////////
        // シンボル //
        /////////////

        // 選択された図郭のシンボル
        const symbolSelectedZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [0, 148, 128, 0.5],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [255, 255, 255, 1],
            width: 2
          }
        };
        // ハイライトされた図郭のシンボル（右側のパネルに２つ以上の図郭があるとき）
        const symbolHighlightedZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [255, 255, 255, 0],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [0, 20, 148, 1],
            width: 2
          }
        };

        const symbolMouseOveredZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [255, 255, 255, 0],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [0, 94, 148, 1],
            width: 2
          }
        };

        ///////////
        // マップ //
        ///////////
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-vector'
        });

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        const graphicsLayerSelectedZukaku = new GraphicsLayer();
        const graphicsLayerHighlightedZukaku = new GraphicsLayer();
        const graphicsLayerMouseOveredZukaku = new GraphicsLayer();

        map.add(graphicsLayerSelectedZukaku);
        map.add(graphicsLayerHighlightedZukaku);
        map.add(graphicsLayerMouseOveredZukaku);

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, 1.0326589312043144],
          zoom: 4
        });

        // ベースマップウィジェット
        const portalSource = new PortalBasemapsSource({  
          query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
        });
              
        // Basemap Gallery Widget     
        const basemapGallery = new BasemapGallery({       
          view: view,     
          container: document.createElement("div"),       
          source: portalSource
        }); 

        const bgExpand = new Expand({
          view: view,
          content: basemapGallery
        });
        view.ui.add(bgExpand, "top-left");

        // ローダーの表示を止める
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');
          };
        });

        /////////////
        // モーダル //
        /////////////

        // info modal
        // 右側のパネルのボタン：押すと開く
        modalsvg.onclick = function(){
          if (!modal.classList.contains("is-active")) {
            modal.classList.add("is-active");
          }
        };

        // 初回は強制的に表示
        if(localStorage.getItem('flgNotShowAgain') === null) {
          modal.classList.add("is-active");
        };

        // 右上の×ボタン
        closeModal.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };  

        // 閉じるボタン
        closeModalBtn.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };

        // how to use modal
        // 右側のパネルのボタン：押すと開く
        helpsvg.onclick = function(){
          if (!modalHelp.classList.contains("is-active")) {
            modalHelp.classList.add("is-active");
          }
        };
        // 右上の×ボタン
        closeModalHelp.onclick = function(){
          if (modalHelp.classList.contains("is-active")) {
            modalHelp.classList.remove("is-active");
          }
        };  
        // 閉じるボタン
        closeModalHelpBtn.onclick = function(){
          if (modalHelp.classList.contains("is-active")) {
            modalHelp.classList.remove("is-active");
          }
        };

        const helpimg1 = "inst1.png";
        const helptxt1 = "This app enables to see over 600 georeferenced Gaihozu, Japanese historical map, in Indonesia overlaid on the present basemap.";
        const helpimg2 = "inst2.png";
        const helptxt2 = "Indexes on the initial display shows the footprints of each Gaihozu. You can filter indexes by sliding the thumb on the histogram on the right pane. Click an index which you are interested in.";
        const helpimg3 = "inst3.png";
        const helptxt3 = "When clicking a point which more than one index are located , corresponded indexes are shown on the right panel. Click a thumbnail which you want to see.";
        const helpimg4 = "inst4.png";
        const helptxt4 = "You can compare Gaihozu with a present map by changing the transparency of Gaihozu using the slider on the right panel.";

        const arrayHelp = [
          [helpimg1, helptxt1],
          [helpimg2, helptxt2],
          [helpimg3, helptxt3],
          [helpimg4, helptxt4]
        ];
        let incrementHelp = 0;

        nextModalHelpBtn.onclick =  function(){
          if (incrementHelp <= 2){
            incrementHelp += 1;
          } else if (incrementHelp === 3){
            incrementHelp = 0;
          };
          
          imgInst.src = "img/" + arrayHelp[incrementHelp][0];
          txtInst.innerHTML = arrayHelp[incrementHelp][1];
        }

        backModalHelpBtn.onclick =  function(){
          if (incrementHelp >= 1){
            incrementHelp -= 1;
          } else if (incrementHelp === 0){
            incrementHelp = 3;
          };
          
          imgInst.src = "img/" + arrayHelp[incrementHelp][0];
          txtInst.innerHTML = arrayHelp[incrementHelp][1];
        }

        // 検索ウィジェット
        const sources = [{
          layer: zukakuFeatureLayer,
          searchFields: ["id"],
          displayField: "id",
          exactMatch: false,
          outFields: ["*"],
          name: "Search by ID",
          placeholder: "example: TH008053",
          maxResults: 6,
          maxSuggestions: 6,
          suggestionsEnabled: true,
          minSuggestCharacters: 0
        }];

        let searchDiv;
        let searchTitleDiv;
        function addSearchWidget(elm){

          searchTitleDiv = document.createElement('div');
          searchTitleDiv.className = "trailer-half leader-half histogram-title";
          elm.parentNode.insertBefore(searchTitleDiv, elm.nextSibling);
          searchTitleDiv.innerHTML = "Search";

          searchDiv = document.createElement('div');
          searchDiv.className = "trailer-1 text-center";
          searchTitleDiv.parentNode.insertBefore(searchDiv, searchTitleDiv.nextSibling); 

          const searchWidget = new Search({
            view: view,
            sources: sources,
            container: searchDiv
          });
        };
        
        // const searchWidgetNoSources = new Search({
        //   view: view
        // });

        // 右側のパネル
        const panelExpand = new Expand({
          view: view,
          content: panelDiv,
          expanded: true
        });

        // let closeAlert;
        let useP1;
        let useP2;

        function removeAlertRed(){
          if (useDiv.classList.contains("alert-red")) {
            useDiv.classList.remove("alert-red");
          } 
        };
        

        view.constraints = {
          rotationEnabled: false  // Disables map rotation
        };
        
        view.when(function(){
          const useDiv = document.createElement('div');
          useDiv.setAttribute("id", "useDiv");
          useDiv.className = "alert is-active";
          
           
          useP1 = document.createElement('div');
          useP1.className = "padding-right-1";
          useDiv.appendChild(useP1);

          useP2 = document.createElement('div');
          useP2.className = "padding-right-1";
          useDiv.appendChild(useP2);

          const closeAlert = document.createElement('button');
          closeAlert.className = "alert-close right";
          closeAlert.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>';
          useDiv.appendChild(closeAlert);

          view.ui.add(useDiv, "bottom-left",0);
          useP1.innerHTML = strp1_1;
          useP2.innerHTML = strp1_2;


          // アラートを閉じる
          closeAlert.onclick = function() {
            useDiv.classList.remove("is-active");
          };

          // パネルの高さ
          panelDiv.style.height = (view.height - 20) +"px";

          addSearchWidget(sliderDiv);
          addMeasure(sliderDiv);
          
        })

        // パネルの高さ
        view.watch("height", function(newVal){
          panelDiv.style.height = (newVal - 20) +"px";
        });

        // Load
        isResponsiveSize = view.widthBreakpoint === "xsmall";
        updateView(isResponsiveSize);

        // Breakpoints
        view.watch("widthBreakpoint", function(breakpoint) {
          switch (breakpoint) {
            case "xsmall":
              updateView(true);
              break;
            case "small":
            case "medium":
            case "large":
            case "xlarge":
              updateView(false);
              break;
            default:
          }
        });

        function setLegendMobile(isMobile) {
          var toAdd = isMobile ? panelExpand : panelDiv;
          var toRemove = isMobile ? panelDiv : panelExpand;

          view.ui.remove(toRemove);
          view.ui.add(toAdd, "top-right");
        }

        function updateView(isMobile) {
          setLegendMobile(isMobile);
        }

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let whereClause = defaultWhereClause;

        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {

          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // ポインターが重なった時
          view.on('pointer-move', function(evt){
            if (view.map === map) {
              queryFeaturesMouseOvered(evt);
            };
          });

          // クリック時
          // ベースマップギャラリーを開いているときは、クリック時に閉じる（図郭選択処理をしない）
          view.on("click", function(event) {
            if (bgExpand.expanded === true){
              bgExpand.expanded = false;
            } else if(view.map === map){
              clearMap();
              queryFeaturesClickedPoint(event);
            } else {
              return;
            };
            
          });

        });

          // ヒストグラム
        let minYear = 1939;
        let maxYear = 1945;
        
        let minScale = 1;
        let maxScale = 12;

        const fieldPrintYear = "print_year_en";
        const fieldScale = "scale_num";

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldPrintYear,
          numBins: 6,
          classificationMethod: "equal-interval",
          minValue: minYear,
          maxValue: maxYear
        }).then(createYearHistogramSlider);

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldScale,
          numBins: 11,
          classificationMethod: "equal-interval",
          minValue: minScale,
          maxValue: maxScale
        }).then(createScaleHistogramSlider);

        function createScaleHistogramSlider (histogramResponse){

          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minScale,
            max: maxScale,
            // steps: 1,
            values: [minScale, maxScale],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: scaleSlider
          });


          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "1: 25,000";
            } else if (type === "max"){
              return "1: 2,500,000";
            } else if (value >= 1 && value < 2){
              return "1: 25,000";
            } else if (value >= 2 && value < 3){
              return "1: 50,000";
            } else if (value >= 3 && value < 4){
              return "1: 100,000";
            } else if (value >= 4 && value < 5){
              return "1: 150,000";
            } else if (value >= 5 && value < 6){
              return "1: 200,000";
            } else if (value >= 6 && value < 7){
              return "1: 250,000";
            } else if (value >= 7 && value < 8){
              return "1: 300,000";
            } else if (value >= 8 && value < 9){
              return "1: 500,000";
            } else if (value >= 9 && value < 10){
              return "1: 750,000";
            } else if (value >= 10 && value < 11){
              return "1: 1,000,000";
            } else if (value >= 11 && value < 12){
              return "1: 2,500,000";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], scaleChanged);

        };

        function createYearHistogramSlider (histogramResponse){
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minYear,
            max: maxYear,
            // steps: 1,
            values: [minYear, maxYear],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: yearSlider
          });

          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "1939";
            } else if (type === "max"){
              return "1945";
            } else if (value >= 1939 && value < 1940){
              return "1939";
            } else if (value >= 1940 && value < 1941){
              return "1940";
            } else if (value >= 1941 && value < 1942){
              return "1941";
            } else if (value >= 1942 && value < 1943){
              return "1942";
            } else if (value >= 1943 && value < 1944){
              return "1943";
            } else if (value >= 1944 && value < 1945){
              return "1944";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], yearChanged);

        };

        function yearChanged(event){
          const year = event.value;
          const index = event.index;
          
          if (index === 0){
            minYear = year;
          } else if (index === 1){
            maxYear = year;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale + " AND " + defaultWhereClause;
          zukakuLayerView.filter = {
            where: whereClause
          };

        };

        function scaleChanged(event){
          const scale = event.value;
          const index = event.index;
          
          if (index === 0){
            minScale = scale;
          } else if (index === 1){
            maxScale = scale;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale + " AND " + defaultWhereClause;
          zukakuLayerView.filter = {
            where: whereClause
          };

        };

        function clearMap() {
          graphicsLayerHighlightedZukaku.removeAll();
          graphicsLayerSelectedZukaku.removeAll();
          queryResultsDiv.innerHTML = "";
          sliderDiv.style.display = 'block';
          attributeDiv.innerHTML = "";
        };

        ///////////////////////////////////
        // 図郭検索マップ（マウスオーバー） //
        ///////////////////////////////////
        

        function queryFeaturesMouseOvered(evt){
          const pointermove = view.toMap({x: evt.x, y: evt.y});
          graphicsLayerMouseOveredZukaku.removeAll();
          
          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = pointermove;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["Shape__Area"];
          queryParams.orderByFields = ["Shape__Area DESC"];

          zukakuLayerView.queryFeatures(queryParams)
          .then(addGraphicsMouseOveredFeatures)
          .catch(function(error) {
            console.log(error);
          });

        };

        function addGraphicsMouseOveredFeatures (response){
          const featuresQuery = response.features;
          const length = featuresQuery.length;
          // フィーチャがない場所にマウスオーバーした時
          if (length === 0){
            return;
          } else {
            featuresQuery.forEach(function(featureQuery) {

              addZukakuGraphics(featureQuery, graphicsLayerMouseOveredZukaku, symbolMouseOveredZukaku);

            });
          };
        };

        function addZukakuGraphics(feature, graphicsLayer, symbol){
          // 取得したフィーチャをグラフィックスに追加
          const graphicSelectedZukaku = new Graphic({  // graphic with point geometry
            geometry: feature.geometry, // set geometry here
            symbol: symbol // set symbol here
          });
          graphicsLayer.add(graphicSelectedZukaku);
        };

        //////////////////////////////
        // 図郭検索マップ（クリック） //
        //////////////////////////////

        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          // 計測ウィジェットがアクティブでないときのみ
          if (view.map === map && !measurement.activeWidget){
            zukakuLayerView.queryFeatures(queryParams)
            .then(addGraphicsAndAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };
          
        };

        function expandPanel(){
          if (panelExpand.expanded === false) {
            panelExpand.expanded = true;
          }
        };

        function addGraphicsAndAttribute(response){
          const featuresQuery = response.features;
          
          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            
            useP1.innerHTML = strp4;
            useP2.innerHTML = "";
            useDiv.classList.add("alert-red");

            clearMap();

          // 図郭が１つの場合はすぐに外邦図を表示する
          } else if (length === 1) {

            graphicsLayerMouseOveredZukaku.removeAll();
            graphicsLayerSelectedZukaku.removeAll();

            searchDiv.style.display = 'none';
            searchTitleDiv.style.display = 'none';

            createMap(response);
            addZukakuGraphics(featuresQuery[0], graphicsLayerSelectedZukaku, symbolSelectedZukaku);
            addZukakuAttribute(response);

            expandPanel();

          // 図郭が２つ以上の場合はどの外邦図を表示するか選択する必要がある
          } else {

            sliderDiv.style.display = 'none';
            searchDiv.style.display = 'none';
            searchTitleDiv.style.display = 'none';

            // if (view.map === map && (view.width > 545 && view.height > 545)){
              measurementP.style.display = 'none';
              toolbarDiv.style.display = 'none';
              measurementWidgetDiv.style.display = 'none';
            // }
            

            attributeDiv.innerHTML = "";
            queryResultsDiv.innerHTML = "";

            graphicsLayerMouseOveredZukaku.removeAll();

            removeAlertRed();
            useP1.innerHTML = strp2;
            useP2.innerHTML = "";

            expandPanel();

            featuresQuery.forEach(function(featureQuery) {

              addZukakuGraphics(featureQuery, graphicsLayerSelectedZukaku, symbolSelectedZukaku);
              addSelectedZukakuAttribute(featureQuery);

            });
          };
        };

        //////////////////////////////////////////////
        // 取得したフィーチャの情報を右側のパネルに追加 //
        //////////////////////////////////////////////
        function addSelectedZukakuAttribute(feature){

          const id = feature.attributes.id;

          portal.load().then(function() {
            
            const queryParams = {
              query: queryTxt + id,
              sortField: "numViews",
              sortOrder: "desc",
              num: 20
            };
            // Query the items based on the queryParams created from portal above
            portal.queryItems(queryParams).then(createGallery);
          });

          function createGallery(response){

            const thumbnailUrl = response.results[0].thumbnailUrl;

            const cardBlock = document.createElement("div");
            cardBlock.classList.add("card");
            cardBlock.classList.add("block");
            cardBlock.classList.add("trailer-1");
            cardBlock.setAttribute("data-result-id",id);
            queryResultsDiv.appendChild(cardBlock);

            const cardImageWrap = document.createElement("figure");
            cardImageWrap.classList.add("card-image-wrap");
            cardImageWrap.setAttribute("data-result-id",id);
            cardBlock.appendChild(cardImageWrap);

            const cardImage = document.createElement("img");
            cardImage.classList.add("card-image");
            cardImage.setAttribute("data-result-id",id);
            cardImage.src = thumbnailUrl;
            cardImageWrap.appendChild(cardImage);

            const cardImageCaption = document.createElement("figcaption");
            cardImageCaption.classList.add("card-image-caption");
            cardImageCaption.setAttribute("data-result-id",id);
            const area3_en = feature.attributes.area3_en;
            const title = feature.attributes.title;
            
            if (area3_en){
              cardImageCaption.innerHTML = area3_en;
            } else {
              cardImageCaption.innerHTML = title;
              
            };
            cardImageWrap.appendChild(cardImageCaption);
            
            

            const cardContent = document.createElement("div");
            cardContent.classList.add("card-content");
            cardContent.setAttribute("data-result-id",id);
            cardBlock.appendChild(cardContent);

            const cardContentYear = document.createElement("p");
            cardContentYear.classList.add("font-size--1");
            cardContentYear.classList.add("card-last");
            cardContentYear.setAttribute("data-result-id",id);
            cardContentYear.innerHTML = "Printed Year: " + feature.attributes.print_year_en;
            cardContent.appendChild(cardContentYear);

            const cardContentScale = document.createElement("p");
            cardContentScale.classList.add("font-size--1");
            cardContentScale.classList.add("card-last");
            cardContentScale.setAttribute("data-result-id",id);
            cardContentScale.innerHTML = "Scale: " + feature.attributes.scale;
            cardContent.appendChild(cardContentScale);

          };
        };

        ///////////////////////////////////////////
        // 図郭検索マップ（カードにマウスオーバー） //
        ///////////////////////////////////////////
        // マウスオーバーしたカードに対応したマップ上の図郭の枠をグラフィックでハイライト
        queryResultsDiv.addEventListener("mouseover", executeQueryObjectIds);

        function executeQueryObjectIds(event){

          const attLength = event.target.attributes.length;
          if (attLength === 1){
            return;
          };

          const nodeValue = event.target.attributes[1].nodeValue;
          
          graphicsLayerHighlightedZukaku.removeAll();
          graphicsLayerMouseOveredZukaku.removeAll();

          

          const queryParams = zukakuLayerView.filter.createQuery();
          // set a geometry for querying features by the view's extent
          queryParams.returnGeometry = true;
          queryParams.outFields = ["OBJECTID"];
          queryParams.where = "id = '" + nodeValue + "'";

          // query the layer with the modified params object
          zukakuLayerView.queryFeatures(queryParams)
            .then(highlightHoverFeature)
            .catch(function(error) {
              console.log(error);
            });
        }

        function highlightHoverFeature (response) {
          const feature = response.features[0];
          const graphicHighlightedZukaku = new Graphic({  // graphic with point geometry
            geometry: feature.geometry, // set geometry here
            symbol: symbolHighlightedZukaku // set symbol here
          });
          graphicsLayerHighlightedZukaku.add(graphicHighlightedZukaku);

          // グラフィックスが描画された後に発火
          // articleから瞬時にマップにカーソルをあわせたときにもグラフィックが消えるように
          view.whenLayerView(graphicsLayerHighlightedZukaku).then(function(layerView) {
            // 地図にマウスオーバーしたとき、図郭枠のグラフィックを削除
            view.on("pointer-enter", function(value) {
              graphicsLayerHighlightedZukaku.removeAll();
            });
          });
        };

        // マップの中心とズームレベルを取得、外邦図から図郭検索地図に戻る際に使用
        watchUtils.whenTrue(view, "stationary", function() {
          if (view.map === map) {
            if (view.extent) {
              viewZoom = view.zoom;
              viewCenter = view.center;
            };
          };   
        });

        //////////////////////////////////
        // 右側のパネルのカードを選択したとき//
        //////////////////////////////////
        queryResultsDiv.addEventListener("click", onListClickHandler);

        // 該当の外邦図をマップに追加
        function onListClickHandler(event) {       

          queryResultsDiv.innerHTML = "";

          
          // article要素からIDを取得する
          const paths = event.path;

          let id = event.target.dataset.resultId;

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];
          queryParams.where = "id = '" + id + "'";

          // query the layer with the modified params object
          zukakuLayerView.queryFeatures(queryParams)
            .then(createMap)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
        };

        //////////////////////
        // 外邦図閲覧マップ //
        //////////////////////

        let mapSecond;
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;
        let measurementWidgetDiv;
        let measurementP;
        let tranparencySlider;
        let btnClose;
        let gridDiv;
        let toolbarDiv;
        let measurement;
        let selectZukakuDiv;
        const defaultTransparency = 75;

        function getGeoreferenceFlg(id, attId, classIcon){
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["georeference"];
          queryParams.where = "id = '" + id + "'";
          console.log(id);

          zukakuFeatureLayer.queryFeatures(queryParams)
            .then(function(response){
              if (response.features.length > 0){
                const feature = response.features[0];
                console.log(feature);
                const georeferenceflg = feature.attributes.georeference;
                if (georeferenceflg === 1) {
                  const arrowBtn = document.createElement('button');
                  arrowBtn.setAttribute("id", attId);
                  arrowBtn.setAttribute("data-id", id);
                  arrowBtn.className = "esri-widget--button esri-interactive " + classIcon;
                  selectZukakuDiv.appendChild(arrowBtn);
                }
              }
              
            })
            .catch(function(error) {
              console.log(error);
            });
        }

        function createMap(response){

          sliderDiv.style.display = 'none';
          loaderDiv.classList.add("is-active");

          const feature = response.features[0];

          const id = feature.attributes.id;
          northId = feature.attributes.north;
          southId = feature.attributes.south;
          westId = feature.attributes.west;
          eastId = feature.attributes.east;
          // georeferenceflg = feature.attributes.georeference;

          portal.load().then(function() {
            var queryParams = {
              query: queryTxt + id,
              sortField: "numViews",
              sortOrder: "desc",
              num: 20
            };
            // Query the items based on the queryParams created from portal above
            portal.queryItems(queryParams).then(addTileLayer);
          });
          return response;
        };

        function addTileLayer(response){
          
          const itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });
          
          
          mapSecond = new Map({
            basemap: map.basemap
          });

          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);
          tileLayer.opacity = defaultTransparency/100;

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          esriRequest(tileLayerUrl, options)
            .then(createTileView)
        };

        function addMeasure(elm){
          // 計測ウィジェット
          // if (view.width > 545 && view.height > 545){

            if (document.getElementById("measurementP")) {
              document.getElementById("measurementP").parentNode.removeChild(document.getElementById("measurementP"));
            };
            if (document.getElementById("toolbarDiv")) {
              document.getElementById("toolbarDiv").parentNode.removeChild(document.getElementById("toolbarDiv"));
            };

            measurementP = document.createElement('div');
            measurementP.setAttribute("id", "measurementP");
            measurementP.className = ("histogram-title padding-trailer-half");
            measurementP.innerHTML = "Measurement";
            elm.parentNode.insertBefore(measurementP, elm.nextSibling);

            toolbarDiv = document.createElement('div');
            toolbarDiv.setAttribute("id", "toolbarDiv");
            toolbarDiv.className = "esri-component esri-widget padding-trailer-half";
            measurementP.parentNode.insertBefore(toolbarDiv, measurementP.nextSibling);

            const distanceBtn = document.createElement('button');
            distanceBtn.setAttribute("id", "distance");
            distanceBtn.className = "esri-widget--button esri-interactive esri-icon-measure-line";
            toolbarDiv.appendChild(distanceBtn);

            const areaBtn = document.createElement('button');
            areaBtn.setAttribute("id", "area");
            areaBtn.className = "esri-widget--button esri-interactive esri-icon-measure-area";
            toolbarDiv.appendChild(areaBtn);

            const clearBtn = document.createElement('button');
            clearBtn.setAttribute("id", "clear");
            clearBtn.className = "esri-widget--button esri-interactive esri-icon-trash";
            toolbarDiv.appendChild(clearBtn);

            measurementWidgetDiv = document.createElement("div");
            toolbarDiv.parentNode.insertBefore(measurementWidgetDiv, toolbarDiv.nextSibling);

            measurement = new Measurement({
              view: view,
              container: measurementWidgetDiv
            });

            

            distanceBtn.addEventListener("click", function() {
              distanceMeasurement();
            });
            areaBtn.addEventListener("click", function() {
              areaMeasurement();
            });
            clearBtn.addEventListener("click", function() {
              clearMeasurements();
            });

            function distanceMeasurement() {
              measurement.activeTool = "distance";
              distanceBtn.classList.add("active");
              areaBtn.classList.remove("active");
            };

            function areaMeasurement() {
              measurement.activeTool = "area";
              distanceBtn.classList.remove("active");
              areaBtn.classList.add("active");
            };

            function clearMeasurements() {
              distanceBtn.classList.remove("active");
              areaBtn.classList.remove("active");
              measurement.clear();
            };
          // };
        }

        function createTileView(response){

          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          tileLayer.when(function() {
            view.goTo(tileLayer.fullExtent);
          });

          view.map = mapSecond;
          view.constraints = {minZoom: minLOD, maxZoom: maxLOD};

          useP1.innerHTML = strp3_1;
          useP2.innerHTML = strp3_2;
          removeAlertRed();
          
          // 透過率スライダー
          if (document.getElementById("sliderTransparencyDiv")) {
            document.getElementById("sliderTransparencyDiv").parentNode.removeChild(document.getElementById("sliderTransparencyDiv"));
          };
          const sliderTransparencyDiv = document.createElement('div');
          sliderTransparencyDiv.className = "esri-widget";
          sliderTransparencyDiv.setAttribute("id","sliderTransparencyDiv");
          sliderTransparencyDiv.classList.add("padding-trailer-1");
          sliderTransparencyDiv.innerHTML = '<div class="histogram-title padding-trailer-1">Opacity</div><div id="tranparencySlider" class="slider"></div>';

          measurementP.parentNode.insertBefore(sliderTransparencyDiv, measurementP);
          
          
          tranparencySlider = new Slider({
            container: "tranparencySlider",
            min: 0,
            max: 100,
            values: [defaultTransparency],
            steps: 5,
            snapOnClickEnabled: false,
            labelsVisible: true,
            rangeLabelsVisible: true
          });

          tranparencySlider.on(
            ["thumb-change", "thumb-drag"],
            transparencyChanged
          );

          function transparencyChanged(event) {
            var value = event.value;
            tileLayer.opacity = value/100;
          };
          

          // 図郭選択
          if (document.getElementById("selectZukakuDiv")) {
            document.getElementById("selectZukakuDiv").parentNode.removeChild(document.getElementById("selectZukakuDiv"));
          };

          selectZukakuDiv = document.createElement('div');
          selectZukakuDiv.setAttribute("id", "selectZukakuDiv");
          selectZukakuDiv.className = "esri-component esri-widget";
          panelDiv.parentNode.insertBefore(selectZukakuDiv, panelDiv);

          // 隣接図郭のサービスはあがっているとは限らない
          getGeoreferenceFlg(northId, "upArrow", "esri-icon-up-arrow");
          getGeoreferenceFlg(southId, "downArrow", "esri-icon-down-arrow");
          getGeoreferenceFlg(westId, "leftArrow", "esri-icon-left-triangle-arrow");
          getGeoreferenceFlg(eastId, "rightArrow", "esri-icon-right-triangle-arrow");
          
          selectZukakuDiv.addEventListener("click", showNextImage);

          function showNextImage(event){

            const id = event.target.dataset.id;
            
            const queryParams = zukakuFeatureLayer.createQuery();
            // set a geometry for querying features by the view's extent
            queryParams.returnGeometry = true;
            queryParams.outFields = ["*"];
            queryParams.where = "id = '" + id + "'";

            zukakuFeatureLayer.queryFeatures(queryParams)
            .then(addGraphicsAndAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };
          
          // 戻るボタン
          if (document.getElementById("gridDiv")) {
            document.getElementById("gridDiv").parentNode.removeChild(document.getElementById("gridDiv"));
          };

          gridDiv = document.createElement("div");
          gridDiv.setAttribute("id", "gridDiv");
          gridDiv.className = "esri-widget";
          panelDiv.parentNode.insertBefore(gridDiv, panelDiv);
          
          btnClose = document.createElement("button");
          btnClose.setAttribute("id", "btnClose");
          btnClose.className = ("esri-widget--button esri-widget esri-interactive");
          btnClose.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" class="svg-icon"><path d="M10.07 12L20.072 2H13L0 15l13 13h7.07l-10-10H32v-6z"/></svg>';
          gridDiv.appendChild(btnClose);

          view.ui.add(gridDiv, "top-left", 0);
          view.ui.move("zoom", "top-left", 1);
          view.ui.move(bgExpand, "top-left", 3);
          
          view.ui.add([
            {component: selectZukakuDiv,
             position: "top-left",
             index: 2
            }
          ]);

          if (measurementP.style.display === 'none'){
            measurementP.style.display = 'block';
          }
          if (toolbarDiv.style.display === 'none'){
            toolbarDiv.style.display = 'flex';
          }
          if (measurementWidgetDiv.style.display === 'none'){
            measurementWidgetDiv.style.display = 'block';
          }

          view.watch('updating', function(evt){
            if(!evt){
              loaderDiv.classList.remove('is-active');
            };
          });

          clickCloseBtn();

        };

        const arrayAtt = [
          {"title": "記号", "att": "area3"},
          {"title": "図幅名", "att": "area_name"},
          {"title": "測量機関", "att": "surveyed_by"},
          {"title": "測量時期（修正含む）", "att": "survey_year"},
          {"title": "製版・印刷機関", "att": "printed_by"},
          {"title": "製版時期", "att": "print_year"},
          {"title": "発行時期", "att": "publish_year"},
          {"title": "大きさ", "att": "size"},
          {"title": "色", "att": "color"},
          {"title": "備考", "att": "notes"},
          {"title": "枚数（実物）", "att": "copies"}
        ];

        function addZukakuAttribute(response){
          const feature = response.features[0];
          attributeDiv.innerHTML = "";

          const hr = document.createElement("hr");
          hr.setAttribute("id", "atthr");
          hr.classList = ("trailer-half leader-0");
          attributeDiv.appendChild(hr);

          // const divMaptitle = document.createElement("div");
          // divMaptitle.innerHTML = "MAP TITLE";
          // divMaptitle.style.color = "gray";
          // attributeDiv.appendChild(divMaptitle);

          const divArea3_en = document.createElement("div");
          const attArea3_en = feature.attributes.area3_en;
          divArea3_en.classList.add("padding-leader-half");
          divArea3_en.innerHTML = attArea3_en;
          attributeDiv.appendChild(divArea3_en);

          const divTitle = document.createElement("div");
          const attTitle = feature.attributes.title;
          divTitle.innerHTML = attTitle;
          attributeDiv.appendChild(divTitle);

          const divScale = document.createElement("div");
          const attScale = feature.attributes.scale;
          divScale.classList.add("padding-leader-1");
          divScale.innerHTML = attScale;
          attributeDiv.appendChild(divScale);

          const divPrintedYear = document.createElement("div");
          const attPrintedYear = feature.attributes.print_year_en;
          divPrintedYear.classList.add("padding-leader-1");
          divPrintedYear.innerHTML = "Printed in " + attPrintedYear;
          attributeDiv.appendChild(divPrintedYear);

          const divSize = document.createElement("div");
          const attSize = feature.attributes.height_width;
          divSize.classList.add("padding-leader-1");
          divSize.innerHTML = attSize + " (cm)";
          if (attSize !== "-"){
            attributeDiv.appendChild(divSize);
          }

          const divId = document.createElement("div");
          const attId = feature.attributes.id;
          divId.classList.add("padding-leader-1");
          divId.innerHTML = attId;
          attributeDiv.appendChild(divId);
          

          const details = document.createElement("details");
          details.classList.add("padding-leader-1");
          attributeDiv.appendChild(details);

          const summary = document.createElement("summary");
          summary.innerHTML = "Details in Japanese";
          details.appendChild(summary);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            const attribute = document.createElement("div");
            attribute.classList.add("leader-1");
            details.appendChild(attribute);
            
            const title = document.createElement("div");
            attribute.appendChild(title);
            title.style.color = "gray";
            title.innerHTML = arrayAtt[i]["title"];

            const value = document.createElement("div");
            attribute.appendChild(value);
            
            value.innerHTML = attValue;
            

          };

        };

        //////////////////////////////////////////
        // Closeボタンを押すと外邦図検索画面に戻る //
        //////////////////////////////////////////

        function clickCloseBtn (){
          
          btnClose.onclick = function() {

            if (document.getElementById("gridDiv")) {
              document.getElementById("gridDiv").parentNode.removeChild(document.getElementById("gridDiv"));
            };
            if (document.getElementById("sliderTransparencyDiv")) {
              document.getElementById("sliderTransparencyDiv").parentNode.removeChild(document.getElementById("sliderTransparencyDiv"));
            };
            if (document.getElementById("selectZukakuDiv")) {
              document.getElementById("selectZukakuDiv").parentNode.removeChild(document.getElementById("selectZukakuDiv"));
            };


            loaderDiv.classList.add('is-active');

            graphicsLayerHighlightedZukaku.removeAll();

            if (document.getElementById("atthr")) {
              document.getElementById("atthr").parentNode.removeChild(document.getElementById("atthr"));
            };



            view.map = map;
            // 外邦図閲覧画面のマップの背景図をセットする
            map.basemap = mapSecond.basemap;

            view.ui.remove(gridDiv);
            view.ui.remove(selectZukakuDiv);

            useP1.innerHTML = strp1_1;
            useP2.innerHTML = strp1_2;

            view.constraints = {minZoom: 0, maxZoom: 23};
            
            view.watch('updating', function(evt){
              if(!evt){
                loaderDiv.classList.remove('is-active');
              };
            });

            view.on("layerview-create", function(event) {
              // The event contains the layer and its layer view that has just been
              // created. Here we check for the creation of a layer view for a layer with
              // a specific id, and log the layer view
              if (event.layer.title === "図郭") {
                // The LayerView for the desired layer
                zukakuLayerView = event.layerView;
                zukakuLayerView.filter = {
                  where: whereClause
                };
              };
            });

            watchUtils.whenOnce(view, "ready")
            .then(function(){
              view.goTo({
                target: viewCenter,
                zoom: viewZoom
              });
            });

            queryResultsDiv.innerHTML = "";
            sliderDiv.style.display = 'block';
            attributeDiv.innerHTML = "";
            searchDiv.style.display = 'block';
            searchTitleDiv.style.display = 'block';

            measurementP.style.display = 'block';
            toolbarDiv.style.display = 'flex';


            var selectedZukaku = graphicsLayerSelectedZukaku.graphics.items;

          };
        };

      });
    </script>
  </head>

  <body>

    <div class="wrapper">
      <div class="js-modal modal-overlay" data-modal="foo" id="modal">
        <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>Modal!</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
          tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
          quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
          consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
          cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
          proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          
          <div class="right">
            <fieldset class="fieldset-checkbox padding-right-2">
              <label><input type="checkbox" id="notShowAgainChk">Don't show this message again.</label>
            </fieldset>
            <button class="btn js-modal-toggle" id="closeModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div class="js-modal modal-overlay" data-modal="foo" id="modalHelp">
        <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeModalHelp">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <!-- <h3 class='trailer-half'>Modal!</h3> -->

          <div class="card block trailer-1">
            <figure class="card-image-wrap">
              <img id="imgInst" class="card-image" src="img/inst1.png" alt="">
              <!-- <figcaption class="card-image-caption">
                Florida, January 1954
              </figcaption> -->
            </figure>
            <div class="card-content">
              <!-- <h4><a href="#">Card with Image</a></h4> -->
              <p id="txtInst" class="font-size--1 card-last">This app enables to see over 600 georeferenced Gaihozu in Indonesia, Japanese historical map, overlaid on the present basemap.</p>
            </div>
          </div>

          <div class="text-right">
            <button class="btn btn-clear js-modal-toggle" id="nextModalHelpBtn">Next</button>
            <button class="btn btn-clear js-modal-toggle" id="backModalHelpBtn">Back</button>
            <button class="btn js-modal-toggle" id="closeModalHelpBtn">Close</button>
            
          </div>
        </div>
      </div>

      <div id="viewDiv"></div>

      <div class="loader is-active" id="loaderDiv">
        <div class="loader-bars"></div>
        <!-- <div class="loader-text">Loading...</div> -->
      </div>

      <div class="esri-widget" id="panelDiv">
        <div class="panel-dark-blue" id="bluepanel">
          <h4 class="leader-1 trailer-1 padding-left-1 padding-right-1">
            <a href="index.html" class="text-white">
              Gaihozu Viewer
            </a>
            
            <a class="js-modal-toggle right svg" href="#" data-modal="foo" id="modalsvg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M16.5 9.5a1 1 0 1 1 1-1 1.002 1.002 0 0 1-1 1zM17 23V12h-2v1h1v10h-1v1h3v-1zm12.8-6.5A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
              <!-- Info -->
            </a>
            <a class="right svg padding-right-half" href="#" id="helpsvg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M17 21h-1c0-2.959 1.227-3.919 2.371-5.207.916-1.031 1.639-1.846 1.629-3.264C20 10.104 18.08 9 16.167 9 14.16 9 12 10.194 12 12.817h-1a4.523 4.523 0 0 1 1.648-3.628A5.549 5.549 0 0 1 16.168 8C18.637 8 21 9.555 21 12.525a5.598 5.598 0 0 1-1.881 3.932C18.043 17.668 17 18.421 17 21zm.5 3.5a1 1 0 1 0-1 1 1.002 1.002 0 0 0 1-1zm12.3-8A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
            </a>
          </h4>
        </div>
        <div class="padding-leader-1 padding-trailer-1 padding-left-1 padding-right-1">
          <div id="sliderDiv">
            <div id="sliderYearDiv" class="esri-widget">
              <div class="histogram-title">Printed Year</div>
              <div id="yearSlider"></div>
            </div>
            <div id="sliderScaleDiv" class="esri-widget padding-leader-1 padding-trailer-1">
              <div class="histogram-title">Map Scale</div>
              <div id="scaleSlider"></div>
            </div>
          </div>
          <div id="queryResultsDiv">
          </div>
          <div id="attributeDiv">
          </div>
        </div>
        
      </div>
    </div>
  </body>
</html>
