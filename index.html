<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        position: absolute;
      }
      #panelDiv{        
        width: 332px;
        overflow-y: auto;
      }
      .esri-expand .esri-expand__content {
        box-shadow: none;
      }
      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        z-index: 9999 ;
        position: absolute !important;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }
      .esri-view-width-less-than-small .esri-zoom .esri-widget--button {
        display: none;
      }
      .svg {
        fill: white;
      }
      .esri-histogram-range-slider,
      .esri-view-width-xsmall .esri-expand--auto .esri-expand__container--expanded,
      .esri-histogram__content,
      .esri-widget--button,
      .histogram-title,
      .esri-widget,
      .esri-input {
        background-color: #efefef !important;
      }
      .alert{
        position: relative;
      }
      .alert-close {
        position: absolute;
        right: 0 !important;
        top: 0 !important;
      }
      #bluepanel{
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 110;
      }
      #toolbarDiv{
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        box-shadow: none;
        margin-bottom: 0px;
      }
      #btnClose {
        background-color: #004575 !important;
        color: white !important;
      }
      .esri-search__container {
        border: solid 1px rgba(110,110,110,0.3);
      }
      a:hover {
        color: #750045 !important;
      }
      .svg:hover {
        fill: #750045 !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.14/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="style.css">
    <!-- <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script> -->
    <!-- interactive patterns need to be initialized -->
    <!-- <script>
       calcite.init()
    </script> -->
    <script src="https://js.arcgis.com/4.14/"></script>
    <script>
      require([
        "esri/views/MapView",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/HistogramRangeSlider",
        "esri/renderers/smartMapping/statistics/histogram",
        "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel",
        "esri/widgets/Search",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement"
      ], function(
        MapView, 
        Expand,
        FeatureLayer,
        Map,
        HistogramRangeSlider,
        histogram,
        HistogramRangeSliderVM,
        Search,
        GraphicsLayer,
        Graphic,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const queryTxt = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";

        const panelDiv = document.getElementById("panelDiv");
        const scaleSlider = document.getElementById("scaleSlider");
        const yearSlider = document.getElementById("yearSlider");
        const loaderDiv = document.getElementById("loaderDiv");
        const modalsvg = document.getElementById("modalsvg");
        const modal = document.getElementById("modal");
        const closeModal = document.getElementById("closeModal");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const sliderScaleDiv = document.getElementById("sliderScaleDiv");
        const helpsvg = document.getElementById("helpsvg");

        const strp1_1 = "Click a index to see a map image.";
        const strp1_2 = "Sliding the thumb on the histogram on the right pane filters indexes by printed year or map scale.";
        const strp2 = "Select a card to see map image.";
        const strp3_1 = "Sliding the thumb on the slider on the right pane transparents the map image.";
        const strp3_2 = "Click Back button on the top left corner to go back to index selection map."
        const strp4 = "Please click a index."

        /////////////
        // シンボル //
        /////////////

        // 選択された図郭のシンボル
        const symbolSelectedZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [0, 148, 128, 0.5],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [255, 255, 255, 1],
            width: 2
          }
        };
        // ハイライトされた図郭のシンボル（右側のパネルに２つ以上の図郭があるとき）
        const symbolHighlightedZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [255, 255, 255, 0],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [0, 20, 148, 1],
            width: 2
          }
        };

        const symbolMouseOveredZukaku = {
          type: "simple-fill", // autocasts as new SimpleFillSymbol()
          color: [255, 255, 255, 0],
          outline: {
            // autocasts as new SimpleLineSymbol()
            color: [0, 94, 148, 1],
            width: 2
          }
        };

        ///////////
        // マップ //
        ///////////
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-vector'
        });

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        const graphicsLayerSelectedZukaku = new GraphicsLayer();
        const graphicsLayerHighlightedZukaku = new GraphicsLayer();
        const graphicsLayerMouseOveredZukaku = new GraphicsLayer();

        map.add(graphicsLayerSelectedZukaku);
        map.add(graphicsLayerHighlightedZukaku);
        map.add(graphicsLayerMouseOveredZukaku);

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, 1.0326589312043144],
          zoom: 4
        });

        // ローダーの表示を止める
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');
          };
        });
        
        // モーダル
        modalsvg.onclick = function(){
          if (!modal.classList.contains("is-active")) {
            modal.classList.add("is-active");
          }
        };

        closeModal.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
          }
        };  

        closeModalBtn.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
          }
        };

        // 検索ウィジェット
        const sources = [{
          layer: zukakuFeatureLayer,
          searchFields: ["id"],
          displayField: "id",
          exactMatch: false,
          outFields: ["*"],
          name: "Search by ID",
          placeholder: "example: TH008053",
          maxResults: 6,
          maxSuggestions: 6,
          suggestionsEnabled: true,
          minSuggestCharacters: 0
        }];

        let searchDiv;
        function addSearchWidget(){
          searchDiv = document.createElement('div');
          searchDiv.className = "trailer-1 text-center";
          sliderScaleDiv.parentNode.insertBefore(searchDiv, sliderScaleDiv.nextSibling); 

          const searchWidget = new Search({
            view: view,
            sources: sources,
            container: searchDiv
          });
        };
        
        addSearchWidget();

        const searchWidgetNoSources = new Search({
          view: view
        });

        // 右側のパネル
        const panelExpand = new Expand({
          view: view,
          content: panelDiv,
          expanded: true
        });

        let closeAlert;
        let useP1;
        let useP2;

        function removeAlertRed(){
          if (useDiv.classList.contains("alert-red")) {
            useDiv.classList.remove("alert-red");
          } 
        };
        

        view.constraints = {
          rotationEnabled: false  // Disables map rotation
        };
        
        view.when(function(){
          const useDiv = document.createElement('div');
          useDiv.setAttribute("id", "useDiv");
          useDiv.className = "alert is-active";
          
           
          useP1 = document.createElement('div');
          useP1.className = "padding-right-1";
          useDiv.appendChild(useP1);

          useP2 = document.createElement('div');
          useP2.className = "padding-right-1";
          useDiv.appendChild(useP2);

          closeAlert = document.createElement('button');
          closeAlert.className = "alert-close right";
          closeAlert.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>';
          useDiv.appendChild(closeAlert);

          view.ui.add(useDiv, "bottom-left",0);
          useP1.innerHTML = strp1_1;
          useP2.innerHTML = strp1_2;

          // 左下のヘルプ
          helpsvg.onclick = function(){
            if (!useDiv.classList.contains("is-active")) {
              useDiv.classList.add("is-active");
            } else {
              useDiv.classList.remove("is-active");
            }
          };

          // アラートを閉じる
          closeAlert.onclick = function() {
            useDiv.classList.remove("is-active");
          };

          // パネルの高さ
          panelDiv.style.height = (view.height - 20) +"px";
        })

        // パネルの高さ
        view.watch("height", function(newVal){
          panelDiv.style.height = (newVal - 20) +"px";
        });

        // Load
        isResponsiveSize = view.widthBreakpoint === "xsmall";
        updateView(isResponsiveSize);

        // Breakpoints
        view.watch("widthBreakpoint", function(breakpoint) {
          switch (breakpoint) {
            case "xsmall":
              updateView(true);
              break;
            case "small":
            case "medium":
            case "large":
            case "xlarge":
              updateView(false);
              break;
            default:
          }
        });

        function setLegendMobile(isMobile) {
          var toAdd = isMobile ? panelExpand : panelDiv;
          var toRemove = isMobile ? panelDiv : panelExpand;

          view.ui.remove(toRemove);
          view.ui.add(toAdd, "top-right");
        }

        function updateView(isMobile) {
          setLegendMobile(isMobile);
        }

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let whereClause = defaultWhereClause;

        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {

          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // ポインターが重なった時
          view.on('pointer-move', function(evt){
            if (view.map === map) {
              queryFeaturesMouseOvered(evt);
            };
          });

          // クリック時
          view.on("click", function(event) {
            if (view.map === map){
              clearMap();
              queryFeaturesClickedPoint(event);
            } else {
              return;
            };
            
          });

        });

          // ヒストグラム
        let minYear = 1939;
        let maxYear = 1945;
        
        let minScale = 1;
        let maxScale = 12;

        const fieldPrintYear = "print_year_en";
        const fieldScale = "scale_num";

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldPrintYear,
          numBins: 6,
          classificationMethod: "equal-interval",
          minValue: minYear,
          maxValue: maxYear
        }).then(createYearHistogramSlider);

        histogram({
          layer: zukakuFeatureLayer,
          field: fieldScale,
          numBins: 11,
          classificationMethod: "equal-interval",
          minValue: minScale,
          maxValue: maxScale
        }).then(createScaleHistogramSlider);

        function createScaleHistogramSlider (histogramResponse){
          

          
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minScale,
            max: maxScale,
            // steps: 1,
            values: [minScale, maxScale],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: scaleSlider
          });


          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "LargeScale";
            } else if (type === "max"){
              return "SmallScale";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], scaleChanged);

        };

        function createYearHistogramSlider (histogramResponse){
          const slider = new HistogramRangeSlider({
            bins: histogramResponse.bins,
            min: minYear,
            max: maxYear,
            // steps: 1,
            values: [minYear, maxYear],
            excludedBarColor: "#524e4e",
            rangeType: "between",
            container: yearSlider
          });

          // ラベルを変更する
          const viewModel = slider.viewModel;
          viewModel.labelFormatFunction = function(value, type) {
            if (type === "min"){
              return "1939";
            } else if (type === "max"){
              return "1945";
            };
          };

          slider.on(["thumb-change", "thumb-drag", "segment-drag"], yearChanged);

        };

        function yearChanged(event){
          const year = event.value;
          const index = event.index;
          
          if (index === 0){
            minYear = year;
          } else if (index === 1){
            maxYear = year;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale + " AND " + defaultWhereClause;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // const queryParams = zukakuLayerView.filter.createQuery();
          // queryParams.returnGeometry = false;
          // queryParams.outFields = ["objectid"];

          // zukakuLayerView.queryFeatures(queryParams)
          //   .then(function(response){
          //     filteredFeaturesCnt = response.features.length;
          //     featuresCntDiv.innerHTML = filteredFeaturesCnt;
          //   })
          //   .catch(function(error) {
          //     console.log(error);
          //   });
        };

        function scaleChanged(event){
          const scale = event.value;
          const index = event.index;
          
          if (index === 0){
            minScale = scale;
          } else if (index === 1){
            maxScale = scale;
          };
          whereClause = fieldPrintYear + ">= " + minYear + " AND " + fieldPrintYear + " <= " + maxYear + " AND " + fieldScale + " >= " + minScale + " AND " + fieldScale + " <= " + maxScale + " AND " + defaultWhereClause;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // const queryParams = zukakuLayerView.filter.createQuery();
          // queryParams.returnGeometry = false;
          // queryParams.outFields = ["objectid"];

          // zukakuLayerView.queryFeatures(queryParams)
          //   .then(function(response){
          //     filteredFeaturesCnt = response.features.length;
          //     featuresCntDiv.innerHTML = filteredFeaturesCnt;
          //   })
          //   .catch(function(error) {
          //     console.log(error);
          //   });
        };

        function clearMap() {
          graphicsLayerHighlightedZukaku.removeAll();
          graphicsLayerSelectedZukaku.removeAll();
          queryResultsDiv.innerHTML = "";
          sliderDiv.style.display = 'block';
          attributeDiv.innerHTML = "";
        };

        ///////////////////////////////////
        // 図郭検索マップ（マウスオーバー） //
        ///////////////////////////////////
        

        function queryFeaturesMouseOvered(evt){
          const pointermove = view.toMap({x: evt.x, y: evt.y});
          graphicsLayerMouseOveredZukaku.removeAll();
          
          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = pointermove;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["Shape__Area"];
          queryParams.orderByFields = ["Shape__Area DESC"];

          zukakuLayerView.queryFeatures(queryParams)
          .then(addGraphicsMouseOveredFeatures)
          .catch(function(error) {
            console.log(error);
          });

        };

        function addGraphicsMouseOveredFeatures (response){
          const featuresQuery = response.features;
          const length = featuresQuery.length;
          // フィーチャがない場所にマウスオーバーした時
          if (length === 0){
            return;
          } else {
            featuresQuery.forEach(function(featureQuery) {

              addZukakuGraphics(featureQuery, graphicsLayerMouseOveredZukaku, symbolMouseOveredZukaku);

            });
          };
        };

        function addZukakuGraphics(feature, graphicsLayer, symbol){
          // 取得したフィーチャをグラフィックスに追加
          const graphicSelectedZukaku = new Graphic({  // graphic with point geometry
            geometry: feature.geometry, // set geometry here
            symbol: symbol // set symbol here
          });
          graphicsLayer.add(graphicSelectedZukaku);
        };

        //////////////////////////////
        // 図郭検索マップ（クリック） //
        //////////////////////////////

        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          if (view.map === map){
            zukakuLayerView.queryFeatures(queryParams)
            .then(addGraphicsAndAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

        };


        let featuresQuery;

        function expandPanel(){
          if (panelExpand.expanded === false) {
            panelExpand.expanded = true;
          }
        };

        function addGraphicsAndAttribute(response){
          featuresQuery = response.features;
          // console.log(featuresQuery);
          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            // showAlert();
            
            useP1.innerHTML = strp4;
            useP2.innerHTML = "";
            useDiv.classList.add("alert-red");
            // if (useDiv.classList.contains("alert")) {
            //   useDiv.classList.add("alert-red");
            // } 

            clearMap();

          // 図郭が１つの場合はすぐに外邦図を表示する
          } else if (length === 1) {

            graphicsLayerMouseOveredZukaku.removeAll();
            graphicsLayerSelectedZukaku.removeAll();

            createMap(response);
            addZukakuGraphics(featuresQuery[0], graphicsLayerSelectedZukaku, symbolSelectedZukaku);
            addZukakuAttribute(response);

            expandPanel();

          // 図郭が２つ以上の場合はどの外邦図を表示するか選択する必要がある
          } else {

            sliderDiv.style.display = 'none';

            attributeDiv.innerHTML = "";
            queryResultsDiv.innerHTML = "";

            graphicsLayerMouseOveredZukaku.removeAll();

            removeAlertRed();
            useP1.innerHTML = strp2;
            useP2.innerHTML = "";

            expandPanel();

            featuresQuery.forEach(function(featureQuery) {

              addZukakuGraphics(featureQuery, graphicsLayerSelectedZukaku, symbolSelectedZukaku);
              addSelectedZukakuAttribute(featureQuery);

            });
          };
        };

        //////////////////////////////////////////////
        // 取得したフィーチャの情報を右側のパネルに追加 //
        //////////////////////////////////////////////
        function addSelectedZukakuAttribute(feature){

          const id = feature.attributes.id;

          portal.load().then(function() {
            
            const queryParams = {
              query: queryTxt + id,
              sortField: "numViews",
              sortOrder: "desc",
              num: 20
            };
            // Query the items based on the queryParams created from portal above
            portal.queryItems(queryParams).then(createGallery);
          });

          function createGallery(response){

            const thumbnailUrl = response.results[0].thumbnailUrl;

            const cardBlock = document.createElement("div");
            cardBlock.classList.add("card");
            cardBlock.classList.add("block");
            cardBlock.classList.add("trailer-1");
            cardBlock.setAttribute("data-result-id",id);
            queryResultsDiv.appendChild(cardBlock);

            const cardImageWrap = document.createElement("figure");
            cardImageWrap.classList.add("card-image-wrap");
            cardImageWrap.setAttribute("data-result-id",id);
            cardBlock.appendChild(cardImageWrap);

            const cardImage = document.createElement("img");
            cardImage.classList.add("card-image");
            cardImage.setAttribute("data-result-id",id);
            cardImage.src = thumbnailUrl;
            cardImageWrap.appendChild(cardImage);

            const cardImageCaption = document.createElement("figcaption");
            cardImageCaption.classList.add("card-image-caption");
            cardImageCaption.setAttribute("data-result-id",id);
            cardImageCaption.innerHTML = feature.attributes.title;
            cardImageWrap.appendChild(cardImageCaption);

            const cardContent = document.createElement("div");
            cardContent.classList.add("card-content");
            cardContent.setAttribute("data-result-id",id);
            cardBlock.appendChild(cardContent);

            const cardContentYear = document.createElement("p");
            cardContentYear.classList.add("font-size--1");
            cardContentYear.classList.add("card-last");
            cardContentYear.setAttribute("data-result-id",id);
            cardContentYear.innerHTML = "Printed Year: " + feature.attributes.print_year_en;
            cardContent.appendChild(cardContentYear);

            const cardContentScale = document.createElement("p");
            cardContentScale.classList.add("font-size--1");
            cardContentScale.classList.add("card-last");
            cardContentScale.setAttribute("data-result-id",id);
            cardContentScale.innerHTML = "Scale: " + feature.attributes.scale;
            cardContent.appendChild(cardContentScale);

          };
        };

        ///////////////////////////////////////////
        // 図郭検索マップ（カードにマウスオーバー） //
        ///////////////////////////////////////////
        // マウスオーバーしたカードに対応したマップ上の図郭の枠をグラフィックでハイライト
        queryResultsDiv.addEventListener("mouseover", executeQueryObjectIds);

        function executeQueryObjectIds(event){

          const attLength = event.target.attributes.length;
          if (attLength === 1){
            return;
          };

          const nodeValue = event.target.attributes[1].nodeValue;
          
          graphicsLayerHighlightedZukaku.removeAll();
          graphicsLayerMouseOveredZukaku.removeAll();

          

          const queryParams = zukakuLayerView.filter.createQuery();
          // set a geometry for querying features by the view's extent
          queryParams.returnGeometry = true;
          queryParams.outFields = ["OBJECTID"];
          queryParams.where = "id = '" + nodeValue + "'";

          // query the layer with the modified params object
          zukakuLayerView.queryFeatures(queryParams)
            .then(highlightHoverFeature)
            .catch(function(error) {
              console.log(error);
            });
        }

        function highlightHoverFeature (response) {
          const feature = response.features[0];
          const graphicHighlightedZukaku = new Graphic({  // graphic with point geometry
            geometry: feature.geometry, // set geometry here
            symbol: symbolHighlightedZukaku // set symbol here
          });
          graphicsLayerHighlightedZukaku.add(graphicHighlightedZukaku);

          // グラフィックスが描画された後に発火
          // articleから瞬時にマップにカーソルをあわせたときにもグラフィックが消えるように
          view.whenLayerView(graphicsLayerHighlightedZukaku).then(function(layerView) {
            // 地図にマウスオーバーしたとき、図郭枠のグラフィックを削除
            view.on("pointer-enter", function(value) {
              graphicsLayerHighlightedZukaku.removeAll();
            });
          });
        };

        // マップの中心とズームレベルを取得、外邦図から図郭検索地図に戻る際に使用
        watchUtils.whenTrue(view, "stationary", function() {
          // console.log(view);
          if (view.map === map) {
            if (view.extent) {
              viewZoom = view.zoom;
              viewCenter = view.center;
            };
          };   
        });

        //////////////////////////////////
        // 右側のパネルのカードを選択したとき//
        //////////////////////////////////
        queryResultsDiv.addEventListener("click", onListClickHandler);

        // 該当の外邦図をマップに追加
        function onListClickHandler(event) {       

          queryResultsDiv.innerHTML = "";

          
          // article要素からIDを取得する
          const paths = event.path;

          let id = event.target.dataset.resultId;

          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];
          queryParams.where = "id = '" + id + "'";

          // query the layer with the modified params object
          zukakuLayerView.queryFeatures(queryParams)
            .then(createMap)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
        };

        //////////////////////
        // 外邦図閲覧マップ //
        //////////////////////

        let mapSecond;
        let viewSecond;
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;
        let measurementWidgetDiv;
        let measurementP;
        let tranparencySlider;
        let btnClose;
        let gridDiv;
        let toolbarDiv;
        let distanceBtn;
        let areaBtn;
        let clearBtn;
        // let measurement;
        let selectZukakuDiv;

        function createMap(response){

          sliderDiv.style.display = 'none';
          loaderDiv.classList.add("is-active");

          const feature = response.features[0];

          const id = feature.attributes.id;
          northId = feature.attributes.north;
          southId = feature.attributes.south;
          westId = feature.attributes.west;
          eastId = feature.attributes.east;

          portal.load().then(function() {
            var queryParams = {
              query: queryTxt + id,
              sortField: "numViews",
              sortOrder: "desc",
              num: 20
            };
            // Query the items based on the queryParams created from portal above
            portal.queryItems(queryParams).then(addTileLayer);
          });
          return response;
        };

        function addTileLayer(response){
          
          const itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });
          
          mapSecond = new Map({
            basemap: 'topo'
          });

          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          esriRequest(tileLayerUrl, options)
            .then(createTileView)
        };

        

        function createTileView(response){

          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          tileLayer.when(function() {
            view.goTo(tileLayer.fullExtent);
          });

          view.map = mapSecond;
          view.constraints = {minZoom: minLOD, maxZoom: maxLOD};

          useP1.innerHTML = strp3_1;
          useP2.innerHTML = strp3_2;
          removeAlertRed();
          
          // 透過率スライダー
          if (document.getElementById("sliderTransparencyDiv")) {
            document.getElementById("sliderTransparencyDiv").parentNode.removeChild(document.getElementById("sliderTransparencyDiv"));
          };
          const sliderTransparencyDiv = document.createElement('div');
          sliderTransparencyDiv.className = "esri-widget";
          sliderTransparencyDiv.setAttribute("id","sliderTransparencyDiv");
          sliderTransparencyDiv.classList.add("padding-trailer-1");
          sliderTransparencyDiv.innerHTML = '<div class="histogram-title padding-trailer-1">Transparency</div><div id="tranparencySlider" class="slider"></div>';

          queryResultsDiv.parentNode.insertBefore(sliderTransparencyDiv, queryResultsDiv);
          
          
          tranparencySlider = new Slider({
            container: "tranparencySlider",
            min: 0,
            max: 100,
            values: [100],
            steps: 5,
            snapOnClickEnabled: false,
            labelsVisible: true,
            rangeLabelsVisible: true
          });

          tranparencySlider.on(
            ["thumb-change", "thumb-drag"],
            transparencyChanged
          );

          function transparencyChanged(event) {
            var value = event.value;
            tileLayer.opacity = value/100;
            // console.log(tileLayer);
          };
          

          // 図郭選択
          if (document.getElementById("selectZukakuDiv")) {
            document.getElementById("selectZukakuDiv").parentNode.removeChild(document.getElementById("selectZukakuDiv"));
          };

          selectZukakuDiv = document.createElement('div');
          selectZukakuDiv.setAttribute("id", "selectZukakuDiv");
          selectZukakuDiv.className = "esri-component esri-widget";
          panelDiv.parentNode.insertBefore(selectZukakuDiv, panelDiv);

          if (northId) {
            const upArrowBtn = document.createElement('button');
            upArrowBtn.setAttribute("id", "upArrow");
            upArrowBtn.setAttribute("data-id", northId);
            upArrowBtn.className = "esri-widget--button esri-interactive esri-icon-up-arrow";
            selectZukakuDiv.appendChild(upArrowBtn);
          }
          if (southId) {
            const downArrowBtn = document.createElement('button');
            downArrowBtn.setAttribute("id", "downArrow");
            downArrowBtn.setAttribute("data-id", southId);
            downArrowBtn.className = "esri-widget--button esri-interactive esri-icon-down-arrow";
            selectZukakuDiv.appendChild(downArrowBtn);
          }
          
          if (westId) {
            const leftArrowBtn = document.createElement('button');
            leftArrowBtn.setAttribute("id", "leftArrow");
            leftArrowBtn.setAttribute("data-id", westId);
            leftArrowBtn.className = "esri-widget--button esri-interactive esri-icon-left-triangle-arrow";
            selectZukakuDiv.appendChild(leftArrowBtn);
          }
          
          if (eastId) {
            const rightArrowBtn = document.createElement('button');
            rightArrowBtn.setAttribute("id", "rightArrow");
            rightArrowBtn.setAttribute("data-id", eastId);
            rightArrowBtn.className = "esri-widget--button esri-interactive esri-icon-right-triangle-arrow";
            selectZukakuDiv.appendChild(rightArrowBtn);
          }
          
          selectZukakuDiv.addEventListener("click", showNextImage);

          function showNextImage(event){
            // console.log(event);
            // const id = event.path[0].dataset.id;
            const id = event.target.dataset.id;
            
            const queryParams = zukakuFeatureLayer.createQuery();
            // set a geometry for querying features by the view's extent
            queryParams.returnGeometry = true;
            queryParams.outFields = ["*"];
            queryParams.where = "id = '" + id + "'";

            zukakuFeatureLayer.queryFeatures(queryParams)
            .then(addGraphicsAndAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

          
          // view.ui.add(searchWidgetNoSources, "top-right");
          
          // 戻るボタン
          if (document.getElementById("gridDiv")) {
            document.getElementById("gridDiv").parentNode.removeChild(document.getElementById("gridDiv"));
          };

          gridDiv = document.createElement("div");
          gridDiv.setAttribute("id", "gridDiv");
          gridDiv.className = "esri-widget";
          panelDiv.parentNode.insertBefore(gridDiv, panelDiv);
          
          btnClose = document.createElement("button");
          btnClose.setAttribute("id", "btnClose");
          btnClose.className = ("esri-widget--button esri-widget esri-interactive");
          btnClose.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" class="svg-icon"><path d="M10.07 12L20.072 2H13L0 15l13 13h7.07l-10-10H32v-6z"/></svg>';
          gridDiv.appendChild(btnClose);

          view.ui.add(gridDiv, "top-left", 0);
          view.ui.move("zoom", "top-left", 1);
          // view.ui.move(helpDiv, "top-left", 2);
          

          view.ui.add([
            {component: selectZukakuDiv,
             position: "top-left",
             index: 2
            }
          ]);

          // 計測ウィジェット
          if (view.width > 545 && view.height > 545){

            if (document.getElementById("measurementP")) {
              document.getElementById("measurementP").parentNode.removeChild(document.getElementById("measurementP"));
            };
            if (document.getElementById("toolbarDiv")) {
              document.getElementById("toolbarDiv").parentNode.removeChild(document.getElementById("toolbarDiv"));
            };
            
            measurementP = document.createElement('div');
            measurementP.setAttribute("id", "measurementP");
            measurementP.className = ("histogram-title padding-trailer-half");
            measurementP.innerHTML = "Measurement";
            sliderTransparencyDiv.parentNode.insertBefore(measurementP, sliderTransparencyDiv.nextSibling);
            
            toolbarDiv = document.createElement('div');
            toolbarDiv.setAttribute("id", "toolbarDiv");
            toolbarDiv.className = "esri-component esri-widget padding-trailer-half";
            measurementP.parentNode.insertBefore(toolbarDiv, measurementP.nextSibling);
            
            distanceBtn = document.createElement('button');
            distanceBtn.setAttribute("id", "distance");
            distanceBtn.className = "esri-widget--button esri-interactive esri-icon-measure-line";
            toolbarDiv.appendChild(distanceBtn);

            areaBtn = document.createElement('button');
            areaBtn.setAttribute("id", "area");
            areaBtn.className = "esri-widget--button esri-interactive esri-icon-measure-area";
            toolbarDiv.appendChild(areaBtn);

            clearBtn = document.createElement('button');
            clearBtn.setAttribute("id", "clear");
            clearBtn.className = "esri-widget--button esri-interactive esri-icon-trash";
            toolbarDiv.appendChild(clearBtn);

            measurementWidgetDiv = document.createElement("div");
            toolbarDiv.parentNode.insertBefore(measurementWidgetDiv, toolbarDiv.nextSibling);

            const measurement = new Measurement({
              view: view,
              container: measurementWidgetDiv
            });

            distanceBtn.addEventListener("click", function() {
              distanceMeasurement();
            });
            areaBtn.addEventListener("click", function() {
              areaMeasurement();
            });
            clearBtn.addEventListener("click", function() {
              clearMeasurements();
            });

            function distanceMeasurement() {
              measurement.activeTool = "distance";
              distanceBtn.classList.add("active");
              areaBtn.classList.remove("active");
            };

            function areaMeasurement() {
              measurement.activeTool = "area";
              distanceBtn.classList.remove("active");
              areaBtn.classList.add("active");
            };

            function clearMeasurements() {
              distanceBtn.classList.remove("active");
              areaBtn.classList.remove("active");
              measurement.clear();
            };
          };

          
          

          view.watch('updating', function(evt){
            if(!evt){
              loaderDiv.classList.remove('is-active');
            };
          });

          clickCloseBtn();

          

        };

        const arrayAtt = [
          {"title": "TITLE", "att": "title"},
          {"title": "PRINTED IN", "att": "print_year_en"},
          {"title": "SCALE", "att": "scale"},
          {"title": "AREA3", "att": "area3"},
          
          // {"title": "AREA NAME", "att": "area_name"},
          
          {"title": "SURVEYD BY", "att": "surveyed_by"},
          {"title": "SURVEYD IN", "att": "survey_year"},
          {"title": "PRINTED BY", "att": "printed_by"},
          
          {"title": "PUBLISHED IN", "att": "publish_year"},
          {"title": "HEIGHT x WIDTH(cm)", "att": "height_width"},
          // {"title": "WIDTH (cm)", "att": "width"},
          {"title": "COLOR", "att": "color_en"},
          {"title": "ID", "att": "id"}
        ];

        function addZukakuAttribute(response){
          const feature = response.features[0];
          attributeDiv.innerHTML = "";

          const hr = document.createElement("hr");
          hr.setAttribute("id", "atthr");
          hr.classList = ("trailer-half leader-0");
          attributeDiv.appendChild(hr);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            // if (attValue && attValue !== "－") {
              const attribute = document.createElement("div");
              attribute.classList.add("trailer-1");
              attributeDiv.appendChild(attribute);
              
              const title = document.createElement("div");
              attribute.appendChild(title);
              title.style.color = "gray";
              title.innerHTML = arrayAtt[i]["title"];

              const value = document.createElement("div");
              attribute.appendChild(value);
              
              value.innerHTML = attValue;
            // };
            

          };

        };

        //////////////////////////////////////////
        // Closeボタンを押すと外邦図検索画面に戻る //
        //////////////////////////////////////////

        function clickCloseBtn (){
          
          btnClose.onclick = function() {

            if (document.getElementById("gridDiv")) {
              document.getElementById("gridDiv").parentNode.removeChild(document.getElementById("gridDiv"));
            };
            // gridDiv.style.display = "none";
            if (document.getElementById("sliderTransparencyDiv")) {
              document.getElementById("sliderTransparencyDiv").parentNode.removeChild(document.getElementById("sliderTransparencyDiv"));
            };
            if (document.getElementById("selectZukakuDiv")) {
              document.getElementById("selectZukakuDiv").parentNode.removeChild(document.getElementById("selectZukakuDiv"));
            };
            if (document.getElementById("toolbarDiv")) {
              document.getElementById("toolbarDiv").parentNode.removeChild(document.getElementById("toolbarDiv"));
            };


            loaderDiv.classList.add('is-active');

            graphicsLayerHighlightedZukaku.removeAll();

            if (document.getElementById("atthr")) {
              document.getElementById("atthr").parentNode.removeChild(document.getElementById("atthr"));
            };

            if (measurementWidgetDiv) {
              measurementWidgetDiv.parentNode.removeChild(measurementWidgetDiv);
            };

            if (measurementP) {
              measurementP.parentNode.removeChild(measurementP);
            };



            view.map = map;
            view.ui.remove(gridDiv);
            view.ui.remove(selectZukakuDiv);

            useP1.innerHTML = strp1_1;
            useP2.innerHTML = strp1_2;

            view.constraints = {minZoom: 0, maxZoom: 23};
            
            view.watch('updating', function(evt){
              if(!evt){
                loaderDiv.classList.remove('is-active');
              };
            });

            view.on("layerview-create", function(event) {
              // The event contains the layer and its layer view that has just been
              // created. Here we check for the creation of a layer view for a layer with
              // a specific id, and log the layer view
              if (event.layer.title === "図郭") {
                // The LayerView for the desired layer
                zukakuLayerView = event.layerView;
                zukakuLayerView.filter = {
                  where: whereClause
                };
              };
            });

            watchUtils.whenOnce(view, "ready")
            .then(function(){
              view.goTo({
                target: viewCenter,
                zoom: viewZoom
              });
            });

            queryResultsDiv.innerHTML = "";
            sliderDiv.style.display = 'block';
            attributeDiv.innerHTML = "";


            var selectedZukaku = graphicsLayerSelectedZukaku.graphics.items;
            // var point = graphisLayerCenter.graphics.items[0].geometry;
            if (selectedZukaku.length >= 2){
              sliderDiv.style.display = 'none';
              useP1.innerHTML = strp2;
              useP2.innerHTML = "";
              attributeDiv.innerHTML = "";
              featuresQuery.forEach(function(featureQuery) {
                addSelectedZukakuAttribute(featureQuery);
              });
              
            };

          };
        };

      });
    </script>
  </head>

  <body>

    <div class="wrapper">
      <div class="js-modal modal-overlay modifier-class" data-modal="foo" id="modal">
        <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>Modal!</h3>
          <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
          tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
          quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
          consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
          cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
          proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
          <div class="text-right">
            <button class="btn js-modal-toggle" id="closeModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div id="viewDiv"></div>

      <div class="loader is-active" id="loaderDiv">
        <div class="loader-bars"></div>
        <!-- <div class="loader-text">Loading...</div> -->
      </div>

      <div class="esri-widget" id="panelDiv">
        <div class="panel-dark-blue" id="bluepanel">
          <h4 class="leader-1 trailer-1 padding-left-1 padding-right-1">
            <a href="index.html" class="text-white">
              Gaihozu Viewer
            </a>
            
            <a class="js-modal-toggle right svg" href="#" data-modal="foo" id="modalsvg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M16.5 9.5a1 1 0 1 1 1-1 1.002 1.002 0 0 1-1 1zM17 23V12h-2v1h1v10h-1v1h3v-1zm12.8-6.5A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
              <!-- Info -->
            </a>
            <a class="right svg padding-right-half" href="#" id="helpsvg">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path d="M17 21h-1c0-2.959 1.227-3.919 2.371-5.207.916-1.031 1.639-1.846 1.629-3.264C20 10.104 18.08 9 16.167 9 14.16 9 12 10.194 12 12.817h-1a4.523 4.523 0 0 1 1.648-3.628A5.549 5.549 0 0 1 16.168 8C18.637 8 21 9.555 21 12.525a5.598 5.598 0 0 1-1.881 3.932C18.043 17.668 17 18.421 17 21zm.5 3.5a1 1 0 1 0-1 1 1.002 1.002 0 0 0 1-1zm12.3-8A13.3 13.3 0 1 1 16.5 3.2a13.3 13.3 0 0 1 13.3 13.3zm-1 0a12.3 12.3 0 1 0-12.3 12.3 12.314 12.314 0 0 0 12.3-12.3z"/><path fill="none" d="M0 0h32v32H0z"/></svg>
            </a>
          </h4>
        </div>
        <div class="padding-leader-1 padding-trailer-1 padding-left-1 padding-right-1">
          <div id="sliderDiv">
            <div id="sliderYearDiv" class="esri-widget">
              <div class="histogram-title">Printed Year</div>
              <div id="yearSlider"></div>
            </div>
            <div id="sliderScaleDiv" class="esri-widget padding-leader-1 padding-trailer-1">
              <div class="histogram-title">Map Scale</div>
              <div id="scaleSlider"></div>
            </div>


            <!-- <div id="featuresCntCard">
              <div class="card-content text-center">
                <div id="featuresCntDiv"></div>
              </div>
            </div> -->
          </div>
          <div id="queryResultsDiv">
          </div>
          <div id="attributeDiv">
          </div>
        </div>
        
      </div>
    </div>
  </body>
</html>
