<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174938863-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-174938863-1');
    </script>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      #viewDiv {
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        height: 100%;
      }
      #divHeader{
        display: flex;
        position: relative;
        height: 56px;
      }
      #buttonInfo {
        position: absolute;
        right: 60px; 
      }
      #imgTohoku {
        position: absolute;
        right: 0; 
      }
      #headerTitle{
        padding-left: 30px;
      }
      #legendDiv{
        padding: 10px;
      }
      .legendbutton{
        margin-bottom: 10px;
      }
      #loaderDiv{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 9997;
      }
      #loaderBackground {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9998;
        background: rgba(0,0,0,.5);
      }
      #firstModal{
        z-index: 9999;
      }
      @media screen and (max-width:480px) { 
        #subtitle{
         display: none; 
        }
      }
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/dark/main.css"/>
    <link rel="stylesheet" type="text/css" href="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.css" />
    <script type="module" src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.esm.js"></script>
    <script nomodule="" src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.js"></script>

    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.19/"></script>
    <script>
      require([
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/Search",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/AreaMeasurement3D",
        "esri/widgets/DirectLineMeasurement3D",
        "esri/widgets/DistanceMeasurement2D",
        "esri/widgets/AreaMeasurement2D",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
        "dojo/Deferred",
        "dojo/promise/all",
        "esri/views/SceneView",
        "esri/layers/ElevationLayer",
        "esri/layers/BaseElevationLayer",
        "esri/widgets/Home",
        "esri/widgets/Compass",
        "esri/Viewpoint",
        "esri/widgets/LayerList",
        "dojo/domReady!"
      ], function(
        MapView, 
        FeatureLayer,
        Map,
        Search,
        Portal,
        PortalItem,
        esriRequest,
        TileLayer,
        Slider,
        AreaMeasurement3D,
        DirectLineMeasurement3D,
        DistanceMeasurement2D,
        AreaMeasurement2D,
        BasemapGallery,
        PortalBasemapsSource,
        Deferred,
        all,
        SceneView,
        ElevationLayer,
        BaseElevationLayer,
        Home,
        Compass,
        Viewpoint,
        LayerList
      ) {

        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const QUERYTXT = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";
        const PADDINGTOP = 56;
        const MOBILE_WIDTH = 480;


        const actionBar = document.getElementById("actionBar");
        const showAllBtn = document.createElement("calcite-button");
        const primaryPanel = document.getElementById("primaryPanel");

        const windowWidth = document.documentElement.clientWidth;
        const windowHeight = document.documentElement.clientHeight;

        //////////////////////////////////////////////
        //   図郭検索画面
        /////////////////////////////////////////////
        // マップ 
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-relief-vector'
          
        });

        let view = new MapView({
          container: "viewDiv",
          map: map
        });

        view.ui.move("zoom", "top-right");
        let homeBtn2D = new Home({});
        view.ui.add(homeBtn2D, "top-right");

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let scaleWhereclause = " AND scale_num IN (1,2,3,4)";
        let whereClause = defaultWhereClause + scaleWhereclause;
        let yearWhereclause = " AND 1=1";
        let lstYear = ['1939', '1940', '1941', '1942', '1943', '1944'];
        const defaultYear = ['1939', '1940', '1941', '1942', '1943', '1944'];
        let lstFeatureCntByYear;
        let orgLstYear;
        let lenValidYear;
        let startExtent;
        let compassWidget;
        // ビューの中心座標
        let viewCenter;
        // ビューのズームレベル
        let viewZoom;
        // ビューの回転角度
        let viewRotation;

        
        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {
          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };
          
          goToFeatureLayerViewExtent();
          
        });

        // フィーチャレイヤーのエクステントに移動
        function goToFeatureLayerViewExtent () {
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.where = whereClause;
          zukakuFeatureLayer.queryExtent(queryParams).then(function(results){
            startExtent = results.extent;
            view.goTo(startExtent);
            view.extent = startExtent;
            // ホームウィジェットの範囲を設定
            homeBtn2D.view = view;

            compassWidget = new Compass({
              view: view
            });
            view.ui.add(compassWidget, "top-right");
          });
        }

        //////////////////////////////////////////////
        //   Calcite Flow 削除
        /////////////////////////////////////////////

        function deleteCalciteFlow(id){
          if (document.getElementById(id)) {
            document.getElementById(id).remove();
          }
        };

        function deleteAllExistedCalciteFlow(){
          deleteCalciteFlow('legendCalciteFlow');
          deleteCalciteFlow('scaleCalciteFlow');
          deleteCalciteFlow('measurementCalciteFlow');
          deleteCalciteFlow('basemapCalciteFlow');
          deleteCalciteFlow('searchCalciteFlow');
          deleteCalciteFlow("opacityCalciteFlow");
          deleteCalciteFlow("exaggerationCalciteFlow");
          deleteCalciteFlow("adjacentCalciteFlow");
          deleteCalciteFlow("metadataCalciteFlow");
          deleteCalciteFlow("agoCalciteFlow");
          deleteCalciteFlow("copyTileCalciteFlow");
          deleteCalciteFlow("noticeCalciteFlow");
          // deleteCalciteFlow("noticeBackCalciteFlow");
        };

        //////////////////////////////////////////////
        //   Action 表示、非表示
        /////////////////////////////////////////////

        const actionGroup = document.getElementById("actionGroup");

        const backAction = document.getElementById("backAction");
        const imageSettingsAction = document.getElementById("imageSettingsAction");
        const metadataAction = document.getElementById("metadataAction");
        const agoAction = document.getElementById("agoAction");
        const basemapAction = document.getElementById("basemapAction");
        const FilterAction = document.getElementById("filterAction");
        const measurementAction = document.getElementById("measurementAction");
        const searchAction = document.getElementById("searchAction");

        function setDisplayActionItemsFirst(){
          backAction.style.display = "none";
          imageSettingsAction.style.display = "none";
          metadataAction.style.display = "none";
          agoAction.style.display = "none";
          basemapAction.style.display = "block";
          FilterAction.style.display = "block";
          

          if (windowWidth < MOBILE_WIDTH) {
            measurementAction.style.display = "none";
            searchAction.style.display = "none";
          } else {
            measurementAction.style.display = "block";
            searchAction.style.display = "block";
          }
        };
        setDisplayActionItemsFirst();
        
        function setDisplayActionItemsSecond(){
          backAction.style.display = "block";
          imageSettingsAction.style.display = "block";
          metadataAction.style.display = "block";
          basemapAction.style.display = "block";
          FilterAction.style.display = "none";

          if (windowWidth < MOBILE_WIDTH) {
            measurementAction.style.display = "none";
            searchAction.style.display = "none";
            agoAction.style.display = "none";
          } else {
            agoAction.style.display = "block";
            measurementAction.style.display = "block";
            searchAction.style.display = "block";
          }
        };

        // すべてのActionItemのActive状態を解除
        function resetActiveActionItems(){
          backAction.removeAttribute("active");
          imageSettingsAction.removeAttribute("active");
          metadataAction.removeAttribute("active");
          agoAction.removeAttribute("active");
          basemapAction.removeAttribute("active");
          FilterAction.removeAttribute("active");
          measurementAction.removeAttribute("active");
          searchAction.removeAttribute("active");
          // 計測ウィジェットを初期化
          resetMeasureWidget();
        };
        
        function resetMeasureWidget() {
          // 計測ウィジェットを初期化
          if (activeWidget) {
            activeWidget.destroy();
            activeWidget = null;
          }
        };

        //////////////////////////////////////////////
        //   Filter（縮尺）
        /////////////////////////////////////////////

        // 縮尺のリスト
        const listScale = [
          {'text': "- 1:150,000 ()", 'whereClause': 'scale_num IN (1,2,3,4)'}, 
          {'text': "1:200,000 - 1:300,000 ()", 'whereClause': 'scale_num IN (5,6,7)'}, 
          {'text': "1:500,000 ()", 'whereClause': 'scale_num IN (8)'}, 
          {'text': "1:750,000 - 1:1,000,000 ()", 'whereClause': 'scale_num IN (9,10)'}, 
          {'text': "1:2,500,000 ()", 'whereClause': 'scale_num IN (11)'}
        ];

        let scaleId = '0';
        

        // 縮尺ごとのフィーチャ数を取得してボタンの文字列に反映させる
        
        function addCount2BtnTxt() {
          // https://t-salad.com/node-for-asynchronous/
          const tasks = [];
          for (let i=0; i<listScale.length; i++) {
            tasks.push(
              getCountByScale(listScale[i].whereClause)
            );
          };
          Promise.all(tasks).then(function(results){
            
            for (let i = 0; i < results.length; i++) {
              listScale[i].text = listScale[i].text.replace('()', '(' + results[i] + ')');
            }      
            
            view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {
              addScaleButton(scaleId);
            });

          });
        };
        addCount2BtnTxt();
        

        FilterAction.addEventListener("click", function(event) {
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          FilterAction.setAttribute("active", null);

          addCount2BtnTxt();

          collapsePrimaryPanel();
        });

        // 縮尺ごとのフィーチャ数を取得するクエリ
        function getCountByScale(whereClause){
          return new Promise(function(resolve, reject){
            const queryScaleParams = zukakuFeatureLayer.createQuery();
            queryScaleParams.where = defaultWhereClause + " AND " + whereClause;
            zukakuFeatureLayer.queryFeatureCount(queryScaleParams).then(function(result){
              resolve(result);
            });
          });
        };

        // 縮尺ボタンを追加
        function addScaleButton (index) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // Notice
          const noticeCalciteFlow = document.createElement("calcite-flow");
          noticeCalciteFlow.setAttribute('id', 'noticeCalciteFlow');
          primaryPanel.appendChild(noticeCalciteFlow);

          const noticeCalcitePanel = document.createElement("calcite-panel");
          noticeCalciteFlow.appendChild(noticeCalcitePanel);

          const caliciteNotice = document.createElement("calcite-notice");
          caliciteNotice.setAttribute("active", "");
          caliciteNotice.setAttribute("color", "red");
          caliciteNotice.setAttribute("icon", "lightbulb");
          noticeCalcitePanel.appendChild(caliciteNotice);

          const titleDiv = document.createElement("div");
          titleDiv.setAttribute("slot", "notice-title");
          titleDiv.innerHTML = "Click an index to see Gaihozu map image.";
          caliciteNotice.appendChild(titleDiv);
          
          // 縮尺
          const scaleCalciteFlow = document.createElement("calcite-flow");
          scaleCalciteFlow.setAttribute('id', 'scaleCalciteFlow');

          const scaleCalcitePanel = document.createElement("calcite-panel");
          scaleCalcitePanel.setAttribute("heading", "Scale");
          scaleCalciteFlow.appendChild(scaleCalcitePanel);

          const scaleRadioGroup = document.createElement("calcite-radio-group");
          scaleRadioGroup.setAttribute("layout", "vertical");
          scaleRadioGroup.setAttribute("width", "full");
          scaleRadioGroup.setAttribute("scale", "m");

          scaleCalcitePanel.appendChild(scaleRadioGroup);

          for (let i in listScale) {
            listScale[i].elm = document.createElement('calcite-radio-group-item');
            listScale[i].elm.setAttribute("value", i);

            if (i === String(index)) {
              listScale[i].elm.checked = true;
            }

            listScale[i].elm.innerHTML = listScale[i].text;
            scaleRadioGroup.appendChild(listScale[i].elm);
          };
          primaryPanel.appendChild(scaleCalciteFlow);

          queryByAllYears();

          scaleRadioGroup.addEventListener('calciteRadioGroupChange', function(event) {
             selectScaleid(event, true);
          });  
        };

        // 縮尺ボタンクリック時の動作
        function selectScaleid (event, isUpdateLayerList) {
          
          if (!event) {
            return;
          } else {
            scaleId = event.detail;
          }

          if (scaleId === '0') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '1') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '2') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '3') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '4') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          };
                
          whereClause = defaultWhereClause + scaleWhereclause;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // 出版年のリストを初期化
          lstYear = [];
          for (let i=0; i<defaultYear.length; i++) {
            lstYear.push(defaultYear[i]);
          };
          // レイヤーリストウィジェットを更新
          if (isUpdateLayerList == true) {
            queryByAllYears();  
          };
          

        }
       

        //////////////////////////////////////////////
        //   凡例
        /////////////////////////////////////////////
        
        // promise.allで各出版年ごとの結果を受け取る
        function queryByAllYears () {
          // https://t-salad.com/node-for-asynchronous/
          const tasks = [];
          
          // 出版年のリストを初期化
          lstYear = [];
          for (let i=0; i<defaultYear.length; i++) {
            lstYear.push(defaultYear[i]);
          };


          for (let i=0; i<lstYear.length; i++) {
            tasks.push(
              queryByYear(lstYear[i])
            );
          };
          Promise.all(tasks).then(function(results){

            var indices = [];
            var idx = results.indexOf(0);
            while (idx != -1) {
              indices.push(idx);
              idx = results.indexOf(0, idx + 1);
            }
            for (var i = indices.length - 1; i >= 0 ; i--){
              lstYear.splice(indices[i], 1);
            }
            lenValidYear = lstYear.length;
            orgLstYear = [];
            for (let i=0; i<lenValidYear; i++) {
              orgLstYear.push(lstYear[i]);
            };
            lstFeatureCntByYear = results;

            // console.log(results); [0, 24, 0, 42, 423, 33] 出版年ごとのフィーチャ数
            // console.log(indices); [0, 2] フィーチャ数が0のインデックス
            // console.log(lstYear); ["1940", "1942", "1943", "1944"] フィーチャが存在する出版年
            // console.log(lenValidYear); 4 フィーチャが存在する出版年の数、show allボタンの活性化に使用
            // console.log(orgLstYear); ["1940", "1942", "1943", "1944"] show allボタンで戻す際に使用、参照渡しではなく値渡し

            addLegendYear();            
            
          });
        };

        // 出版年ごとにフィーチャ数をクエリ
        function queryByYear (year) {
          return new Promise(function(resolve, reject){
            const queryYearParams = zukakuFeatureLayer.createQuery();
            queryYearParams.where = whereClause + " AND print_year_en IN (" + year + ")";
            zukakuFeatureLayer.queryFeatureCount(queryYearParams).then(function(result){
              resolve(result);
            });
          });
        }
        
        // 出版年のリストからwhere句を作成
        function createYearWhereClause (lst) {
          yearWhereclause = " AND print_year_en IN ("
          for (var i=0; i<lst.length; i++) {
            if (i === 0) {
              yearWhereclause += lst[i];
            } else {
              yearWhereclause += ("," + lst[i]);
            }
          }
          yearWhereclause += ")";
        };
          
        // 凡例を作成
        function addLegendYear () {
          
          // フィーチャレイヤーの個別値を取得
          const uniqueValueInfos = zukakuFeatureLayer.renderer.uniqueValueInfos;

          deleteCalciteFlow('legendCalciteFlow');

          const legendCalciteFlow = document.createElement("calcite-flow");
          legendCalciteFlow.setAttribute('id', 'legendCalciteFlow');
          
          const printedYearCalcitePanel = document.createElement("calcite-panel");
          printedYearCalcitePanel.setAttribute("heading", "Printed Year");
          legendCalciteFlow.appendChild(printedYearCalcitePanel);

          const legendDiv = document.createElement("div");
          legendDiv.setAttribute("id", "legendDiv");
          printedYearCalcitePanel.appendChild(legendDiv);

          // show all ボタン
          showAllBtn.className = "legendbutton";
          showAllBtn.setAttribute("width", "full");
          showAllBtn.setAttribute("disabled", "true");
          showAllBtn.setAttribute("scale", "s");
          showAllBtn.innerHTML = "Show all";
          legendDiv.appendChild(showAllBtn);

          for (var i=0; i<uniqueValueInfos.length; i++) {
            const button = document.createElement("calcite-button");
            button.className = "legendbutton legendYearButton";
            button.setAttribute("width", "full");
            button.setAttribute("scale", "s");
            button.setAttribute("appearance", "outline");
            button.setAttribute("year-id", uniqueValueInfos[i].label);
            
            const buttonStyle = document.createElement("div");
            buttonStyle.style.opacity = 0.51;
            buttonStyle.style.marginRight = "10px";
            button.appendChild(buttonStyle);

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            svg.setAttribute("width", "16");
            svg.setAttribute("height", "16");
            buttonStyle.appendChild(svg);

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttributeNS(null, "transform", "matrix(1.0909091234207153,0,0,1.0909091234207153,12,12)");
            svg.appendChild(g);

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttributeNS(null, "fill", "rgba(" + uniqueValueInfos[i].symbol.color.r + ", " + uniqueValueInfos[i].symbol.color.g + ", " + uniqueValueInfos[i].symbol.color.b + ", " + uniqueValueInfos[i].symbol.color.a + ")");
            path.setAttributeNS(null, "fill-rule", "evenodd");
            path.setAttributeNS(null, "stroke", "rgba(255, 255, 255, 0.25098039215686274)");
            path.setAttributeNS(null, "stroke-width", "2");
            path.setAttributeNS(null, "stroke-linecap", "round");
            path.setAttributeNS(null, "stroke-linejoin", "round");
            path.setAttributeNS(null, "stroke-dasharray", "none");
            path.setAttributeNS(null, "stroke-miterlimit", "4");
            path.setAttributeNS(null, "d", "M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 Z");
            g.appendChild(path);

            const year = document.createElement("div");
            year.innerHTML = uniqueValueInfos[i].label;
            button.appendChild(year);

            legendDiv.appendChild(button);
          }

          primaryPanel.appendChild(legendCalciteFlow);

          showPrintedYearOnLegend();

          // 各出版年ボタンクリック時の動作
          document
          .querySelector("#legendDiv")
          .addEventListener("click", function(event) {
            let target = event.target;
            
            // 対象外の出版年のボタンをクリックしても何もおこらない
            if (target.hasAttribute("id")) {
              return;
            };

            // ボタンのどこをクリックしても動作するようにcalcite-buttonまで移動する
            while (target){
              if (target.nodeName == "CALCITE-BUTTON") {
                break;
              }
              target = target.parentNode;  
            }

            // Show allボタンをクリックしたときも何も起こらない
            if (!target.hasAttribute("year-id")) {
              return;
            };

            if (view.map === map) {
              yearId = target.attributes.getNamedItem('year-id').value;
              selectYearid(yearId);
            }
          });

          // show allボタンクリック時の動作
          showAllBtn.addEventListener("click", function(event) {
            showAllYear();
          });         

        };

        // show allボタンクリック時の動作
        function showAllYear(){

          showAllBtn.setAttribute("disabled", null);
          
          // lstYearをデフォルト値に戻す
          lstYear = [];
          for (let i=0; i<orgLstYear.length; i++) {
            lstYear.push(orgLstYear[i]);
          };

          showPrintedYearOnLegend();

          createYearWhereClause(lstYear);
                
          whereClause = defaultWhereClause + scaleWhereclause + yearWhereclause;
          zukakuLayerView.filter = {
            where: whereClause
          };
        };

        // 出版年のボタンクリック時の動作
        function selectYearid (yearId) {
          if (yearId) {
            const nodes = document.querySelectorAll(".legendYearButton");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const yearIndex = node.getAttribute("year-id");

              if (yearIndex === yearId && !node.hasAttribute('disabled')) {
                if (node.getAttribute("color") === "blue") {
                  node.setAttribute("color", "neutral");
                  // lstYearから該当の出版年を削除
                  const index = lstYear.indexOf(yearId);
                  lstYear.splice(index, 1);
                  
                } else if (node.getAttribute("color") === "neutral") {
                
                  node.setAttribute("color", "blue");
                  // lstYearに該当の出版年を追加
                  lstYear.push(yearId);
                } 
                
              }
            }

            createYearWhereClause(lstYear);
                
            whereClause = defaultWhereClause + scaleWhereclause + yearWhereclause;
            zukakuLayerView.filter = {
              where: whereClause
            };

            setStatusShowAllBtn();
            
          }
        }

        // show allボタンの状態を変える
        function setStatusShowAllBtn () {
          if (lenValidYear !== lstYear.length) {
            showAllBtn.removeAttribute("disabled");
          } else if (lenValidYear === lstYear.length) {
            showAllBtn.setAttribute("disabled", "true");
          };
        }

        // 選択された縮尺に出版年のフィーチャにあるかないかを、ボタンの状態に反映させる
        function showPrintedYearOnLegend () {
          
          const nodes = document.querySelectorAll(".legendYearButton");
          
          for (var idx = 0; idx < nodes.length; idx++) {
          
            const node = nodes[idx];
            const yearIndex = node.getAttribute("year-id");
            
            if (lstFeatureCntByYear[idx] === 0) {
              
              node.setAttribute("disabled", "true");
              node.setAttribute("color", "neutral");

            } else {
              
              node.lastElementChild.innerHTML = yearIndex + " (" + lstFeatureCntByYear[idx] + ")";
              node.removeAttribute("disabled");

              if (lstYear.indexOf(yearIndex) > -1) {
              
                node.setAttribute("color", "blue");
              
              } else {
              
                node.setAttribute("color", "neutral");
              
              }
            }
          };

          endLoading();
        };

        

        //////////////////////////////////////////////
        //   背景
        /////////////////////////////////////////////
        
        let basemapGallery;

        basemapAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          basemapAction.setAttribute("active", null);
          
          const basemapCalciteFlow = document.createElement("calcite-flow");
          basemapCalciteFlow.setAttribute('id', 'basemapCalciteFlow');

          const basemapCalcitePanel = document.createElement("calcite-panel");
          basemapCalcitePanel.setAttribute("heading", "Basemap");
          basemapCalciteFlow.appendChild(basemapCalcitePanel);

          const basemapDiv = document.createElement("div");
          basemapDiv.setAttribute("id", "basemapDiv");
          basemapCalcitePanel.appendChild(basemapDiv);

          const portalSource = new PortalBasemapsSource({  
            query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
          });

          if (view.container) {
            basemapGallery = new BasemapGallery({       
              view: view,     
              container: basemapDiv,       
              source: portalSource
            });
          } else if (sceneView.container) {
            basemapGallery = new BasemapGallery({       
              view: sceneView,     
              container: basemapDiv,       
              source: portalSource
            });
          }

          primaryPanel.appendChild(basemapCalciteFlow);

          collapsePrimaryPanel();

        });

        //////////////////////////////////////////////
        //   計測
        /////////////////////////////////////////////

        let activeWidget = null;

        
        measurementAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          measurementAction.setAttribute("active", null);

          const measurementCalciteFlow = document.createElement("calcite-flow");
          measurementCalciteFlow.setAttribute('id', 'measurementCalciteFlow');

          const measurementCalcitePanel = document.createElement("calcite-panel");
          measurementCalcitePanel.setAttribute("heading", "Measurement");
          measurementCalcitePanel.setAttribute("id", "measurementCalcitePanel");
          measurementCalciteFlow.appendChild(measurementCalcitePanel);

          const measurementRadioGroup = document.createElement("calcite-radio-group");
          measurementRadioGroup.setAttribute("width", "full");
          measurementCalcitePanel.appendChild(measurementRadioGroup);

          const measureDistance = document.createElement("calcite-radio-group-item");
          measureDistance.setAttribute("value", "distance");
          measureDistance.setAttribute("checked", null);
          measureDistance.innerHTML = "Distance";
          measurementRadioGroup.appendChild(measureDistance);
           
          const measureArea = document.createElement("calcite-radio-group-item");
          measureArea.setAttribute("value", "area");
          measureArea.innerHTML = "Area";
          measurementRadioGroup.appendChild(measureArea);

          primaryPanel.appendChild(measurementCalciteFlow);

          if (view.container) {
            setActiveWidget("distance2d");
          } else if (sceneView.container) {
            setActiveWidget("distance3d");
          }

          measureArea.addEventListener("click", function(event) {
            setActiveWidget(null);  
            if (view.container) {
              setActiveWidget("area2d");
            } else if (sceneView.container) {
              setActiveWidget("area3d");
            }
          });

          measureDistance.addEventListener("click", function(event) {
            setActiveWidget(null);
            if (view.container) {
              setActiveWidget("distance2d");
            } else if (sceneView.container) {
              setActiveWidget("distance3d");
            }
          });

          collapsePrimaryPanel();

        });

        function setActiveWidget(type) {

          const measurementCalcitePanel = document.getElementById("measurementCalcitePanel");

          const measurementDiv = document.createElement("div");
          measurementDiv.setAttribute("id", "measurementDiv");
          measurementCalcitePanel.appendChild(measurementDiv);

          switch (type) {
            case "distance2d":
              activeWidget = new DistanceMeasurement2D({
                view: view,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              break;
            case "area2d":
              activeWidget = new AreaMeasurement2D({
                view: view,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              break;
            case "distance3d":
              activeWidget = new DirectLineMeasurement3D({
                view: sceneView,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              break;
            case "area3d":
              activeWidget = new AreaMeasurement3D({
                view: sceneView,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              break;
            case null:
              if (activeWidget) {
                activeWidget.destroy();
                activeWidget = null;
              }
              break;
          }
        };

        //////////////////////////////////////////////
        //   検索
        /////////////////////////////////////////////

        const sources = [{
            layer: zukakuFeatureLayer,
            searchFields: ["id"],
            displayField: "id",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by ID",
            placeholder: "example: TH008053",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3_en", "title"],
            displayField: "area3_en",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by English Metadata",
            placeholder: "example: Blad 76/XXVIII",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3", "area_name"],
            displayField: "area3",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by Japanese Metadata",
            placeholder: "example: ボルネオ1/10万",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }];

        
        searchAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          searchAction.setAttribute("active", null);

          const searchCalciteFlow = document.createElement("calcite-flow");
          searchCalciteFlow.setAttribute('id', 'searchCalciteFlow');

          const searchCalcitePanel = document.createElement("calcite-panel");
          searchCalcitePanel.setAttribute("heading", "Search");
          searchCalcitePanel.setAttribute("id", "searchCalcitePanel");
          searchCalciteFlow.appendChild(searchCalcitePanel);

          primaryPanel.appendChild(searchCalciteFlow);

          const p1 = document.createElement("p");
          p1.style.paddingLeft = "10px";
          p1.style.paddingRight = "10px";
          searchCalcitePanel.appendChild(p1);

          const geocodingDiv = document.createElement("div");
          geocodingDiv.style.height = "500px";
          geocodingDiv.style.display = "table-cell";
          geocodingDiv.style.verticalAlign = "top";
          geocodingDiv.style.background = "#2b2b2b";
          // geocodingDiv.style.background = "white";
          geocodingDiv.style.width = "100%";
          searchCalcitePanel.appendChild(geocodingDiv);

          if (view.map == map && view.container) {
            const geocodingSearchWidget = new Search({
              view: view,
              container: geocodingDiv,
              sources: sources,
              searchTerm: "Enter keywords"
            });

            p1.innerHTML = "Find address, place or Gaihozu map";

            // 検索結果の図郭はどの縮尺か分からないため表示されるかは分からない
            geocodingSearchWidget.on("search-complete", function(event){
              const scale_num = event.results[0].results[0].feature.attributes.scale_num;
              const result = {};
              if ([1, 2, 3, 4].includes(scale_num)) {
                result.detail = '0';
              } else if ([5, 6, 7].includes(scale_num)) {
                result.detail = '1';
              } else if ([8].includes(scale_num)) {
                result.detail = '2';
              } else if ([9, 10].includes(scale_num)) {
                result.detail = '3';
              } else if ([11].includes(scale_num)) {
                result.detail = '4';
              }
              selectScaleid(result, false);
            });
          } else if (sceneView.map == mapSecond && sceneView.container) {
            const geocodingSearchWidget = new Search({
              view: sceneView,
              container: geocodingDiv,
              searchTerm: "Enter keywords"
            });
            p1.innerHTML = "Find address or place";
          } else if (view.map == mapSecond && view.container) {
            const geocodingSearchWidget = new Search({
              view: view,
              container: geocodingDiv,
              searchTerm: "Enter keywords"
            });
            p1.innerHTML = "Find address or place";
          }
          
          collapsePrimaryPanel();
          
        });

        //////////////////////////////////////////////
        //
        //   図郭ポリゴンをクリック→外邦図を閲覧
        //
        /////////////////////////////////////////////

        // ビューをクリック
        function clickView(){
          view.on("click", function(event) {
            if(view.map === map){
              if (activeWidget) {
                return;
              };
              
              // マップの中心とズームレベルを取得、外邦図から図郭検索地図に戻る際に使用
              viewZoom = view.zoom;
              viewCenter = view.center;
              viewRotation = view.rotation;

              queryFeaturesClickedPoint(event);
            } else {
              return;
            };
            
          });
        };

        clickView();

        // ポリゴンをクリック
        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          if (view.map === map && !activeWidget){
            // ビューがmapで、計測ウィジェットがアクティブでないときのみ
            zukakuLayerView.queryFeatures(queryParams)
            .then(queryArcGISOnline)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

        };

        // AGOLから該当するタイルレイヤーを検索
        function queryArcGISOnline(response){

          const featuresQuery = response.features;

          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            
            return;

          // タイルレイヤーを検索する
          } else if (length === 1) {
            startLoading();

            const feature = response.features[0];

            const id = feature.attributes.id;
            console.log(id);
            northId = feature.attributes.north;
            southId = feature.attributes.south;
            westId = feature.attributes.west;
            eastId = feature.attributes.east;
            
            portal.load().then(function() {
              const queryParams = {
                query: QUERYTXT + id,
                sortField: "numViews",
                sortOrder: "desc",
                num: 20
              };
              portal.queryItems(queryParams).then(addTileLayer);
            });
            return response;
          };
        };

        const mapSecond = new Map({
        });
        
        let itemId;
        let defaultTransparency = 75;
        
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;

        let is3D = true;
        let viewTilt = 45;
        let viewHeading = 0;

        let exaggerationId = '1';

        // 外邦図を初めて開く：false
        // 外邦図を開いた後に同じボタンをおす：true
        // let isOpened = false;
        
        function addTileLayer(response){
          
          itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          esriRequest(tileLayerUrl, options)
            .then(createTileView);

          
        };

        const sceneView = new SceneView({
          container: null
        });

        
        sceneView.ui.move(["zoom", "navigation-toggle", "compass"], "top-right");
        
        const homeBtn = new Home({
          view: sceneView
        });

        


        // ビューを作成
        function createTileView (response) {
          
          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          // メニューボタンの表示、非表示の切り替え
          setDisplayActionItemsSecond();

          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);
          // tileLayer.opacity = defaultTransparency/100;

          // マップ
          if (is3D === false) {

            createMap();
            
          // シーン
          } else if (is3D === true) {
            
            sceneView.map = mapSecond;
            mapSecond.basemap = map.basemap;

            createScene();
            
          }
        };

        function createMap(){

          if (windowWidth < MOBILE_WIDTH) {
            
            if (!primaryPanel.hasAttribute("collapsed")) {
              primaryPanel.setAttribute("collapsed", "");
            } 
      
          };

          sceneView.container = null;
          view.map = mapSecond;
          mapSecond.ground = {};

          tileLayer.when(function() {
          view.goTo(tileLayer.fullExtent);
          const vp = new Viewpoint({
            targetGeometry: tileLayer.fullExtent
          });
          homeBtn2D.viewpoint = vp;

          add2d3dRadioButton();
          addImageSettingsCalciteFlow();
        });

        };

        function createScene(){

          if (windowWidth < MOBILE_WIDTH) {
            
            if (!primaryPanel.hasAttribute("collapsed")) {
              primaryPanel.setAttribute("collapsed", "");
            } 
      
          };

          view.container = null;
          sceneView.container = "viewDiv";
          
          selectExaggerationId(exaggerationId);

          tileLayer.when(function() {

            // console.log(viewTilt);
            sceneView.goTo({
              target: tileLayer.fullExtent,
              tilt: viewTilt,
              heading: viewHeading
            })
            .then(function(){
              sceneView.ui.remove(homeBtn);
              sceneView.ui.add(homeBtn, "top-right");
              const vp = new Viewpoint({
                targetGeometry: tileLayer.fullExtent
              });
              homeBtn.viewpoint = vp;
              
              add2d3dRadioButton();
              addImageSettingsCalciteFlow();
            })
          });
        };

        //////////////////////////////////////////////
        //   Back
        /////////////////////////////////////////////
        
        backAction.addEventListener("click", function(event) {
          back2IndexMap();
        });

        function back2IndexMap () {

          startLoading();

          setDisplayActionItemsFirst();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          FilterAction.setAttribute("active", null);

          addCount2BtnTxt();
          
          sceneView.container = null;
          // view.container = null;

          view = new MapView({
            container: "viewDiv",
            map: map,
            extent: startExtent
          });

          homeBtn2D = new Home({
            view: view
          });

          compassWidget = new Compass({
            view: view
          });

          view.ui.move("zoom", "top-right");
          view.ui.add(homeBtn2D, "top-right");
          view.ui.add(compassWidget, "top-right");
          
          // 背景図をセットする
          map.basemap = mapSecond.basemap;
          mapSecond.ground = {};

          clickView();

          view.on("layerview-create", function(event) {
            
            if (event.layer.title === "図郭") {
              zukakuLayerView = event.layerView;
              
              zukakuLayerView.filter = {
                where: whereClause
              };
              
            };
          });

          view.when(function(){
            view.goTo({
              target: viewCenter,
              zoom: viewZoom,
              rotation: viewRotation
            });
          });
          
        }

        //////////////////////////////////////////////
        //   Exaggeration
        /////////////////////////////////////////////
        
        function selectExaggerationId (exaggerationId) {
          if (exaggerationId === '0') {
            mapSecond.ground = {
              layers: [new ExaggeratedElevationLayer1()],
              surfaceColor: [0, 0, 0]
            };
          } else if (exaggerationId === '1') {
            mapSecond.ground = {
              layers: [new ExaggeratedElevationLayer3()],
              surfaceColor: [0, 0, 0]
            };
          } else if (exaggerationId === '2') {
            mapSecond.ground = {
              layers: [new ExaggeratedElevationLayer5()],
              surfaceColor: [0, 0, 0]
            };
            
          };
        };

        // 倍率３倍
        const ExaggeratedElevationLayer3 = BaseElevationLayer.createSubclass({
          // Add an exaggeration property whose value will be used
          // to multiply the elevations at each tile by a specified
          // factor. In this case terrain will render 100x the actual elevation.

          properties: {
            exaggeration: 3
          },

          // The load() method is called when the layer is added to the map
          // prior to it being rendered in the view.

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            // wait for the elevation layer to load before resolving load()
            this.addResolvingPromise(this._elevation.load());
          },

          // Fetches the tile(s) visible in the view
          fetchTile: function(level, row, col) {
            // calls fetchTile() on the elevationlayer for the tiles
            // visible in the view
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;

                // `data` is an object that contains the
                // the width of the tile in pixels,
                // the height of the tile in pixels,
                // and the values of each pixel
                for (var i = 0; i < data.values.length; i++) {
                  // each value represents an elevation sample for the
                  // given pixel position in the tile. Multiply this
                  // by the exaggeration value
                  data.values[i] = data.values[i] * exaggeration;
                }

                return data;
              }.bind(this)
            );
          }
        });

        // 倍率１倍
        const ExaggeratedElevationLayer1 = BaseElevationLayer.createSubclass({

          properties: {
            exaggeration: 1
          },

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            this.addResolvingPromise(this._elevation.load());
          },

          fetchTile: function(level, row, col) {
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;
                for (var i = 0; i < data.values.length; i++) {
                  data.values[i] = data.values[i] * exaggeration;
                }
                return data;
              }.bind(this)
            );
          }
        });
        
        // 倍率５倍
        const ExaggeratedElevationLayer5 = BaseElevationLayer.createSubclass({

          properties: {
            exaggeration: 5
          },

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            this.addResolvingPromise(this._elevation.load());
          },

          fetchTile: function(level, row, col) {
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;
                for (var i = 0; i < data.values.length; i++) {
                  data.values[i] = data.values[i] * exaggeration;
                }
                return data;
              }.bind(this)
            );
          }
        });

        //////////////////////////////////////////////
        //   AGO
        /////////////////////////////////////////////

        agoAction.addEventListener("click", function(event){
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          agoAction.setAttribute("active", null);

          const agoCalciteFlow = document.createElement("calcite-flow");
          agoCalciteFlow.setAttribute('id', 'agoCalciteFlow');
          primaryPanel.appendChild(agoCalciteFlow);

          const agoCalcitePanel = document.createElement("calcite-panel");
          agoCalcitePanel.setAttribute("heading", "Open Web map");
          agoCalciteFlow.appendChild(agoCalcitePanel);

          const agoButton = document.createElement("calcite-button");
          agoButton.setAttribute("width", "full");
          agoButton.setAttribute("icon-start", "arcgis-online");
          agoButton.setAttribute("appearance", "outline");
          agoButton.innerHTML = "Open Web Map";
          agoCalcitePanel.appendChild(agoButton);

          agoButton.onclick = function(){
            if (is3D === false) {
              window.open('https://www.arcgis.com/apps/mapviewer/index.html?layers=' + itemId, '_blank');
            } else if (is3D === true) {
              window.open('https://www.arcgis.com/home/webscene/viewer.html?layers=' + itemId, '_blank');
            }
          };

          const copyTileCalciteFlow = document.createElement("calcite-flow");
          copyTileCalciteFlow.setAttribute('id', 'copyTileCalciteFlow');
          primaryPanel.appendChild(copyTileCalciteFlow);

          const copyTileCalcitePanel = document.createElement("calcite-panel");
          copyTileCalcitePanel.setAttribute("heading", "Copy Tile Service URL");
          copyTileCalciteFlow.appendChild(copyTileCalcitePanel);

          const copyTileButton = document.createElement("calcite-button");
          copyTileButton.setAttribute("width", "full");
          copyTileButton.setAttribute("icon-start", "copy-to-clipboard");
          copyTileButton.setAttribute("appearance", "outline");
          copyTileButton.innerHTML = "Copy WMTS URL";
          copyTileCalcitePanel.appendChild(copyTileButton);

          copyTileButton.onclick = function(){
            const url = tileLayer.url + "/wmts";
            if(navigator.clipboard){
              navigator.clipboard.writeText(url);
            }
          };

          collapsePrimaryPanel();

        });

        //////////////////////////////////////////////
        //   Metadata
        /////////////////////////////////////////////

        const arrayAtt = [
          {"title": "記号", "att": "area3"},
          {"title": "図幅名", "att": "area_name"},
          {"title": "測量機関", "att": "surveyed_by"},
          {"title": "測量時期（修正含む）", "att": "survey_year"},
          {"title": "製版・印刷機関", "att": "printed_by"},
          {"title": "製版時期", "att": "print_year"},
          {"title": "発行時期", "att": "publish_year"},
          {"title": "大きさ", "att": "size"},
          {"title": "色", "att": "color"},
          {"title": "備考", "att": "notes"},
          {"title": "枚数（実物）", "att": "copies"}
        ];

        metadataAction.addEventListener("click", function(event){
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          metadataAction.setAttribute("active", null);

          const metadataCalciteFlow = document.createElement("calcite-flow");
          metadataCalciteFlow.setAttribute('id', 'metadataCalciteFlow');
          primaryPanel.appendChild(metadataCalciteFlow);

          const metadataCalcitePanel = document.createElement("calcite-panel");
          metadataCalcitePanel.setAttribute("heading", "Metadata");
          // opacityCalcitePanel.setAttribute("summary", "Change the opacity to ...............................................");
          metadataCalciteFlow.appendChild(metadataCalcitePanel);

          metadataCalcitePanel.appendChild(attributeDiv);

          collapsePrimaryPanel();

        });

        const attributeDiv = document.createElement("div");
        attributeDiv.style.paddingLeft = "20px";
        attributeDiv.style.paddingRight = "20px";

        function addZukakuAttribute (response) {

          if (typeof response === 'undefined') {
            return;
          }

          const feature = response.features[0];
          
          attributeDiv.innerHTML = "";

          const divArea3_en = document.createElement("h3");
          const attArea3_en = feature.attributes.area3_en;
          divArea3_en.innerHTML = attArea3_en;
          attributeDiv.appendChild(divArea3_en);

          const divTitle = document.createElement("h3");
          const attTitle = feature.attributes.title;
          // divTitle.className = "font-size--1";
          divTitle.innerHTML = attTitle;
          attributeDiv.appendChild(divTitle);

          const divScale = document.createElement("h3");
          const attScale = feature.attributes.scale;
          // divScale.className = "padding-leader-half font-size--1";
          divScale.innerHTML = attScale;
          attributeDiv.appendChild(divScale);

          const divPrintedYear = document.createElement("h3");
          const attPrintedYear = feature.attributes.print_year_en;
          // divPrintedYear.className = "padding-leader-half font-size--1";
          divPrintedYear.innerHTML = "Printed in " + attPrintedYear;
          attributeDiv.appendChild(divPrintedYear);

          const divSize = document.createElement("h3");
          const attSize = feature.attributes.height_width;
          // divSize.className = "padding-leader-half font-size--1";
          divSize.innerHTML = attSize + " (cm)";
          if (attSize !== "-"){
            attributeDiv.appendChild(divSize);
          }

          const divId = document.createElement("h3");
          const attId = feature.attributes.id;
          divId.innerHTML = attId;
          attributeDiv.appendChild(divId);
          

          const details = document.createElement("details");
          details.style.paddingBottom = "20px";
          attributeDiv.appendChild(details);

          const summary = document.createElement("summary");
          summary.innerHTML = "Details in Japanese";
          details.appendChild(summary);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            const attribute = document.createElement("h4");
            // attribute.className = "padding-leader-half padding-left-half font-size--1";
            details.appendChild(attribute);

            const title = document.createElement("h4");
            attribute.appendChild(title);
            title.style.color = "gray";
            title.innerHTML = arrayAtt[i]["title"];

            const value = document.createElement("h4");
            attribute.appendChild(value);

            value.innerHTML = attValue;
          };
          

        };

        //////////////////////////////////////////////
        //   Image settings
        /////////////////////////////////////////////

        imageSettingsAction.addEventListener("click", function(event) {
          
          collapsePrimaryPanel();
          addImageSettingsCalciteFlow();
          
        });

        function addImageSettingsCalciteFlow () {
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          imageSettingsAction.setAttribute("active", null);

          // Notice
          // const noticeBackCalciteFlow = document.createElement("calcite-flow");
          // noticeBackCalciteFlow.setAttribute('id', 'noticeBackCalciteFlow');
          // primaryPanel.appendChild(noticeBackCalciteFlow);

          // const noticeCalcitePanel = document.createElement("calcite-panel");
          // noticeBackCalciteFlow.appendChild(noticeCalcitePanel);

          // const caliciteNotice = document.createElement("calcite-notice");
          // caliciteNotice.setAttribute("active", "");
          // caliciteNotice.setAttribute("color", "yellow");
          // caliciteNotice.setAttribute("icon", "lightbulb");
          // noticeCalcitePanel.appendChild(caliciteNotice);

          // const titleDiv = document.createElement("div");
          // titleDiv.setAttribute("slot", "notice-title");
          // titleDiv.innerHTML = "Click Back to index button to go back to index map.";
          // caliciteNotice.appendChild(titleDiv);
          // primaryPanel.appendChild(noticeBackCalciteFlow);

          // opacity
          const opacityCalciteFlow = document.createElement("calcite-flow");
          opacityCalciteFlow.setAttribute('id', 'opacityCalciteFlow');
          primaryPanel.appendChild(opacityCalciteFlow);

          const opacityCalcitePanel = document.createElement("calcite-panel");
          opacityCalcitePanel.setAttribute("heading", "Opacity");
          // opacityCalcitePanel.setAttribute("summary", "Change the opacity to ...............................................");
          opacityCalciteFlow.appendChild(opacityCalcitePanel);

          const opacityDiv = document.createElement("div");
          opacityDiv.style.padding = "20px";
          opacityCalcitePanel.appendChild(opacityDiv);

          const opacityCalciteSlider = document.createElement("calcite-slider");
          opacityCalciteSlider.setAttribute("min", "0");
          opacityCalciteSlider.setAttribute("max", "100");
          opacityCalciteSlider.setAttribute("value", defaultTransparency);
          opacityCalciteSlider.setAttribute("scale", "l");
          opacityCalciteSlider.setAttribute("label-handles", "true");
          opacityCalciteSlider.setAttribute("precise", "true");
          opacityCalciteSlider.setAttribute("snap", "true");
          opacityCalciteSlider.setAttribute("step", "5");
          opacityCalciteSlider.setAttribute("max-label", "100");
          opacityDiv.appendChild(opacityCalciteSlider);

          // event
          opacityCalciteSlider.addEventListener('calciteSliderChange', transparencyChanged);

          // Exaggerating elevation: only 3D
          if (is3D == true) {
            const exaggerationCalciteFlow = document.createElement("calcite-flow");
            exaggerationCalciteFlow.setAttribute('id', 'exaggerationCalciteFlow');
            primaryPanel.appendChild(exaggerationCalciteFlow);

            const exaggerationCalcitePanel = document.createElement("calcite-panel");
            exaggerationCalcitePanel.setAttribute("heading", "Exaggerating elevation");
            // exaggerationCalcitePanel.setAttribute("summary", "hogehogehoge");
            exaggerationCalciteFlow.appendChild(exaggerationCalcitePanel);

            const exaggerationRadioGroup = document.createElement("calcite-radio-group");
            exaggerationRadioGroup.setAttribute("width", "full");
            exaggerationCalcitePanel.appendChild(exaggerationRadioGroup);

            const x1RadioButton = document.createElement("calcite-radio-group-item");
            x1RadioButton.setAttribute("value", "1");
            x1RadioButton.innerHTML = "1x";
            exaggerationRadioGroup.appendChild(x1RadioButton);
            
            const x3RadioButton = document.createElement("calcite-radio-group-item");
            x3RadioButton.setAttribute("value", "3");
            x3RadioButton.innerHTML = "3x";
            exaggerationRadioGroup.appendChild(x3RadioButton);

            const x5RadioButton = document.createElement("calcite-radio-group-item");
            x5RadioButton.setAttribute("value", "5");
            x5RadioButton.innerHTML = "5x";
            exaggerationRadioGroup.appendChild(x5RadioButton);

            if (exaggerationId === "0") {
              x1RadioButton.setAttribute("checked", null);
            } else if (exaggerationId === "1") {
              x3RadioButton.setAttribute("checked", null);
            } else if (exaggerationId === "2") {
              x5RadioButton.setAttribute("checked", null);
            }

            // event
            x1RadioButton.addEventListener("click", function(event) {
              exaggerationId = '0';
              selectExaggerationId(exaggerationId);
            });
            x3RadioButton.addEventListener("click", function(event) {
              exaggerationId = '1';
              selectExaggerationId(exaggerationId);
            });
            x5RadioButton.addEventListener("click", function(event) {
              exaggerationId = '2';
              selectExaggerationId(exaggerationId);
            });

          }
          

          // adjacent map
          const adjacentCalciteFlow = document.createElement("calcite-flow");
          adjacentCalciteFlow.setAttribute('id', 'adjacentCalciteFlow');
          primaryPanel.appendChild(adjacentCalciteFlow);

          const adjacentCalcitePanel = document.createElement("calcite-panel");
          adjacentCalcitePanel.setAttribute("heading", "Show adjacent map");
          // adjacentCalcitePanel.setAttribute("summary", "hogehogehoge");
          adjacentCalcitePanel.setAttribute("id", "adjacentCalcitePanel");
          adjacentCalciteFlow.appendChild(adjacentCalcitePanel);

          // 東西南北ボタンを追加
          addAllDirectionBtn2View();

          
          
        };

        //////////////////////////////////////////////
        //   2D3Dボタン
        /////////////////////////////////////////////

        function add2d3dRadioButton () {
          const mapSceneRadioGroup = document.createElement("calcite-radio-group");
          if (windowWidth < MOBILE_WIDTH) {
            mapSceneRadioGroup.setAttribute("scale", "m");
          } else {
            mapSceneRadioGroup.setAttribute("scale", "l");
          }
          
          
          const mapRadioGroupItem = document.createElement("calcite-radio-group-item");
          mapRadioGroupItem.setAttribute("value", "map");
          mapRadioGroupItem.innerHTML = "2D";
          mapSceneRadioGroup.appendChild(mapRadioGroupItem);
           
          const sceneRadioGroupItem = document.createElement("calcite-radio-group-item");
          sceneRadioGroupItem.setAttribute("value", "area");
          sceneRadioGroupItem.innerHTML = "3D";
          mapSceneRadioGroup.appendChild(sceneRadioGroupItem);

          if (is3D == true) {
            sceneRadioGroupItem.setAttribute("checked", null);
            mapRadioGroupItem.removeAttribute("checked");
            sceneView.ui.empty("top-left");
            sceneView.ui.add(mapSceneRadioGroup, "top-left");
          } else if (is3D == false) {
            mapRadioGroupItem.setAttribute("checked", null);
            sceneRadioGroupItem.removeAttribute("checked");
            view.ui.empty("top-left");
            view.ui.add(mapSceneRadioGroup, "top-left");
          }

          mapRadioGroupItem.addEventListener("click", function(event) {
            switch2Map();
          });

          sceneRadioGroupItem.addEventListener("click", function(event) {
            switch2Scene();
          });

        };

        // マップとシーンの切り替え
        function switch2Scene() {

          is3D = true;

          // 計測ウィジェットを初期化
          resetMeasureWidget();

          // createScene();          

          view.container = null;
          sceneView.container = "viewDiv";

          selectExaggerationId(exaggerationId);

          tileLayer.when(function() {
            sceneView.goTo({
              target: tileLayer.fullExtent,
              tilt: viewTilt,
              heading: viewHeading
            })
            .then(function(){
              const vp = new Viewpoint({
                targetGeometry: tileLayer.fullExtent
              });
              homeBtn.viewpoint = vp;
              add2d3dRadioButton();
              addImageSettingsCalciteFlow();
            })
          });
        };




        function switch2Map() {

          is3D = false;

          // 計測ウィジェットを初期化
          resetMeasureWidget();

          viewTilt = sceneView.camera.tilt;
          viewHeading = sceneView.camera.heading;

          const activeViewpoint = sceneView.viewpoint.clone();

          sceneView.container = null;
          view.container = "viewDiv";

          view.map = mapSecond;
          mapSecond.ground = {};

          tileLayer.when(function() {
          
            view.goTo(activeViewpoint);
            const vp = new Viewpoint({
              targetGeometry: tileLayer.fullExtent
            });
            homeBtn2D.viewpoint = vp;
            add2d3dRadioButton();
          });
          
          addImageSettingsCalciteFlow();
        }

        //////////////////////////////////////////////
        //   東西南北ボタン
        /////////////////////////////////////////////
        function addAllDirectionBtn2View (view) {
          all([createDirectionBtn(northId, "northBtn", "arrow-bold-up", "North"), 
               createDirectionBtn(southId, "southBtn", "arrow-bold-down", "South"),
               createDirectionBtn(westId, "westBtn", "arrow-bold-left", "West"),
               createDirectionBtn(eastId, "eastBtn", "arrow-bold-right", "East")
              ])
          .then(function(results){
            
            for (let i in results) {
              
              if (results[i].id) {
                
                const adjacentCalcitePanel = document.getElementById("adjacentCalcitePanel");
                adjacentCalcitePanel.appendChild(results[i]);
                results[i].addEventListener("click", showNextImage);
              };
            }
            endLoading();
          });
        };
        
        function createDirectionBtn (id, attId, classIcon, text) {
          const deferred = new Deferred();
          
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["georeference"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
            .then(function(response){
              
              const arrowBtn = document.createElement('calcite-button');
              
              if (response.features.length > 0){
                const feature = response.features[0];

                const georeferenceflg = feature.attributes.georeference;
                // 隣接図郭のサービスはあがっているとは限らない
                if (georeferenceflg === 1) {
                  
                  arrowBtn.setAttribute("id", attId);
                  arrowBtn.setAttribute("data-id", id);
                  arrowBtn.setAttribute("width", "full");
                  arrowBtn.setAttribute("appearance", "outline");
                  arrowBtn.setAttribute("icon-start", classIcon);
                  arrowBtn.className = "legendbutton";
                  arrowBtn.innerHTML = text;

                }
              }
              deferred.resolve(arrowBtn);

            }).catch(function(error) {
              console.error("query failed: ", error);
            });
          
          return deferred.promise;

        };

        // 方位ボタンをクリックして隣接外邦図を表示
        function showNextImage (event) {

          if (sceneView.container) {
            viewTilt = sceneView.camera.tilt;
            viewHeading = sceneView.camera.heading;
          }

          // startLoading();
          const id = event.target.dataset.id;

          const queryParams = zukakuFeatureLayer.createQuery();
          // set a geometry for querying features by the view's extent
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
          .then(queryArcGISOnline)
          // .then(addZukakuAttribute)
          .catch(function(error) {
            console.log(error);
          });
        };

        //////////////////////////////////////////////
        //   透過率
        /////////////////////////////////////////////
        function transparencyChanged(event) {
          defaultTransparency = event.target.attributes.getNamedItem("value").value;
          tileLayer.opacity = defaultTransparency/100;
        };

        //////////////////////////////////////////////
        //   ローディング
        /////////////////////////////////////////////
        
        const loaderBackground = document.getElementById("loaderBackground");
        const loaderDiv = document.getElementById("loaderDiv");

        function startLoading(){
          loaderBackground.style.display = "block";
          loaderDiv.setAttribute("active", null);
        };

        function endLoading() {
          if (loaderDiv.hasAttribute("active")) {
            loaderBackground.style.display = "none";
            loaderDiv.removeAttribute("active");
          }
        };

        //////////////////////////////////////////////
        //   モーダル
        /////////////////////////////////////////////
        // モーダル（初期表示）
        const firstModal = document.getElementById("firstModal");
        const infoModal = document.getElementById("infoModal"); 

        // 初回は強制的に表示
        if(localStorage.getItem('flgNotShowAgain') === null) {
          firstModal.setAttribute("active", "");
        };

        // 閉じるボタン
        const closeFirstModalBtn = document.getElementById("closeFirstModalBtn");
        closeFirstModalBtn.onclick = function(){
          if (firstModal.hasAttribute("active")) {
            firstModal.removeAttribute("active");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };

        const information = document.getElementById("information");
        information.onclick = function(){
          // if (!firstModal.hasAttribute("active")) {
            infoModal.setAttribute("active", "");
          // }
        };

        const closeInfoModalBtn = document.getElementById("closeInfoModalBtn");
        closeInfoModalBtn.onclick = function(){
          if (infoModal.hasAttribute("active")) {
            infoModal.removeAttribute("active");
          }
        };

        //////////////////////////////////////////////
        //   スマホ対応
        /////////////////////////////////////////////

        if (windowWidth < MOBILE_WIDTH) {
          primaryPanel.setAttribute("collapsed", "");
          actionBar.setAttribute("expanded", "false");
          actionBar.setAttribute("expand-disabled", "true");

          backAction.setAttribute("scale", "m");
          imageSettingsAction.setAttribute("scale", "m");
          metadataAction.setAttribute("scale", "m");
          agoAction.setAttribute("scale", "m");
          basemapAction.setAttribute("scale", "m");
          FilterAction.setAttribute("scale", "m");
          measurementAction.setAttribute("scale", "m");
          searchAction.setAttribute("scale", "m");
        }

        function collapsePrimaryPanel () {
          if (windowWidth < MOBILE_WIDTH) {
            if (primaryPanel.hasAttribute("collapsed")) {
              primaryPanel.removeAttribute("collapsed");
            } else {
              primaryPanel.setAttribute("collapsed", "");
            }
          };
        };

      });
    </script>
  </head>

  <body>

    <calcite-modal aria-labelledby="modal-title" id="firstModal">
      <div slot="header" id="modal-title">Gaihozu Viewer : Indonesian-territory version (GV-I)</div>
      <div slot="content">Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands made by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS Online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
        <p>Clicking a shaded box on the index map enable you to show the corresponding geo-referenced map in 3D scene with its metadata, such as map scale and printed year. Clicking a button of ratio like 1:500,000 switched the index map of the corresponding map scale.</p>
        <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a> maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University. The article about this web applicataion is published on <a href="https://www.esri.com/about/newsroom/arcuser/finding-lost-landscapes-in-southeast-asia/" target="_blank">ArcUser</a>.</p>
        <p>Copyright (C) 2020-  Human Geography Research Group at Tohoku University (Environmental Geography Lab at the Graduate School of Environmental Studies and the Institute of Geography, the Graduate School of Science, Tohoku University)</p>
        <p>Project team members: T. Nakaya, S. Nagata, Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
        <div>
          <img src="./img/gaihozu3dforsplash.jpg" width="100%">
        </div>
      </div>
      <calcite-checkbox slot="secondary" id="notShowAgainChk">Don't show this message again.</calcite-checkbox>
      <calcite-button slot="primary" width="full" id="closeFirstModalBtn">Close</calcite-button>
    </calcite-modal>

    <calcite-modal aria-labelledby="modal-title" id="infoModal">
      <div slot="header" id="modal-title">Gaihozu Viewer : Indonesian-territory version (GV-I)</div>
      <div slot="content">Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands made by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS Online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
        <p>Clicking a shaded box on the index map enable you to show the corresponding geo-referenced map in 3D scene with its metadata, such as map scale and printed year. Clicking a button of ratio like 1:500,000 switched the index map of the corresponding map scale.</p>
        <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a> maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University. The article about this web applicataion is published on <a href="https://www.esri.com/about/newsroom/arcuser/finding-lost-landscapes-in-southeast-asia/" target="_blank">ArcUser</a>.</p>
        <p>Special thanks to Dr. Fatwa Ramdani (Brawijaya University, Indonesia) for his valuable comments to the earlier version of this project site and <a href="https://www.wingfield.gr.jp/" target="_blank">Mr. Kohsuke Hada</a> for his help on the identification of old map datum. This project was financially supported by JSPS KAKENHI 16H01965 (PI: Prof Keiji Yano).</p>
        <p>Copyright (C) 2020-  Human Geography Research Group at Tohoku University (Environmental Geography Lab at the Graduate School of Environmental Studies and the Institute of Geography, the Graduate School of Science, Tohoku University)</p>
        <p>Project team members: T. Nakaya, S. Nagata, Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
        <div>
          <img src="./img/gaihozu3dforsplash.jpg" width="100%">
        </div>
      </div>
      <calcite-button slot="primary" width="full" id="closeInfoModalBtn">Close</calcite-button>
    </calcite-modal>

    <calcite-shell theme="dark">

      <div slot="shell-header">
        
        <header>
          
          <div id="divHeader">
            <div id="headerTitle">
              <h2>Gaihozu Viewer
                <span id="subtitle"> : Indonesian-territory version (GV-I)</span>
              </h2>
            </div>
            <div id="buttonInfo">
              <calcite-button icon-start="information" scale="l" appearance="transparent" color="neutral" id="information"></calcite-button>
            </div>
            <div id="imgTohoku">
              
              <span>
                <img src="./img/Toh_E_S_N_G.gif" height="56px" width="56px">
              </span>
            </div>
          </div>    
        </header>
      </div>

      <calcite-shell-panel slot="primary-panel" position="start" detached id="primaryPanel">
          <calcite-action-bar slot="action-bar" expanded="true" id="actionBar">
            
            <calcite-action-group id="actionGroup">
              <calcite-action text="Back to Index" icon="x-circle" scale="l" id="backAction"></calcite-action>
              <calcite-action text="Image settings" icon="image-layer" scale="l" id="imageSettingsAction"></calcite-action>
              <calcite-action text="Metadata" icon="access-string-results" scale="l" id="metadataAction"></calcite-action>
              <calcite-action text="ArcGIS Online" icon="arcgis-online" scale="l" id="agoAction"></calcite-action>
              <calcite-action text="Filter" active icon="filter" scale="l" id="filterAction"></calcite-action>
              <calcite-action text="Search" icon="search" scale="l" id="searchAction"></calcite-action>
              <calcite-action text="Basemap" icon="basemap" scale="l" id="basemapAction"></calcite-action>
              <calcite-action text="Measurement" icon="measure" scale="l" id="measurementAction"></calcite-action>
            </calcite-action-group>
            
          </calcite-action-bar>
          
      </calcite-shell-panel>
      
      

      <div id="viewDiv" slot="center-row"></div>
      
  </calcite-shell>
    
  <div id="loaderBackground">
    <calcite-loader active type="indeterminate" id="loaderDiv"></calcite-loader>  
  </div>

  </body>
</html>
