<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      #viewDiv {
        position: absolute;
        left: 75px;
        right: 0;
        top: 0;
        bottom: 0;
        height: 100%;
      }
      #attributeDiv {
        top: 55px;
        bottom: 0px;
        left: 75px;
        right: 0px;
        height: calc(100% - 55px);
        width: 180px;
        position: absolute;
        display: none;
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 10px;
        border-color: #464646;
        border-width: 1px;
        border-left-style: solid;
        border-right-style: solid;
        overflow-y: scroll;
        background: #f8f8f8;
      }
      #titleDiv {
        position: absolute;
        height: 55px;
        left: 0px;
        right: 0px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        background: #464646;
        z-index: 1;
      }

      .top-nav-title {
        color: #f8f8f8 !important;
      }
      #menuDiv {
        position: absolute;
        top: 55px;
        left: 0;
        right: 0;
        height: calc(100% - 55px);
        width: 75px;
        overflow-y: auto;
        background: #f8f8f8;
      }
      #menuDiv [class*="esri-icon"] {
        font-size: 25px !important;
      }
      .menu-area {
        cursor : pointer;
      }

      @media screen and (min-width: 1367px) {
        .menu-area:hover {
          background-color: lightgray;
          color: #59d6ff;
        }
      }
      #backDiv, #metadataDiv {
        display: none;
      }
      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        position: absolute !important;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }
      .active-menu {
        background-color: #464646 !important;
        color: #59d6ff !important;
      }
      button {
        background-color: #0079c1 !important;
        color: #f8f8f8 !important;
      }
      button[disabled] {
        opacity: 100 !important;
        background-color: lightgray !important;
        color: #0079c1 !important;
      } 
      /* #toolbarMeasureDiv {
        flex-direction: row;
        flex-wrap: nowrap;
        display: flex;
      } */
      .esri-widget--button {
        background-color: #f8f8f8 !important;
        color: #464646 !important;
      }
      .esri-widget--button.active,
      .esri-widget--button.active:hover,
      .esri-widget--button.active:focus {
        cursor: default;
        background-color: #999696 !important;
      }
      .esri-widget--button.active path,
      .esri-widget--button.active:hover path,
      .esri-widget--button.active:focus path {
        fill: #e4e4e4 !important;
      }
      .esri-legend__layer-caption {
        display: none !important;
      }
      .esri-legend {
        width: 200px !important;
      }
      .slider {
        width: 100%;
        height: 60px;
      }
      #opacityMapDiv, #opacitySceneDiv {
        width: 250px;
        background: #f8f8f8;
        display: none;
        /* height: 60px; */
      }
      .esri-slider {
        background: #f8f8f8 !important;
      }
      /* .direction {
        width: 100px !important;
      } */
      fieldset{
        float: left;
      }
      article, aside, details, figcaption, figure, footer, header, hgroup, nav, section, summary{
        display: revert !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.15/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css">
    <!-- <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script> -->
    <!-- interactive patterns need to be initialized -->
    <!-- <script>
       calcite.init()
    </script> -->
    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.15/"></script>
    
    <script>
      require([
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/Search",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
        "esri/widgets/Legend",
        "dojo/Deferred",
        "dojo/promise/all",
        "esri/views/SceneView",
        "esri/layers/ElevationLayer",
        "esri/layers/BaseElevationLayer"
      ], function(
        MapView, 
        FeatureLayer,
        Map,
        Search,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement,
        BasemapGallery,
        PortalBasemapsSource,
        Legend,
        Deferred,
        all,
        SceneView,
        ElevationLayer,
        BaseElevationLayer
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const QUERYTXT = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";

        //////////////////////////////////////////////
        //   メニューボタンを画面に追加
        /////////////////////////////////////////////

        // メニューのリスト
        const listMenu = [
          {'text': 'measure ment', 'icon': "esri-icon-measure", 'phone-hide': true},
          {'text': 'basemap', 'icon': "esri-icon-basemap", 'phone-hide': false},
          {'text': 'search', 'icon': "esri-icon-search", 'phone-hide': true},
          {'text': 'legend', 'icon': "esri-icon-layer-list", 'phone-hide': false},
          {'text': 'info', 'icon': "esri-icon-description", 'phone-hide': false},
          {'text': 'metadata', 'icon': "esri-icon-documentation", 'phone-hide': false},
          {'text': '3D', 'icon': "esri-icon-globe", 'phone-hide': true},
          {'text': 'back to index map', 'icon': "esri-icon-close-circled", 'phone-hide': false}
        ];
        const menuDiv = document.getElementById("menuDiv");
        const menuIndex = {
          measurement: 0,
          basemap: 1,
          search: 2,
          legend: 3,
          info: 4,
          metadata: 5,
          threed: 6,
          back: 7
        };

        // メニューボタンを追加
        for (let i in listMenu) {

          listMenu[i].elm = document.createElement('div');
          if (listMenu[i]['phone-hide'] === false) {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area";
          } else {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area phone-hide";
          };
          listMenu[i].elm.setAttribute("menu-id", i);
          menuDiv.insertBefore(listMenu[i].elm, menuDiv.firstChild);
          
          const menuIconDiv = document.createElement('div');
          menuIconDiv.className = listMenu[i]['icon'];
          menuIconDiv.setAttribute("menu-id", i);
          listMenu[i].elm.insertBefore(menuIconDiv, listMenu[i].elm.firstChild);
          
          const menuTextDiv = document.createElement('div');
          menuTextDiv.className = "font-size--2";
          menuTextDiv.innerHTML = listMenu[i]['text'];
          menuTextDiv.setAttribute("menu-id", i);
          menuIconDiv.parentNode.insertBefore(menuTextDiv, menuIconDiv.nextSibling);

        };

        // 検索画面では使わないボタンは非表示
        listMenu[menuIndex.metadata].elm.style.display = "none";
        listMenu[menuIndex.threed].elm.style.display = "none";
        listMenu[menuIndex.back].elm.style.display = "none";

        //////////////////////////////////////////////
        //
        //   Create a subclass of BaseElevationLayer
        //
        /////////////////////////////////////////////

        // 倍率３倍
        var ExaggeratedElevationLayer3 = BaseElevationLayer.createSubclass({
          // Add an exaggeration property whose value will be used
          // to multiply the elevations at each tile by a specified
          // factor. In this case terrain will render 100x the actual elevation.

          properties: {
            exaggeration: 3
          },

          // The load() method is called when the layer is added to the map
          // prior to it being rendered in the view.

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            // wait for the elevation layer to load before resolving load()
            this.addResolvingPromise(this._elevation.load());
          },

          // Fetches the tile(s) visible in the view
          fetchTile: function(level, row, col) {
            // calls fetchTile() on the elevationlayer for the tiles
            // visible in the view
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;

                // `data` is an object that contains the
                // the width of the tile in pixels,
                // the height of the tile in pixels,
                // and the values of each pixel
                for (var i = 0; i < data.values.length; i++) {
                  // each value represents an elevation sample for the
                  // given pixel position in the tile. Multiply this
                  // by the exaggeration value
                  data.values[i] = data.values[i] * exaggeration;
                }

                return data;
              }.bind(this)
            );
          }
        });

        // 倍率１倍
        var ExaggeratedElevationLayer1 = BaseElevationLayer.createSubclass({

          properties: {
            exaggeration: 1
          },

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            this.addResolvingPromise(this._elevation.load());
          },

          fetchTile: function(level, row, col) {
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;
                for (var i = 0; i < data.values.length; i++) {
                  data.values[i] = data.values[i] * exaggeration;
                }
                return data;
              }.bind(this)
            );
          }
        });
        
        // 倍率５倍
        var ExaggeratedElevationLayer5 = BaseElevationLayer.createSubclass({

          properties: {
            exaggeration: 5
          },

          load: function() {
            this._elevation = new ElevationLayer({
              url:
                "https://elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer"
            });

            this.addResolvingPromise(this._elevation.load());
          },

          fetchTile: function(level, row, col) {
            return this._elevation.fetchTile(level, row, col).then(
              function(data) {
                var exaggeration = this.exaggeration;
                for (var i = 0; i < data.values.length; i++) {
                  data.values[i] = data.values[i] * exaggeration;
                }
                return data;
              }.bind(this)
            );
          }
        });

        // マップ 
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-vector'
          
        });

        let view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, -2.0326589312043144],
          zoom: 4,
          padding: {
            top: 55
          }
        });

        view.ui.remove("zoom");

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;

        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {

          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };

        });

        //////////////////////////////////////////////
        //
        //   メニューボタンの動作
        //
        /////////////////////////////////////////////

        let measurement;
        let toolbarMeasureDiv;
        let basemapGallery;
        let searchWidgetWithSources;
        let searchWidget;
        let legend;
        let distanceMeasureBtn;
        let areaMeasureBtn;
        let clearMeasureBtn;

        clickMenuBtn(view);

        function clickMenuBtn(view){

          //////////////////////////////////////////////
          //   計測
          /////////////////////////////////////////////
          // 計測ボタン
          toolbarMeasureDiv = document.createElement("div");
          toolbarMeasureDiv.className = "esri-component esri-widget";

          distanceMeasureBtn = document.createElement("button");
          distanceMeasureBtn.className = "esri-widget--button esri-interactive esri-icon-measure-line";
          distanceMeasureBtn.title = "Distance Measurement Tool";
          toolbarMeasureDiv.appendChild(distanceMeasureBtn);
          
          areaMeasureBtn = document.createElement("button");
          areaMeasureBtn.className = "esri-widget--button esri-interactive esri-icon-measure-area";
          areaMeasureBtn.title = "Area Measurement Tool";
          toolbarMeasureDiv.appendChild(areaMeasureBtn);

          clearMeasureBtn = document.createElement("button");
          clearMeasureBtn.className = "esri-widget--button esri-interactive esri-icon-trash";
          clearMeasureBtn.title = "Area Measurement Tool";
          toolbarMeasureDiv.appendChild(clearMeasureBtn);

          // 計測ウィジェット
          measurement = new Measurement({
            view: view
          });

          // 計測ボタンクリック時のイベント
          listMenu[menuIndex.measurement].elm.onclick = function(){
            if (!listMenu[menuIndex.measurement].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.measurement].elm.classList.add("active-menu");
              view.ui.add(toolbarMeasureDiv, "bottom-right");
              view.ui.add(measurement, "bottom-right");
              removeOtherUI(view, menuIndex.measurement);
            } else {
              listMenu[menuIndex.measurement].elm.classList.remove("active-menu");
              
              view.ui.remove(toolbarMeasureDiv, "bottom-left");
              view.ui.remove(measurement, "bottom-right");
              measurement.clear();

              distanceMeasureBtn.classList.remove("active");
              areaMeasureBtn.classList.remove("active");
            }
            removeActiveMenu([menuIndex.measurement,menuIndex.info,menuIndex.metadata]);
          };

          distanceMeasureBtn.addEventListener("click", function() {
            if (view.type === "2d") {
              measurement.activeTool = "distance";
            } else if (view.type === "3d") {
              measurement.activeTool = "direct-line";
            }
            
            distanceMeasureBtn.classList.add("active");
            areaMeasureBtn.classList.remove("active");
          });

          areaMeasureBtn.addEventListener("click", function() {
            measurement.activeTool = "area";
            distanceMeasureBtn.classList.remove("active");
            areaMeasureBtn.classList.add("active");
          });

          clearMeasureBtn.addEventListener("click", function() {
            measurement.clear();
            distanceMeasureBtn.classList.remove("active");
            areaMeasureBtn.classList.remove("active");
          });

          //////////////////////////////////////////////
          //   背景
          /////////////////////////////////////////////
          // ベースマップウィジェット
          const portalSource = new PortalBasemapsSource({  
            query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
          });

          basemapGallery = new BasemapGallery({       
            view: view,     
            container: document.createElement("div"),       
            source: portalSource
          }); 

          // ベースマップボタンクリック時のイベント
          listMenu[menuIndex.basemap].elm.onclick = function(){
            if (!listMenu[menuIndex.basemap].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.basemap].elm.classList.add("active-menu");
              view.ui.add(basemapGallery, "bottom-right");
              removeOtherUI(view, menuIndex.basemap);
            } else {
              listMenu[menuIndex.basemap].elm.classList.remove("active-menu");
              view.ui.remove(basemapGallery, "bottom-left");
            }
            removeActiveMenu([menuIndex.basemap,menuIndex.info,menuIndex.metadata]);
          };
          
          //////////////////////////////////////////////
          //   凡例
          /////////////////////////////////////////////
          // 凡例ウィジェット
          legend = new Legend({
            view: view,
            layerInfos: [
              {
                layer: zukakuFeatureLayer,
                title: "Printed year"
              }
            ]
          });

          // 凡例ボタンクリック時のイベント
          listMenu[menuIndex.legend].elm.onclick = function(){
            if (!listMenu[menuIndex.legend].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.legend].elm.classList.add("active-menu");
              view.ui.add(legend, "bottom-right");
              removeOtherUI(view, menuIndex.legend);
            } else {
              listMenu[menuIndex.legend].elm.classList.remove("active-menu");
              view.ui.remove(legend, "bottom-right");
            }
            removeActiveMenu([menuIndex.legend,menuIndex.info,menuIndex.metadata]);
          };

          //////////////////////////////////////////////
          //   2D/3D
          /////////////////////////////////////////////
          // 2D、3Dボタンクリック時のイベント
          listMenu[menuIndex.threed].elm.onclick = function(){
            loaderDiv.classList.add("is-active");
            if (!listMenu[menuIndex.threed].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.threed].elm.classList.add("active-menu");
            } else {
              listMenu[menuIndex.threed].elm.classList.remove("active-menu");
            }
            removeActiveMenu([menuIndex.info,menuIndex.metadata]);
            refreshMenu(view);
            switchView();
          };

          //////////////////////////////////////////////
          //   検索
          /////////////////////////////////////////////
          // 検索ウィジェット
          // 検索画面はフィーチャレイヤーも検索できるようにする
          // 閲覧画面ではジオコーディングのみ
          const sources = [{
            layer: zukakuFeatureLayer,
            searchFields: ["id"],
            displayField: "id",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by ID",
            placeholder: "example: TH008053",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3_en", "title"],
            displayField: "area3_en",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by English Metadata",
            placeholder: "example: Blad 76/XXVIII",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3", "area_name"],
            displayField: "area3",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by Japanese Metadata",
            placeholder: "example: ボルネオ1/10万",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }];
          
          searchWidgetWithSources = new Search({
            view: view,
            sources: sources
          });

          searchWidget = new Search({
            view: view
          });
          

          // 検索ボタンクリック時のイベント
          listMenu[menuIndex.search].elm.onclick = function(){
            if (!listMenu[menuIndex.search].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.search].elm.classList.add("active-menu");
              
              if (view.map === map) {
                view.ui.add(searchWidgetWithSources, "bottom-right");
              } else if (view.map === mapSecond) {
                view.ui.add(searchWidget, "bottom-right");
              }

              removeOtherUI(view, menuIndex.search);
            } else {
              listMenu[menuIndex.search].elm.classList.remove("active-menu");
              if (view.map === map) {
                view.ui.remove(searchWidgetWithSources, "bottom-left");
              } else if (view.map === mapSecond) {
                view.ui.remove(searchWidget, "bottom-left");
              }
            };
            removeActiveMenu([menuIndex.search,menuIndex.info,menuIndex.metadata]);
          };

          // 検索結果の図郭はどの縮尺か分からないため表示されるかは分からない
          searchWidgetWithSources.on("search-complete", function(event){
            const scale_num = event.results[0].results[0].feature.attributes.scale_num;
            if ([1, 2, 3, 4].includes(scale_num)) {
              scaleId = '0';
            } else if ([5, 6, 7].includes(scale_num)) {
              scaleId = '1';
            } else if ([8].includes(scale_num)) {
              scaleId = '2';
            } else if ([9, 10].includes(scale_num)) {
              scaleId = '3';
            } else if ([11].includes(scale_num)) {
              scaleId = '4';
            }
            selectScaleid(scaleId);
          });

          //////////////////////////////////////////////
          //   モーダル
          /////////////////////////////////////////////
          listMenu[menuIndex.info].elm.onclick = function(){
            if (!listMenu[menuIndex.info].elm.classList.contains("active-menu")) {
              listMenu[menuIndex.info].elm.classList.add("active-menu");
              infoModal.classList.add("is-active");
              removeOtherUI(view, -9999);
            } else {
              listMenu[menuIndex.info].elm.classList.remove("active-menu");
              infoModal.classList.remove("is-active");
            }
            removeActiveMenu([menuIndex.info,menuIndex.info,menuIndex.metadata]);
          }; 
        }

        // メニューをクリックした際に他のウィジェットが開いていたら閉じる
        function removeOtherUI (view, index) {

          if (index !== menuIndex.measurement) {
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
          }
          if (index !== menuIndex.basemap) {
            view.ui.remove(basemapGallery, "bottom-left");
          }
          if (index !== menuIndex.search && view.map === map) {
            view.ui.remove(searchWidgetWithSources, "bottom-left");
          };
          if (index !== menuIndex.search && view.map === mapSecond) {
            view.ui.remove(searchWidget, "bottom-left");
          };
          if (index !== menuIndex.legend) {
            view.ui.remove(legend, "bottom-left");
          }

        };

                 
        // メニューボタンをクリックしたときに該当ボタンとinfoとメタデータ以外の見栄えを非アクティブにする
        function removeActiveMenu (indexes) {
          for (let i in listMenu) {
            if (!indexes.includes(Number(i))) {
              listMenu[i].elm.classList.remove("active-menu");
            };
          };
        };

        // メニューボタンの初期化
        function refreshMenu (view) {
          removeActiveMenu([-9999]);
          view.ui.remove(basemapGallery, "bottom-left");
          view.ui.remove(toolbarMeasureDiv, "bottom-left");
          view.ui.remove(measurement, "bottom-right");
          view.ui.remove(legend, "bottom-left");

          if (view.map === map) {
            view.ui.remove(searchWidgetWithSources, "bottom-left");
          } else if (view.map === mapSecond) {
            view.ui.remove(searchWidget, "bottom-left");
          };

          measurement.clear();
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.remove("active");
          closeAttributeDiv();
        }

        // メニューバーの余白をクリックした時
        menuDiv.addEventListener("click", function(event) {
          if (event.target.childElementCount >= 6) {
            refreshMenu(view);
          }
        });


        //////////////////////////////////////////////
        //   メタデータ
        /////////////////////////////////////////////
        // メタデータボタンクリック時のイベント
        const viewDiv = document.getElementById("viewDiv");
        const attributeDiv = document.getElementById("attributeDiv");

        function openAttributeDiv () {
          viewDiv.style.left = "275px";
          attributeDiv.style.display = "block";
        };

        function closeAttributeDiv () {
          viewDiv.style.left = "75px";
          attributeDiv.style.display = "none";
        };

        listMenu[menuIndex.metadata].elm.onclick = function(){
          if (!listMenu[menuIndex.metadata].elm.classList.contains("active-menu")) {
            listMenu[menuIndex.metadata].elm.classList.add("active-menu");
            openAttributeDiv();
          } else {
            listMenu[menuIndex.metadata].elm.classList.remove("active-menu");
            closeAttributeDiv();
          };
        };
        
        //////////////////////////////////////////////
        //   モーダル
        /////////////////////////////////////////////
        // モーダル（初期表示）
        const firstModal= document.getElementById("firstModal");

        // 初回は強制的に表示
        if(localStorage.getItem('flgNotShowAgain') === null) {
          firstModal.classList.add("is-active");
        };

        // 右上の×ボタン
        const closeFirstModal = document.getElementById("closeFirstModal");
        closeFirstModal.onclick = function(){
          if (firstModal.classList.contains("is-active")) {
            firstModal.classList.remove("is-active");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };  

        // 閉じるボタン
        const closeFirstModalBtn = document.getElementById("closeFirstModalBtn");
        closeFirstModalBtn.onclick = function(){
          if (firstModal.classList.contains("is-active")) {
            firstModal.classList.remove("is-active");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };

        // モーダル（info）
        const infoModal = document.getElementById("infoModal");

        // モーダルの右上の×ボタン
        const closeInfoModal = document.getElementById("closeInfoModal");
        closeInfoModal.onclick = function(){
          if (infoModal.classList.contains("is-active")) {
            infoModal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
        };  

        // モーダルの閉じるボタン
        const closeInfoModalBtn = document.getElementById("closeInfoModalBtn");
        closeInfoModalBtn.onclick = function(){
          if (infoModal.classList.contains("is-active")) {
            infoModal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
        };

        
        
        //////////////////////////////////////////////
        //   図郭の縮尺フィルターボタン
        /////////////////////////////////////////////

        // 縮尺のリスト
        const listScale = [
          {'text': "- 1:150K (522)"}, 
          {'text': "1:150K - 1:300K (104)"}, 
          {'text': "1:500K (40)"}, 
          {'text': "1:750K - 1:1M (9)"}, 
          {'text': "1:2.5M (5)"}
        ];

        function addScaleButton (index) {

          // 縮尺ボタンを追加
          for (let i in listScale) {
            listScale[i].elm = document.createElement('button');
            listScale[i].elm.className = "esri-button scale-btn-switch";
            listScale[i].elm.setAttribute("scale-id", i);

            if (i === String(index)) {
              listScale[i].elm.disabled = true;
            }

            listScale[i].elm.innerHTML = listScale[i].text;
            viewDiv.parentNode.insertBefore(listScale[i].elm, viewDiv.nextSibling);
            view.ui.add(listScale[i].elm, "top-left");
          }
        };

        let scaleId = '0';
        view.when(function(){

          addScaleButton(scaleId);

        })

        function selectScaleid (scaleId) {
          if (scaleId) {
            const nodes = document.querySelectorAll(".scale-btn-switch");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const scaleIndex = node.getAttribute("scale-id");
              if (scaleIndex === scaleId) {
                node.disabled = true;
                if (scaleId === '0') {
                  whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;
                  
                } else if (scaleId === '1') {
                  whereClause = defaultWhereClause + " AND scale_num IN (5,6,7)" ;
                  
                } else if (scaleId === '2') {
                  whereClause = defaultWhereClause + " AND scale_num IN (8)" ;
                  
                } else if (scaleId === '3') {
                  whereClause = defaultWhereClause + " AND scale_num IN (9,10)" ;
                  
                } else if (scaleId === '4') {
                  whereClause = defaultWhereClause + " AND scale_num IN (11)" ;
                  
                };
                zukakuLayerView.filter = {
                  where: whereClause
                };
              } else {
                node.disabled = false;
              }
            }
          }
        }

        // 縮尺の切り替え
        document
        .querySelector(".esri-ui-top-left")
        .addEventListener("click", function(event) {
          if (view.map === map) {
            scaleId = event.target.getAttribute("scale-id");
            selectScaleid(scaleId);
          }
        });

        // ローダーの表示を止める
        const loaderDiv = document.getElementById("loaderDiv");
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');

          };
        });

        // マップの中心とズームレベルを取得、外邦図から図郭検索地図に戻る際に使用
        watchUtils.whenTrue(view, "stationary", function() {
          if (view.map === map) {
            if (view.extent) {
              viewZoom = view.zoom;
              viewCenter = view.center;
            };
          };   
        });

        //////////////////////////////////////////////
        //
        //   図郭ポリゴンをクリック→外邦図を閲覧
        //
        /////////////////////////////////////////////

        // ビューをクリック
        function clickView(){
          view.on("click", function(event) {
            if(view.map === map){
              if (measurement.activeWidget) {
                return;
              };
              
              
              refreshMenu(view);
              queryFeaturesClickedPoint(event);
            } else {
              return;
            };
            
          });
        };

        clickView();

        // ポリゴンをクリック
        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          if (view.map === map && !measurement.activeWidget){
            // ビューがmapで、計測ウィジェットがアクティブでないときのみ
            zukakuLayerView.queryFeatures(queryParams)
            .then(queryArcGISOnline)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

        };
        
        const mapSecond = new Map({
        });
        let objArrowBtn = [];

        var appConfig = {
          mapView: null,
          sceneView: null,
          activeView: null,
          container: "viewDiv" // use same container for views
        };


        function createTileView (response) {
          
          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          // メニューボタンの表示、非表示の切り替え
          listMenu[3].elm.style.display = "none";
          listMenu[5].elm.style.display = "block";
          listMenu[6].elm.style.display = "block";
          listMenu[7].elm.style.display = "block";
         

          var initialViewParams = {
            // zoom: 4,
            // center: [118.4985351561923, -2.0326589312043144],
            container: appConfig.container
          };

          // create 2D view and and set active
          appConfig.mapView = view;

          appConfig.mapView.map = mapSecond;

          mapSecond.basemap = map.basemap;

          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);
          tileLayer.opacity = defaultTransparency/100;
          
          // create 3D view, won't initialize until container is set
          initialViewParams.container = null;
          initialViewParams.map = mapSecond;
          
          // マップ
          if (listMenu[6].elm.firstElementChild.classList.contains("esri-icon-globe")) {
            appConfig.sceneView = createView(initialViewParams, "3d", minLOD, maxLOD);
            appConfig.activeView = appConfig.mapView;
            appConfig.activeView.ui.empty("bottom-left");
            appConfig.activeView.ui.empty("top-left");
            appConfig.activeView.constraints = {minZoom: minLOD, maxZoom: maxLOD};
            
            tileLayer.when(function() {
              // ビューの移動
              appConfig.activeView.goTo(tileLayer.fullExtent)
              // 透過度スライダーの追加
              .then(function(){addOpacitySlider(opacityMapDiv, opacityMapSlider, appConfig.activeView)})
              // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
              .then(function(){addAllDirectionBtn2View(appConfig.activeView)});
            });
            
          // シーン
          } else if (listMenu[6].elm.firstElementChild.classList.contains("esri-icon-maps")) {
            
            appConfig.activeView = appConfig.sceneView;
            appConfig.activeView.ui.empty("bottom-left");

            tileLayer.when(function() {
              // シーンの移動
              appConfig.activeView.goTo(tileLayer.fullExtent)
              .then(function(){
                appConfig.activeView.goTo({
                  tilt: viewTilt,
                  heading: viewHeading
                })
              })
              // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
              .then(function(){addAllDirectionBtn2View(appConfig.activeView)});
            });
          }
          
        };



        
        
        let viewTilt = 45;
        let viewHeading = 0;
        // マップとシーンの切り替え
        function switchView() {
          
          const is3D = appConfig.activeView.type === "3d";
          var activeViewpoint = appConfig.activeView.viewpoint.clone();

          // remove the reference to the container for the previous view
          appConfig.activeView.container = null;

          if (is3D) {
            // if the input view is a SceneView, set the viewpoint on the
            // mapView instance. Set the container on the mapView and flag
            // it as the active view
            appConfig.mapView.viewpoint = activeViewpoint;
            appConfig.mapView.container = appConfig.container;
            appConfig.activeView = appConfig.mapView;
            mapSecond.ground = {};

            // 一度３Dにした後、２Dに戻すためには再度透過率スライダーと方位ボタンを追加する必要がある
            view.ui.empty("top-left");
            view.ui.empty("bottom-left");
            addOpacitySlider(opacityMapDiv, opacityMapSlider, view);
            addAllDirectionBtn2View(view);

            clickMenuBtn(view);

            // switchButton.value = "3D";
            listMenu[6].elm.firstElementChild.classList.remove("esri-icon-maps");
            listMenu[6].elm.firstElementChild.classList.add("esri-icon-globe");
            listMenu[6].elm.lastElementChild.innerHTML = "3D";
          } else {
            appConfig.activeView = appConfig.sceneView;
            appConfig.sceneView.viewpoint = activeViewpoint;

            appConfig.sceneView.container = appConfig.container;
            
            mapSecond.ground = {
              layers: [new ExaggeratedElevationLayer3()],
              surfaceColor: [0, 0, 0]
            };

            listMenu[6].elm.firstElementChild.classList.remove("esri-icon-globe");
            listMenu[6].elm.firstElementChild.classList.add("esri-icon-maps");
            listMenu[6].elm.lastElementChild.innerHTML = "2D";

            appConfig.activeView.ui.empty("top-right");
            appConfig.activeView.ui.empty("bottom-left");

            appConfig.activeView.when(function(){
              appConfig.activeView.goTo(activeViewpoint)
              .then(function(){
                appConfig.activeView.goTo({
                  tilt: viewTilt,
                  heading: viewHeading
                })
              })
              // 透過度スライダーの追加
              .then(function(){addOpacitySlider(opacitySceneDiv, opacitySceneSlider, appConfig.activeView)})
              // 高さ倍率ボタンの追加
              .then(function(){addExaggerationButton(appConfig.activeView, exaggerationId)})
              // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
              .then(function(){addAllDirectionBtn2View(appConfig.activeView)})
              // 高さ倍率ボタンクリック時のイベント
              .then(function(){clickExaggerationBtn(appConfig.activeView)})
              .then(function(){
                clickMenuBtn(appConfig.activeView);
              })
              .then(function(){
                watchUtils.whenTrue(appConfig.activeView, "stationary", function() {
                  if (appConfig.activeView.map === mapSecond) {
                    if (appConfig.activeView.extent) {
                      viewTilt = appConfig.activeView.camera.tilt;
                      viewHeading = appConfig.activeView.camera.heading;
                    };
                  };   
                });
              })
            });
            appConfig.activeView.watch('updating', function(evt){
              if(!evt){
                loaderDiv.classList.remove('is-active');
              };
            });            

          }
        }

        // convenience function for creating a 2D or 3D view
        function createView(params, type, minLOD, maxLOD) {
          var tmpView;
          var is2D = type === "2d";
          if (is2D) {
            // tmpView = new MapView(params);        
            tmpView = view;
          } else {
            tmpView = new SceneView(params);
            tmpView.padding = {top: 55};
            tmpView.ui.empty("top-left");
            console.log(maxLOD);
            console.log(minLOD);
            tmpView.constraints = {altitude: {min: maxLOD*1000}};

            tmpView.watch('updating', function(evt){
              if(!evt){
                loaderDiv.classList.remove('is-active');
              };
            });
            
          }
          return tmpView;
        }

        //////////////////////////////////////////////
        //   高さの倍率の切り替えボタン
        /////////////////////////////////////////////

        // 高さ倍率のリスト
        const listExaggeration = [
          {'text': "1x"}, 
          {'text': "3x"}, 
          {'text': "5x"}
        ];

        // 高さ倍率ボタンを追加
        function addExaggerationButton (view, index) {

          for (let i in listExaggeration) {
            listExaggeration[i].elm = document.createElement('button');
            listExaggeration[i].elm.className = "esri-button exaggeration-btn-switch";
            listExaggeration[i].elm.setAttribute("exaggeration-id", i);

            if (i === String(index)) {
              listExaggeration[i].elm.disabled = true;
            }

            listExaggeration[i].elm.innerHTML = listExaggeration[i].text;
            viewDiv.parentNode.insertBefore(listExaggeration[i].elm, viewDiv.nextSibling);
            view.ui.add(listExaggeration[i].elm, "top-right");
          }
        };

        let exaggerationId = '1';

        // 高さ倍率ボタンクリック時のイベント
        function clickExaggerationBtn (view) {
          document
          .querySelector(".esri-ui-top-right")
          .addEventListener("click", function(event) {
            if (view.map === mapSecond) {
              exaggerationId = event.target.getAttribute("exaggeration-id");
              selectExaggerationId(exaggerationId);
            }
          });
        };
        

        function selectExaggerationId (exaggerationId) {
          if (exaggerationId) {
            const nodes = document.querySelectorAll(".exaggeration-btn-switch");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const exaggerationIndex = node.getAttribute("exaggeration-id");
              if (exaggerationIndex === exaggerationId) {
                node.disabled = true;
                if (exaggerationId === '0') {
                  mapSecond.ground = {
                    layers: [new ExaggeratedElevationLayer1()],
                    surfaceColor: [0, 0, 0]
                  };
                } else if (exaggerationId === '1') {
                  mapSecond.ground = {
                    layers: [new ExaggeratedElevationLayer3()],
                    surfaceColor: [0, 0, 0]
                  };
                } else if (exaggerationId === '2') {
                  mapSecond.ground = {
                    layers: [new ExaggeratedElevationLayer5()],
                    surfaceColor: [0, 0, 0]
                  };
                  
                };
                
              } else {
                node.disabled = false;
              }
            }
          }
        }


        let defaultTransparency = 75;
        
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;

        // AGOLから該当するタイルレイヤーを検索
        function queryArcGISOnline(response){

          const featuresQuery = response.features;
          
          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            
            return;

          // タイルレイヤーを検索する
          } else if (length === 1) {
            loaderDiv.classList.add("is-active");

            const feature = response.features[0];

            const id = feature.attributes.id;
            console.log(id);
            northId = feature.attributes.north;
            southId = feature.attributes.south;
            westId = feature.attributes.west;
            eastId = feature.attributes.east;
            
            portal.load().then(function() {
              const queryParams = {
                query: QUERYTXT + id,
                sortField: "numViews",
                sortOrder: "desc",
                num: 20
              };
              portal.queryItems(queryParams).then(addTileLayer);
            });
            return response;
          };
        };
        

        function addTileLayer(response){
          const itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          esriRequest(tileLayerUrl, options)
            
            .then(createTileView);
        };

        const opacityMapSlider = new Slider({
          container: "opacityMapSlider",
          min: 0,
          max: 100,
          steps: 0.1,
          values: [defaultTransparency],
          visibleElements: {
            labels: false,
            rangeLabels: true
          }
        });

        const opacitySceneSlider = new Slider({
          container: "opacitySceneSlider",
          min: 0,
          max: 100,
          steps: 0.1,
          values: [defaultTransparency],
          visibleElements: {
            labels: false,
            rangeLabels: true
          }
        });

        //////////////////////////////////////////////
        //   東西南北ボタン
        /////////////////////////////////////////////

        // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
        function addAllDirectionBtn2View (view) {
          all([createDirectionBtn(northId, "northBtn", "esri-icon-arrow-up-circled", "North"), 
                  createDirectionBtn(southId, "southBtn", "esri-icon-arrow-down-circled", "South"),
                  createDirectionBtn(westId, "westBtn", "esri-icon-arrow-left-circled", "West"),
                  createDirectionBtn(eastId, "eastBtn", "esri-icon-arrow-right-circled", "East")
                  ])
          .then(function(results){
            objArrowBtn = results;
            for (let i in results) {
              
              if (results[i].firstElementChild) {
                view.ui.add(results[i], "bottom-left");
                results[i].addEventListener("click", showNextImage);
              };
            }
          });
        };
        
        function createDirectionBtn (id, attId, classIcon, text) {
          const deferred = new Deferred();
          
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["georeference"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
            .then(function(response){

              const arrowBtn = document.createElement('button');
              // objArrowBtn[text] = document.createElement('button');

              if (response.features.length > 0){
                const feature = response.features[0];

                const georeferenceflg = feature.attributes.georeference;
                // 隣接図郭のサービスはあがっているとは限らない
                if (georeferenceflg === 1) {
                  
                  arrowBtn.setAttribute("id", attId);
                  arrowBtn.setAttribute("data-id", id);
                  arrowBtn.className = "esri-button direction";

                  const arrowIconDiv = document.createElement('div');
                  arrowIconDiv.className = "padding-right-half " + classIcon;
                  arrowIconDiv.setAttribute("data-id", id);
                  arrowBtn.appendChild(arrowIconDiv);

                  arrowBtn.insertAdjacentHTML('beforeend', text);

                }
              }
              deferred.resolve(arrowBtn);

            }).catch(function(error) {
              console.error("query failed: ", error);
            });
          
          return deferred.promise;

        };

        // 方位ボタンをクリックして隣接外邦図を表示
        function showNextImage (event) {

          const id = event.target.dataset.id;
          
          const queryParams = zukakuFeatureLayer.createQuery();
          // set a geometry for querying features by the view's extent
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
          .then(queryArcGISOnline)
          .then(addZukakuAttribute)
          .catch(function(error) {
            console.log(error);
          });
        };

        //////////////////////////////////////////////
        //   透過スライダー
        /////////////////////////////////////////////

        // 透過スライダーを追加
        const opacityMapDiv = document.getElementById("opacityMapDiv");
        const opacitySceneDiv = document.getElementById("opacitySceneDiv");
        
        function addOpacitySlider (opacityDiv, opacitySlider, view) {
          opacityDiv.style.display = "block";
          view.ui.add(opacityDiv, "top-left");

          
          opacitySlider.on(
            ["thumb-change", "thumb-drag"],
            transparencyChanged
          );
          
        };

        function transparencyChanged(event) {
          defaultTransparency = event.value;
          tileLayer.opacity = defaultTransparency/100;
        };

        //////////////////////////////////////////////
        //   メタデータ
        /////////////////////////////////////////////

        const arrayAtt = [
          {"title": "記号", "att": "area3"},
          {"title": "図幅名", "att": "area_name"},
          {"title": "測量機関", "att": "surveyed_by"},
          {"title": "測量時期（修正含む）", "att": "survey_year"},
          {"title": "製版・印刷機関", "att": "printed_by"},
          {"title": "製版時期", "att": "print_year"},
          {"title": "発行時期", "att": "publish_year"},
          {"title": "大きさ", "att": "size"},
          {"title": "色", "att": "color"},
          {"title": "備考", "att": "notes"},
          {"title": "枚数（実物）", "att": "copies"}
        ];

        // 属性情報を追加
        function addZukakuAttribute (response) {

          if (typeof response === 'undefined') {
            return;
          }

          const feature = response.features[0];

          
          attributeDiv.innerHTML = "";

          const divArea3_en = document.createElement("div");
          const attArea3_en = feature.attributes.area3_en;
          divArea3_en.className = "padding-leader-half font-size--1";
          divArea3_en.innerHTML = attArea3_en;
          attributeDiv.appendChild(divArea3_en);

          const divTitle = document.createElement("div");
          const attTitle = feature.attributes.title;
          divTitle.className = "font-size--1";
          divTitle.innerHTML = attTitle;
          attributeDiv.appendChild(divTitle);

          const divScale = document.createElement("div");
          const attScale = feature.attributes.scale;
          divScale.className = "padding-leader-half font-size--1";
          divScale.innerHTML = attScale;
          attributeDiv.appendChild(divScale);

          const divPrintedYear = document.createElement("div");
          const attPrintedYear = feature.attributes.print_year_en;
          divPrintedYear.className = "padding-leader-half font-size--1";
          divPrintedYear.innerHTML = "Printed in " + attPrintedYear;
          attributeDiv.appendChild(divPrintedYear);

          const divSize = document.createElement("div");
          const attSize = feature.attributes.height_width;
          divSize.className = "padding-leader-half font-size--1";
          divSize.innerHTML = attSize + " (cm)";
          if (attSize !== "-"){
            attributeDiv.appendChild(divSize);
          }

          const divId = document.createElement("div");
          const attId = feature.attributes.id;
          divId.className = "padding-leader-half font-size--1";
          divId.innerHTML = attId;
          attributeDiv.appendChild(divId);
          

          const details = document.createElement("details");
          details.className = "padding-leader-half font-size--1";
          attributeDiv.appendChild(details);

          const summary = document.createElement("summary");
          summary.innerHTML = "Details in Japanese";
          details.appendChild(summary);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            const attribute = document.createElement("div");
            attribute.className = "padding-leader-half padding-left-half font-size--1";
            details.appendChild(attribute);
            
            const title = document.createElement("div");
            attribute.appendChild(title);
            title.style.color = "gray";
            title.innerHTML = arrayAtt[i]["title"];

            const value = document.createElement("div");
            attribute.appendChild(value);
            
            value.innerHTML = attValue;
          };
        };

        //////////////////////////////////////////////
        //   閲覧画面から検索画面に戻る
        /////////////////////////////////////////////
        listMenu[7].elm.onclick = function(){

          loaderDiv.classList.add('is-active');

          view = new MapView({
            container: "viewDiv",
            map: map,
            padding: {
              top: 55
            }
          });

          // 背景図をセットする
          map.basemap = mapSecond.basemap;

          // メニューボタンの初期化
          mapSecond.ground = {};
          listMenu[6].elm.firstElementChild.classList.remove("esri-icon-maps");
          listMenu[6].elm.firstElementChild.classList.add("esri-icon-globe");
          listMenu[6].elm.lastElementChild.innerHTML = "3D";
          refreshMenu(view);

          // メニューボタンの表示、非表示の切り替え
          listMenu[3].elm.style.display = "block";
          listMenu[5].elm.style.display = "none";
          listMenu[6].elm.style.display = "none";
          listMenu[7].elm.style.display = "none";

          // 透過スライダーを非表示にする
          opacityMapDiv.style.display = "none";
          opacitySceneDiv.style.display = "none";

          // 左上のUIを全て削除する
          view.ui.empty("top-left");

          // 縮尺ボタンを追加する
          addScaleButton(scaleId);

          // 縮尺制限を解除する
          view.constraints = {minZoom: 0, maxZoom: 23};

          clickView();
          clickMenuBtn(view);

          view.on("layerview-create", function(event) {
            // The event contains the layer and its layer view that has just been
            // created. Here we check for the creation of a layer view for a layer with
            // a specific id, and log the layer view
            if (event.layer.title === "図郭") {
              // The LayerView for the desired layer
              zukakuLayerView = event.layerView;
              zukakuLayerView.filter = {
                where: whereClause
              };
            };
          });

          watchUtils.whenOnce(view, "ready")
          .then(function(){
            view.goTo({
              target: viewCenter,
              zoom: viewZoom
            });
          });

          

          view.watch('updating', function(evt){
            if(!evt){
              loaderDiv.classList.remove('is-active');
            };
          });

          // 縮尺の切り替え
          document
          .querySelector(".esri-ui-top-left")
          .addEventListener("click", function(event) {
            if (view.map === map) {
              scaleId = event.target.getAttribute("scale-id");
              selectScaleid(scaleId);
            }
          });

        };
        
      });
    </script>
  </head>

  <body>
    
    <div class="wrapper">

      <div class="js-modal modal-overlay" data-modal="foo" id="firstModal">
        <div class="modal-content column-20" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeFirstModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>Gaihozu Viewer : Indonesian-territory version (GV-I)</h3>
          <p>Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands made by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS Online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
          <p>Clicking a shaded box on the index map enable you to show the corresponding geo-referenced map with its metadata, such as map scale and printed year. Clicking a button of ratio like 1:500K switched the index map of the corresponding map scale (e.g. 1:500K means 1 / 500,000 map scale).</p>
          <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a> maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University.</p>
          <p>Copyright (C) 2020-  Human Geography Research Group at Tohoku University (Environmental Geography Lab at the Graduate School of Environmental Studies and the Institute of Geography, the Graduate School of Science, Tohoku University)</p>
          <p>Project team members: Nakaya, T., Nagata, S., Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
          <img src="./img/Toh_E_S_N_RGB.gif" height="50px" width="50px">
          <div class="right">
            <fieldset class="fieldset-checkbox padding-right-2">
              <label><input type="checkbox" id="notShowAgainChk">Don't show this message again.</label>
            </fieldset>
            <button class="btn js-modal-toggle" id="closeFirstModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div class="js-modal modal-overlay" data-modal="foo" id="infoModal">
        <div class="modal-content column-20" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeInfoModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>Gaihozu Viewer : Indonesian-territory version (GV-I)</h3>
          <p>Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands made by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS Online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
          <p>Clicking a shaded box on the index map enable you to show the corresponding geo-referenced map with its metadata, such as map scale and printed year. Clicking a button of ratio like 1:500K switched the index map of the corresponding map scale (e.g. 1:500K means 1 / 500,000 map scale).</p>
          <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a> maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University.</p>
          <p>Special thanks to Dr. Fatwa Ramdani (Brawijaya University, Indonesia) for his valuable comments to the earlier version of this project site and <a href="https://www.wingfield.gr.jp/" target="_blank">Mr. Kohsuke Hada</a> for his help on the identification of old map datum. This project was financially supported by JSPS KAKENHI 16H01965 (PI: Prof Keiji Yano).</p>
          <p>Copyright (C) 2020-  Human Geography Research Group at Tohoku University (Environmental Geography Lab at the Graduate School of Environmental Studies and the Institute of Geography, the Graduate School of Science, Tohoku University)</p>
          <p>Project team members: Nakaya, T., Nagata, S., Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
          <img src="./img/Toh_E_S_N_RGB.gif" height="50px" width="50px">
          <div class="right">
            <button class="btn js-modal-toggle" id="closeInfoModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div id="titleDiv" class="esri-widget">
        
        <a class="top-nav-title margin-left-1">
          
          Gaihozu Viewer
          <span class="tablet-hide phone-hide"> : Indonesian-territory version (GV-I)</span>
          
        </a>
        <img src="./img/Toh_E_S_N_G.gif" height="50px" width="50px">
      </div>
      
      <div id="viewDiv"></div>

      <div id="opacityMapDiv" class="esri-widget padding-leader-half padding-trailer-half padding-left-half padding-right-half">
        <div class="padding-trailer-half">Opacity</div>
        <div id="opacityMapSlider" class="slider"></div>
      </div>
      <div id="opacitySceneDiv" class="esri-widget padding-leader-half padding-trailer-half padding-left-half padding-right-half">
        <div class="padding-trailer-half">Opacity</div>
        <div id="opacitySceneSlider" class="slider"></div>
      </div>

      <div class="loader is-active" id="loaderDiv">
        <div class="loader-bars"></div>
        <!-- <div class="loader-text">Loading...</div> -->
      </div>


      <div id="menuDiv" class="text-center"></div>

      <div id="attributeDiv"></div>

    </div>
  </body>
</html>
