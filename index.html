<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=UA-174938863-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-174938863-1');
    </script> -->

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      #viewDiv {
        /* position: absolute; */
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        height: 100%;
      }
      #divHeader{
        display: flex;
        position: relative;
        height: 56px;
      }
      #buttonInfo {
        position: absolute;
        right: 60px; 
      }
      #imgTohoku {
        position: absolute;
        /* width: 60px;
        height: 60px; */
        right: 0; 
      }
      #headerTitle{
        padding-left: 30px;
      }
      /* #actionGroup3D{
        display: none;
      } */
      #legendDiv{
        padding: 10px;
      }
      .legendbutton{
        margin-bottom: 10px;
      }
      #loaderDiv{
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 9998;
      }
      /* .esri-search {
        width: none !important;
      } */
    </style>
    <link rel="stylesheet" href="https://js.arcgis.com/4.19/esri/themes/light/main.css"/>
    
    <link rel="stylesheet" type="text/css" href="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.css" />
    <script type="module" src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.esm.js"></script>
    <script nomodule="" src="https://jsdev.arcgis.com/calcite-components/1.0.0-beta.54/calcite.js"></script>

    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.19/"></script>
    <script>
      require([
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/Map",
        "esri/widgets/Search",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement",
        "esri/widgets/DistanceMeasurement2D",
        "esri/widgets/AreaMeasurement2D",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
        "dojo/Deferred",
        "dojo/promise/all",
        "esri/views/SceneView",
        "esri/layers/ElevationLayer",
        "esri/layers/BaseElevationLayer",
        "esri/widgets/Home",
        "esri/widgets/Compass",
        "esri/Viewpoint",
        "esri/widgets/LayerList",
        // "esri/widgets/Zoom",
        "dojo/domReady!"
      ], function(
        MapView, 
        FeatureLayer,
        Map,
        Search,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement,
        DistanceMeasurement2D,
        AreaMeasurement2D,
        BasemapGallery,
        PortalBasemapsSource,
        Deferred,
        all,
        SceneView,
        ElevationLayer,
        BaseElevationLayer,
        Home,
        Compass,
        Viewpoint,
        // Zoom,
        LayerList
      ) {

        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const QUERYTXT = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";
        const PADDINGTOP = 56;



        const actionBar = document.getElementById("actionBar");
        const showAllBtn = document.createElement("calcite-button");
        const primaryPanel = document.getElementById("primaryPanel");

        //////////////////////////////////////////////
        //   図郭検索画面
        /////////////////////////////////////////////
        // マップ 
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-relief-vector'
          
        });

        let view = new MapView({
          container: "viewDiv",
          map: map
        });

        view.ui.move("zoom", "top-right");
        let homeBtn2D = new Home({});
        view.ui.add(homeBtn2D, "top-right");

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        // const hoge = document.getElementById("hogehoge");
        // view.ui.add(hoge, "top-left");

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let scaleWhereclause = " AND scale_num IN (1,2,3,4)";
        let whereClause = defaultWhereClause + scaleWhereclause;
        let yearWhereclause = " AND 1=1";
        let lstYear = ['1939', '1940', '1941', '1942', '1943', '1944'];
        const defaultYear = ['1939', '1940', '1941', '1942', '1943', '1944'];
        let lstFeatureCntByYear;
        let orgLstYear;
        let lenValidYear;
        let startExtent;
        let compassWidget;
        
        
        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {
          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };
          
          goToFeatureLayerViewExtent();
          
          
        });

        // フィーチャレイヤーのエクステントに移動
        function goToFeatureLayerViewExtent () {
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.where = whereClause;
          zukakuFeatureLayer.queryExtent(queryParams).then(function(results){
            startExtent = results.extent;
            view.goTo(startExtent);
            view.extent = startExtent;
            // ホームウィジェットの範囲を設定
            homeBtn2D.view = view;

            compassWidget = new Compass({
              view: view
            });
            view.ui.add(compassWidget, "top-right");
          });
        }

        //////////////////////////////////////////////
        //   Calcite Flow 削除
        /////////////////////////////////////////////

        function deleteCalciteFlow(id){
          if (document.getElementById(id)) {
            document.getElementById(id).remove();
          }
        };

        function deleteAllExistedCalciteFlow(){
          deleteCalciteFlow('legendCalciteFlow');
          deleteCalciteFlow('scaleCalciteFlow');
          deleteCalciteFlow('measurementCalciteFlow');
          deleteCalciteFlow('basemapCalciteFlow');
          deleteCalciteFlow('searchCalciteFlow');
          deleteCalciteFlow("opacityCalciteFlow");
          deleteCalciteFlow("exaggerationCalciteFlow");
          deleteCalciteFlow("adjacentCalciteFlow");
          deleteCalciteFlow("metadataCalciteFlow");
          deleteCalciteFlow("agoCalciteFlow");
          deleteCalciteFlow("copyTileCalciteFlow");
        };

        //////////////////////////////////////////////
        //   Action 表示、非表示
        /////////////////////////////////////////////

        const actionGroup = document.getElementById("actionGroup");

        const backAction = document.getElementById("backAction");
        const imageSettingsAction = document.getElementById("imageSettingsAction");
        const metadataAction = document.getElementById("metadataAction");
        // const mapSceneAction = document.getElementById("mapSceneAction");
        const agoAction = document.getElementById("agoAction");
        const basemapAction = document.getElementById("basemapAction");
        const FilterAction = document.getElementById("filterAction");
        const measurementAction = document.getElementById("measurementAction");
        const searchAction = document.getElementById("searchAction");

        function setDisplayActionItemsFirst(){
          backAction.style.display = "none";
          imageSettingsAction.style.display = "none";
          metadataAction.style.display = "none";
          // mapSceneAction.style.display = "none";
          agoAction.style.display = "none";
          basemapAction.style.display = "block";
          FilterAction.style.display = "block";
          measurementAction.style.display = "block";
          searchAction.style.display = "block";
        };
        setDisplayActionItemsFirst();
        
        function setDisplayActionItemsSecond(){
          backAction.style.display = "block";
          imageSettingsAction.style.display = "block";
          metadataAction.style.display = "block";
          // mapSceneAction.style.display = "block";
          agoAction.style.display = "block";
          basemapAction.style.display = "block";
          FilterAction.style.display = "none";
          measurementAction.style.display = "block";
          searchAction.style.display = "block";
        };

        // すべてのActionItemのActive状態を解除
        function resetActiveActionItems(){
          backAction.removeAttribute("active");
          imageSettingsAction.removeAttribute("active");
          metadataAction.removeAttribute("active");
          // mapSceneAction.removeAttribute("active");
          agoAction.removeAttribute("active");
          basemapAction.removeAttribute("active");
          FilterAction.removeAttribute("active");
          measurementAction.removeAttribute("active");
          searchAction.removeAttribute("active");
          // 計測ウィジェットを初期化
          if (activeWidget) {
            // measurementDiv.innerHTML='';
            activeWidget.destroy();
            activeWidget = null;
          }
        };
        

        //////////////////////////////////////////////
        //   Filter（縮尺）
        /////////////////////////////////////////////

        // 縮尺のリスト
        const listScale = [
          {'text': "- 1:150,000 ()", 'whereClause': 'scale_num IN (1,2,3,4)'}, 
          {'text': "1:200,000 - 1:300,000 ()", 'whereClause': 'scale_num IN (5,6,7)'}, 
          {'text': "1:500,000 ()", 'whereClause': 'scale_num IN (8)'}, 
          {'text': "1:750,000 - 1:1,000,000 ()", 'whereClause': 'scale_num IN (9,10)'}, 
          {'text': "1:2,500,000 ()", 'whereClause': 'scale_num IN (11)'}
        ];

        let scaleId = '0';
        

        // 縮尺ごとのフィーチャ数を取得してボタンの文字列に反映させる
        
        function addCount2BtnTxt() {
          // https://t-salad.com/node-for-asynchronous/
          const tasks = [];
          for (let i=0; i<listScale.length; i++) {
            tasks.push(
              getCountByScale(listScale[i].whereClause)
            );
          };
          Promise.all(tasks).then(function(results){
            
            for (let i = 0; i < results.length; i++) {
              listScale[i].text = listScale[i].text.replace('()', '(' + results[i] + ')');
            }      
            
            view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {
              addScaleButton(scaleId);
            });

          });
        };
        addCount2BtnTxt();
        
        // const addCount2BtnTxt = (function () {
        //   // https://t-salad.com/node-for-asynchronous/
        //   const tasks = [];
        //   for (let i=0; i<listScale.length; i++) {
        //     tasks.push(
        //       getCountByScale(listScale[i].whereClause)
        //     );
        //   };
        //   Promise.all(tasks).then(function(results){
            
        //     for (let i = 0; i < results.length; i++) {
        //       listScale[i].text = listScale[i].text.replace('()', '(' + results[i] + ')');
        //     }      
            
        //     view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {
        //       addScaleButton(scaleId);
        //     });

        //   });
        // })();

        FilterAction.addEventListener("click", function(event) {
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          FilterAction.setAttribute("active", null);

          addCount2BtnTxt();
        });

        // 縮尺ごとのフィーチャ数を取得するクエリ
        function getCountByScale(whereClause){
          return new Promise(function(resolve, reject){
            const queryScaleParams = zukakuFeatureLayer.createQuery();
            queryScaleParams.where = defaultWhereClause + " AND " + whereClause;
            zukakuFeatureLayer.queryFeatureCount(queryScaleParams).then(function(result){
              resolve(result);
            });
          });
        };

        // 縮尺ボタンを追加
        function addScaleButton (index) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();
          
          // 縮尺
          const scaleCalciteFlow = document.createElement("calcite-flow");
          scaleCalciteFlow.setAttribute('id', 'scaleCalciteFlow');

          const scaleCalcitePanel = document.createElement("calcite-panel");
          scaleCalcitePanel.setAttribute("heading", "Scale");
          scaleCalciteFlow.appendChild(scaleCalcitePanel);

          const scaleRadioGroup = document.createElement("calcite-radio-group");
          scaleRadioGroup.setAttribute("layout", "vertical");
          scaleRadioGroup.setAttribute("width", "full");
          scaleRadioGroup.setAttribute("scale", "m");

          scaleCalcitePanel.appendChild(scaleRadioGroup);

          for (let i in listScale) {
            listScale[i].elm = document.createElement('calcite-radio-group-item');
            listScale[i].elm.setAttribute("value", i);

            if (i === String(index)) {
              listScale[i].elm.checked = true;
            }

            listScale[i].elm.innerHTML = listScale[i].text;
            scaleRadioGroup.appendChild(listScale[i].elm);
          };
          primaryPanel.appendChild(scaleCalciteFlow);

          queryByAllYears();

          scaleRadioGroup.addEventListener('calciteRadioGroupChange', selectScaleid);

        };

        // 縮尺ボタンクリック時の動作
        function selectScaleid (event) {

          if (!event) {
            return;
          } else {
            scaleId = event.detail;
          }
          
          if (scaleId === '0') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '1') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '2') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '3') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          } else if (scaleId === '4') {
            scaleWhereclause = " AND " + listScale[scaleId].whereClause;
            
          };
                
          whereClause = defaultWhereClause + scaleWhereclause;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // 出版年のリストを初期化
          lstYear = [];
          for (let i=0; i<defaultYear.length; i++) {
            lstYear.push(defaultYear[i]);
          };
          // レイヤーリストウィジェットを更新
          queryByAllYears();

        }
       

        //////////////////////////////////////////////
        //   凡例
        /////////////////////////////////////////////
        
        // promise.allで各出版年ごとの結果を受け取る
        function queryByAllYears () {
          // https://t-salad.com/node-for-asynchronous/
          const tasks = [];
          
          // 出版年のリストを初期化
          lstYear = [];
          for (let i=0; i<defaultYear.length; i++) {
            lstYear.push(defaultYear[i]);
          };


          for (let i=0; i<lstYear.length; i++) {
            tasks.push(
              queryByYear(lstYear[i])
            );
          };
          Promise.all(tasks).then(function(results){

            var indices = [];
            var idx = results.indexOf(0);
            while (idx != -1) {
              indices.push(idx);
              idx = results.indexOf(0, idx + 1);
            }
            for (var i = indices.length - 1; i >= 0 ; i--){
              lstYear.splice(indices[i], 1);
            }
            lenValidYear = lstYear.length;
            orgLstYear = [];
            for (let i=0; i<lenValidYear; i++) {
              orgLstYear.push(lstYear[i]);
            };
            lstFeatureCntByYear = results;

            // console.log(results); [0, 24, 0, 42, 423, 33] 出版年ごとのフィーチャ数
            // console.log(indices); [0, 2] フィーチャ数が0のインデックス
            // console.log(lstYear); ["1940", "1942", "1943", "1944"] フィーチャが存在する出版年
            // console.log(lenValidYear); 4 フィーチャが存在する出版年の数、show allボタンの活性化に使用
            // console.log(orgLstYear); ["1940", "1942", "1943", "1944"] show allボタンで戻す際に使用、参照渡しではなく値渡し

            addLegendYear();            
            
          });
        };

        // 出版年ごとにフィーチャ数をクエリ
        function queryByYear (year) {
          return new Promise(function(resolve, reject){
            const queryYearParams = zukakuFeatureLayer.createQuery();
            queryYearParams.where = whereClause + " AND print_year_en IN (" + year + ")";
            zukakuFeatureLayer.queryFeatureCount(queryYearParams).then(function(result){
              resolve(result);
            });
          });
        }
        
        // 出版年のリストからwhere句を作成
        function createYearWhereClause (lst) {
          yearWhereclause = " AND print_year_en IN ("
          for (var i=0; i<lst.length; i++) {
            if (i === 0) {
              yearWhereclause += lst[i];
            } else {
              yearWhereclause += ("," + lst[i]);
            }
          }
          yearWhereclause += ")";
        };
          
        // 凡例を作成
        function addLegendYear () {
          
          // フィーチャレイヤーの個別値を取得
          const uniqueValueInfos = zukakuFeatureLayer.renderer.uniqueValueInfos;

          deleteCalciteFlow('legendCalciteFlow');

          const legendCalciteFlow = document.createElement("calcite-flow");
          legendCalciteFlow.setAttribute('id', 'legendCalciteFlow');
          
          const printedYearCalcitePanel = document.createElement("calcite-panel");
          printedYearCalcitePanel.setAttribute("heading", "Printed Year");
          legendCalciteFlow.appendChild(printedYearCalcitePanel);

          const legendDiv = document.createElement("div");
          legendDiv.setAttribute("id", "legendDiv");
          printedYearCalcitePanel.appendChild(legendDiv);

          // show all ボタン
          showAllBtn.className = "legendbutton";
          showAllBtn.setAttribute("width", "full");
          showAllBtn.setAttribute("disabled", "true");
          showAllBtn.setAttribute("scale", "s");
          showAllBtn.innerHTML = "Show all";
          legendDiv.appendChild(showAllBtn);

          for (var i=0; i<uniqueValueInfos.length; i++) {
            const button = document.createElement("calcite-button");
            button.className = "legendbutton legendYearButton";
            button.setAttribute("width", "full");
            button.setAttribute("scale", "s");
            button.setAttribute("appearance", "outline");
            button.setAttribute("year-id", uniqueValueInfos[i].label);
            // console.log(uniqueValueInfos[i]);

            const buttonStyle = document.createElement("div");
            buttonStyle.style.opacity = 0.51;
            buttonStyle.style.marginRight = "10px";
            button.appendChild(buttonStyle);

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
            svg.setAttribute("width", "16");
            svg.setAttribute("height", "16");
            buttonStyle.appendChild(svg);

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttributeNS(null, "transform", "matrix(1.0909091234207153,0,0,1.0909091234207153,12,12)");
            svg.appendChild(g);

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttributeNS(null, "fill", "rgba(" + uniqueValueInfos[i].symbol.color.r + ", " + uniqueValueInfos[i].symbol.color.g + ", " + uniqueValueInfos[i].symbol.color.b + ", " + uniqueValueInfos[i].symbol.color.a + ")");
            path.setAttributeNS(null, "fill-rule", "evenodd");
            path.setAttributeNS(null, "stroke", "rgba(255, 255, 255, 0.25098039215686274)");
            path.setAttributeNS(null, "stroke-width", "2");
            path.setAttributeNS(null, "stroke-linecap", "round");
            path.setAttributeNS(null, "stroke-linejoin", "round");
            path.setAttributeNS(null, "stroke-dasharray", "none");
            path.setAttributeNS(null, "stroke-miterlimit", "4");
            path.setAttributeNS(null, "d", "M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 Z");
            g.appendChild(path);

            const year = document.createElement("div");
            year.innerHTML = uniqueValueInfos[i].label;
            button.appendChild(year);

            legendDiv.appendChild(button);
          }

          primaryPanel.appendChild(legendCalciteFlow);

          showPrintedYearOnLegend();

          // 縮尺ボタン押下時、凡例ボタンがアクティブな場合はレイヤーリストウィジェットを開いたままにしておく
          // if (listMenu[menuIndex.legend].elm.classList.contains("active-menu")) {
          //   layerlistDiv.style.display = "block";
          // }

          // 各出版年ボタンクリック時の動作
          document
          .querySelector("#legendDiv")
          .addEventListener("click", function(event) {
            let target = event.target;
            
            // 対象外の出版年のボタンをクリックしても何もおこらない
            if (target.hasAttribute("id")) {
              return;
            };

            // ボタンのどこをクリックしても動作するようにcalcite-buttonまで移動する
            while (target){
              if (target.nodeName == "CALCITE-BUTTON") {
                break;
              }
              target = target.parentNode;  
            }

            // Show allボタンをクリックしたときも何も起こらない
            if (!target.hasAttribute("year-id")) {
              return;
            };

            if (view.map === map) {
              yearId = target.attributes.getNamedItem('year-id').value;
              selectYearid(yearId);
            }
          });

          // show allボタンクリック時の動作
          showAllBtn.addEventListener("click", function(event) {
            showAllYear();
          });         

        };

        // show allボタンクリック時の動作
        function showAllYear(){

          showAllBtn.setAttribute("disabled", null);
          // showAllBtn.setAttribute("appearance", "clear");

          // lstYearをデフォルト値に戻す
          lstYear = [];
          for (let i=0; i<orgLstYear.length; i++) {
            lstYear.push(orgLstYear[i]);
          };

          showPrintedYearOnLegend();

          createYearWhereClause(lstYear);
                
          whereClause = defaultWhereClause + scaleWhereclause + yearWhereclause;
          zukakuLayerView.filter = {
            where: whereClause
          };
        };

        // 出版年のボタンクリック時の動作
        function selectYearid (yearId) {
          if (yearId) {
            const nodes = document.querySelectorAll(".legendYearButton");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const yearIndex = node.getAttribute("year-id");

              if (yearIndex === yearId && !node.hasAttribute('disabled')) {
                if (node.getAttribute("color") === "blue") {
                  // node.firstElementChild.firstElementChild.style.setProperty('display', 'none', 'important');
                  node.setAttribute("color", "neutral");
                  // lstYearから該当の出版年を削除
                  const index = lstYear.indexOf(yearId);
                  lstYear.splice(index, 1);
                  
                } else if (node.getAttribute("color") === "neutral") {
                
                  node.setAttribute("color", "blue");
                  // node.firstElementChild.firstElementChild.style.setProperty('display', 'flex', 'important');
                  // lstYearに該当の出版年を追加
                  lstYear.push(yearId);
                } 
                
              }
            }

            createYearWhereClause(lstYear);
                
            whereClause = defaultWhereClause + scaleWhereclause + yearWhereclause;
            zukakuLayerView.filter = {
              where: whereClause
            };

            setStatusShowAllBtn();
            
          }
        }

        // show allボタンの状態を変える
        function setStatusShowAllBtn () {
          if (lenValidYear !== lstYear.length) {
            showAllBtn.removeAttribute("disabled");
            // showAllBtn.setAttribute("appearance", "solid");
          } else if (lenValidYear === lstYear.length) {
            showAllBtn.setAttribute("disabled", "true");
            // showAllBtn.setAttribute("appearance", "clear");
          };
        }

        // 選択された縮尺に出版年のフィーチャにあるかないかを、ボタンの状態に反映させる
        function showPrintedYearOnLegend () {
          
          const nodes = document.querySelectorAll(".legendYearButton");
          // console.log(lstFeatureCntByYear);
          for (var idx = 0; idx < nodes.length; idx++) {
          
            const node = nodes[idx];
            const yearIndex = node.getAttribute("year-id");
            
            if (lstFeatureCntByYear[idx] === 0) {
              
              node.setAttribute("disabled", "true");
              node.setAttribute("color", "neutral");

            } else {
              
              node.lastElementChild.innerHTML = yearIndex + " (" + lstFeatureCntByYear[idx] + ")";
              node.removeAttribute("disabled");

              if (lstYear.indexOf(yearIndex) > -1) {
              
                node.setAttribute("color", "blue");
              
              } else {
              
                node.setAttribute("color", "neutral");
              
              }
            }
          };
        };

        

        //////////////////////////////////////////////
        //   背景
        /////////////////////////////////////////////
        
        let basemapGallery;

        basemapAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          basemapAction.setAttribute("active", null);
          
          const basemapCalciteFlow = document.createElement("calcite-flow");
          basemapCalciteFlow.setAttribute('id', 'basemapCalciteFlow');

          const basemapCalcitePanel = document.createElement("calcite-panel");
          basemapCalcitePanel.setAttribute("heading", "Basemap");
          basemapCalciteFlow.appendChild(basemapCalcitePanel);

          const basemapDiv = document.createElement("div");
          basemapDiv.setAttribute("id", "basemapDiv");
          basemapCalcitePanel.appendChild(basemapDiv);

          const portalSource = new PortalBasemapsSource({  
            query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
          });

          basemapGallery = new BasemapGallery({       
            view: view,     
            container: basemapDiv,       
            source: portalSource
          }); 

          primaryPanel.appendChild(basemapCalciteFlow);

        });

        //////////////////////////////////////////////
        //   計測
        /////////////////////////////////////////////

        let activeWidget = null;

        
        measurementAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          measurementAction.setAttribute("active", null);

          const measurementCalciteFlow = document.createElement("calcite-flow");
          measurementCalciteFlow.setAttribute('id', 'measurementCalciteFlow');

          const measurementCalcitePanel = document.createElement("calcite-panel");
          measurementCalcitePanel.setAttribute("heading", "Measurement");
          measurementCalcitePanel.setAttribute("id", "measurementCalcitePanel");
          measurementCalciteFlow.appendChild(measurementCalcitePanel);

          const measurementRadioGroup = document.createElement("calcite-radio-group");
          measurementRadioGroup.setAttribute("width", "full");
          measurementCalcitePanel.appendChild(measurementRadioGroup);

          const measureDistance = document.createElement("calcite-radio-group-item");
          measureDistance.setAttribute("value", "distance");
          measureDistance.setAttribute("checked", null);
          measureDistance.innerHTML = "Distance";
          measurementRadioGroup.appendChild(measureDistance);
           
          const measureArea = document.createElement("calcite-radio-group-item");
          measureArea.setAttribute("value", "area");
          measureArea.innerHTML = "Area";
          measurementRadioGroup.appendChild(measureArea);

          // const measurementDiv = document.createElement("div");
          // measurementDiv.setAttribute("id", "measurementDiv");
          // measurementCalcitePanel.appendChild(measurementDiv);

          primaryPanel.appendChild(measurementCalciteFlow);

          setActiveWidget("distance");

          measureArea.addEventListener("click", function(event) {
            setActiveWidget(null);
            setActiveWidget("area");
          });

          measureDistance.addEventListener("click", function(event) {
            setActiveWidget(null);
            setActiveWidget("distance");
          });

        });

        function setActiveWidget(type) {

          const measurementCalcitePanel = document.getElementById("measurementCalcitePanel");

          const measurementDiv = document.createElement("div");
          measurementDiv.setAttribute("id", "measurementDiv");
          measurementCalcitePanel.appendChild(measurementDiv);

          switch (type) {
            case "distance":
              activeWidget = new DistanceMeasurement2D({
                view: view,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              break;
            case "area":
              activeWidget = new AreaMeasurement2D({
                view: view,
                container: measurementDiv
              });

              // skip the initial 'new measurement' button
              activeWidget.viewModel.start();

              // view.ui.add(activeWidget, "top-right");
              // setActiveButton(document.getElementById("areaButton"));
              break;
            case null:
              if (activeWidget) {
                // measurementDiv.innerHTML='';
                activeWidget.destroy();
                activeWidget = null;
              }
              break;
          }
        };

        //////////////////////////////////////////////
        //   検索
        /////////////////////////////////////////////

        const sources = [{
            layer: zukakuFeatureLayer,
            searchFields: ["id"],
            displayField: "id",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by ID",
            placeholder: "example: TH008053",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3_en", "title"],
            displayField: "area3_en",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by English Metadata",
            placeholder: "example: Blad 76/XXVIII",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }, {
            layer: zukakuFeatureLayer,
            searchFields: ["area3", "area_name"],
            displayField: "area3",
            exactMatch: false,
            outFields: ["*"],
            name: "Search by Japanese Metadata",
            placeholder: "example: ボルネオ1/10万",
            maxResults: 6,
            maxSuggestions: 6,
            suggestionsEnabled: true,
            minSuggestCharacters: 0
          }];

        
        searchAction.addEventListener("click", function(event) {

          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          searchAction.setAttribute("active", null);

          const searchCalciteFlow = document.createElement("calcite-flow");
          searchCalciteFlow.setAttribute('id', 'searchCalciteFlow');

          // const div = document.createElement("div");
          // div.setAttribute("slot", "header-content");
          // div.innerHTML = "aaaaaaaa";

          const searchCalcitePanel = document.createElement("calcite-panel");
          searchCalcitePanel.setAttribute("heading", "Search");
          searchCalcitePanel.setAttribute("summary", "hogehoge");
          searchCalcitePanel.setAttribute("id", "searchCalcitePanel");
          searchCalciteFlow.appendChild(searchCalcitePanel);

          primaryPanel.appendChild(searchCalciteFlow);

          const geocodingDiv = document.createElement("div");
          geocodingDiv.style.height = "500px";
          geocodingDiv.style.display = "table-cell";
          geocodingDiv.style.verticalAlign = "top";
          // geocodingDiv.style.background = "#2b2b2b";
          geocodingDiv.style.background = "white";
          geocodingDiv.style.width = "100%";
          searchCalcitePanel.appendChild(geocodingDiv);

          const geocodingSearchWidget = new Search({
            view: view,
            container: geocodingDiv,
            sources: sources
          });
          

          // const inline = document.createElement("calcite-input");
          // // inline.setAttribute("controls", "true");
          // // inline.setAttribute("editing-enabled", "true");  
          // const geocodingSearchWidget = new Search({
          //   view: view,
          //   container: inline
          // });
          // searchCalcitePanel.appendChild(inline);


          

        });

        //////////////////////////////////////////////
        //
        //   図郭ポリゴンをクリック→外邦図を閲覧
        //
        /////////////////////////////////////////////

        // ビューをクリック
        function clickView(){
          view.on("click", function(event) {
            if(view.map === map){
              if (activeWidget) {
                return;
              };
              // refreshMenu(view);
              queryFeaturesClickedPoint(event);
            } else {
              return;
            };
            
          });
        };

        clickView();

        // ポリゴンをクリック
        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          if (view.map === map && !activeWidget){
            // if (view.map === map){
            // ビューがmapで、計測ウィジェットがアクティブでないときのみ
            zukakuLayerView.queryFeatures(queryParams)
            .then(queryArcGISOnline)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

        };

        // AGOLから該当するタイルレイヤーを検索
        function queryArcGISOnline(response){

          const featuresQuery = response.features;

          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            
            return;

          // タイルレイヤーを検索する
          } else if (length === 1) {
            // startLoading();

            const feature = response.features[0];

            const id = feature.attributes.id;
            console.log(id);
            northId = feature.attributes.north;
            southId = feature.attributes.south;
            westId = feature.attributes.west;
            eastId = feature.attributes.east;
            
            portal.load().then(function() {
              const queryParams = {
                query: QUERYTXT + id,
                sortField: "numViews",
                sortOrder: "desc",
                num: 20
              };
              portal.queryItems(queryParams).then(addTileLayer);
            });
            return response;
          };
        };

        const mapSecond = new Map({
        });
        
        let itemId;
        let defaultTransparency = 75;
        
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;

        let is3D = true;
        let isMetadataVisible = true;
        let viewTilt = 45;
        let viewHeading = 0;

        let exaggerationId = '1';
        
        function addTileLayer(response){
          
          itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          // addOpenInAGOLBtn();
          // addCopyTileUrlBtn();
          

          esriRequest(tileLayerUrl, options)
            .then(createTileView);

          
        };

        const sceneView = new SceneView({
          container: null
        });

        
        sceneView.ui.move(["zoom", "navigation-toggle", "compass"], "top-right");
        
        const homeBtn = new Home({
          view: sceneView
        });

        


        // ビューを作成
        function createTileView (response) {
          
          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          // メニューボタンの表示、非表示の切り替え
          setDisplayActionItemsSecond();
          // listMenu[menuIndex.legend].elm.style.display = "none";
          // listMenu[menuIndex.metadata].elm.style.display = "block";
          // listMenu[menuIndex.threed].elm.style.display = "block";
          // listMenu[menuIndex.agol].elm.style.display = "block";
          // listMenu[menuIndex.back].elm.style.display = "block";

          
         
          // if (is3D === true) {
          //   listMenu[menuIndex.threed].elm.firstElementChild.removeAttribute("icon");
          //   listMenu[menuIndex.threed].elm.firstElementChild.setAttribute("icon", "map");
          //   listMenu[menuIndex.threed].elm.lastElementChild.innerHTML = "2D";
          //   refreshMenu(sceneView);
          // } else if (is3D === false) {
          //   listMenu[menuIndex.threed].elm.firstElementChild.removeAttribute("icon");
          //   listMenu[menuIndex.threed].elm.firstElementChild.setAttribute("icon", "360-view");
          //   listMenu[menuIndex.threed].elm.lastElementChild.innerHTML = "3D";
          //   refreshMenu(view);
          // }

          // let activeViewpoint;
          // if (listMenu[menuIndex.threed].elm.firstElementChild.getAttribute("icon") === "360-view") {
          //   activeViewpoint = view.viewpoint.clone();
          // } else if (listMenu[menuIndex.threed].elm.firstElementChild.getAttribute("icon") === "map" && (sceneView.viewpoint)) {
          //   activeViewpoint = sceneView.viewpoint.clone();
          //   sceneView.viewpoint = activeViewpoint;
          // } else if (listMenu[menuIndex.threed].elm.firstElementChild.getAttribute("icon") === "map" && (view.viewpoint)) {
          //   activeViewpoint = view.viewpoint.clone();
          //   sceneView.viewpoint = activeViewpoint;
          // };
          
          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);
          // tileLayer.opacity = defaultTransparency/100;

          // マップ
          // if (listMenu[menuIndex.threed].elm.firstElementChild.getAttribute("icon") === "360-view") {

          //   view.map = mapSecond;
          //   mapSecond.ground = {};

          //   // view.constraints = {minZoom: minLOD, maxZoom: maxLOD};
            
          //   view.ui.empty("top-left");
          //   view.ui.empty("bottom-left");
            
          //   addOpacitySlider(view);

          //   tileLayer.when(function() {
          //     view.goTo(tileLayer.fullExtent);
          //     const vp = new Viewpoint({
          //       targetGeometry: tileLayer.fullExtent
          //     });
          //     homeBtn2D.viewpoint = vp;
          //   });
          //   sceneView.ui.remove(exaggerationBtnDiv);
          //   addAllDirectionBtn2View(view);
          //   // デフォルトでメタデータを表示
          //   showMetadata(view);
          //   endLoading();

            
          // シーン
          // } else if (listMenu[menuIndex.threed].elm.firstElementChild.getAttribute("icon") === "map") {
            
            sceneView.map = mapSecond;
            mapSecond.basemap = map.basemap;



            
            sceneView.container = "viewDiv";
            // sceneView.ui.empty("bottom-left");
            // selectExaggerationId(exaggerationId);       

            tileLayer.when(function() {
              sceneView.goTo({
                target: tileLayer.fullExtent,
                tilt: viewTilt,
                heading: viewHeading
              })
              .then(function(){
                
                sceneView.ui.remove(homeBtn);
                sceneView.ui.add(homeBtn, "top-right");
                const vp = new Viewpoint({
                  targetGeometry: tileLayer.fullExtent
                });
                homeBtn.viewpoint = vp;
                
                sceneView.watch("camera.tilt", function(newValue) {
                  viewTilt = newValue;
                });
                sceneView.watch("camera.heading", function(newValue) {
                  viewHeading = newValue;
                });
                add2d3dRadioButton();
                addImageSettingsCalciteFlow();
              })
              // 透過度スライダーの追加
              // .then(function(){addOpacitySlider(sceneView)})
              // 高さ倍率ボタンの追加
              // .then(function(){
              //   sceneView.ui.empty("bottom-left");
              //   sceneView.ui.remove(exaggerationBtnDiv);
              //   addExaggerationButton(sceneView, exaggerationId);
              // })
              // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
              // .then(function(){addAllDirectionBtn2View(sceneView)})
              // 高さ倍率ボタンクリック時のイベント
              // .then(function(){clickExaggerationBtn(sceneView)})
              // .then()
              // .then(function(){
              //   endLoading();
              //   clickMenuBtn(sceneView);
                // デフォルトでメタデータを表示
              //   showMetadata(sceneView);
              // })
            });
          // }
          
        };

        //////////////////////////////////////////////
        //   AGO
        /////////////////////////////////////////////

        agoAction.addEventListener("click", function(event){
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          agoAction.setAttribute("active", null);

          const agoCalciteFlow = document.createElement("calcite-flow");
          agoCalciteFlow.setAttribute('id', 'agoCalciteFlow');
          primaryPanel.appendChild(agoCalciteFlow);

          const agoCalcitePanel = document.createElement("calcite-panel");
          agoCalcitePanel.setAttribute("heading", "Open in ArcGIS Online");
          agoCalcitePanel.setAttribute("summary", "aiueo");
          agoCalciteFlow.appendChild(agoCalcitePanel);

          const agoButton = document.createElement("calcite-button");
          agoButton.setAttribute("width", "full");
          // agoButton.setAttribute("scale", "s");
          agoButton.setAttribute("icon-start", "arcgis-online");
          agoButton.setAttribute("appearance", "outline");
          agoButton.innerHTML = "Open Web Map";
          agoCalcitePanel.appendChild(agoButton);

          const copyTileCalciteFlow = document.createElement("calcite-flow");
          copyTileCalciteFlow.setAttribute('id', 'copyTileCalciteFlow');
          primaryPanel.appendChild(copyTileCalciteFlow);

          const copyTileCalcitePanel = document.createElement("calcite-panel");
          copyTileCalcitePanel.setAttribute("heading", "Copy Tile Service URL");
          copyTileCalcitePanel.setAttribute("summary", "aiueo");
          copyTileCalciteFlow.appendChild(copyTileCalcitePanel);

          const copyTileButton = document.createElement("calcite-button");
          copyTileButton.setAttribute("width", "full");
          // agoButton.setAttribute("scale", "s");
          copyTileButton.setAttribute("icon-start", "copy-to-clipboard");
          copyTileButton.setAttribute("appearance", "outline");
          copyTileButton.innerHTML = "Copy URL";
          copyTileCalcitePanel.appendChild(copyTileButton);

        });

        //////////////////////////////////////////////
        //   Metadata
        /////////////////////////////////////////////

        metadataAction.addEventListener("click", function(event){
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          metadataAction.setAttribute("active", null);

          const metadataCalciteFlow = document.createElement("calcite-flow");
          metadataCalciteFlow.setAttribute('id', 'metadataCalciteFlow');
          primaryPanel.appendChild(metadataCalciteFlow);

          const metadataCalcitePanel = document.createElement("calcite-panel");
          metadataCalcitePanel.setAttribute("heading", "Metadata");
          // opacityCalcitePanel.setAttribute("summary", "Change the opacity to ...............................................");
          metadataCalciteFlow.appendChild(metadataCalcitePanel);

          metadataCalcitePanel.appendChild(attributeDiv);

        });

        const arrayAtt = [
          {"title": "記号", "att": "area3"},
          {"title": "図幅名", "att": "area_name"},
          {"title": "測量機関", "att": "surveyed_by"},
          {"title": "測量時期（修正含む）", "att": "survey_year"},
          {"title": "製版・印刷機関", "att": "printed_by"},
          {"title": "製版時期", "att": "print_year"},
          {"title": "発行時期", "att": "publish_year"},
          {"title": "大きさ", "att": "size"},
          {"title": "色", "att": "color"},
          {"title": "備考", "att": "notes"},
          {"title": "枚数（実物）", "att": "copies"}
        ];

        const attributeDiv = document.createElement("div");

        function addZukakuAttribute (response) {

          if (typeof response === 'undefined') {
            return;
          }

          const feature = response.features[0];
          
          attributeDiv.innerHTML = "";

          const divArea3_en = document.createElement("h3");
          const attArea3_en = feature.attributes.area3_en;
          divArea3_en.innerHTML = attArea3_en;
          attributeDiv.appendChild(divArea3_en);

          const divTitle = document.createElement("h3");
          const attTitle = feature.attributes.title;
          // divTitle.className = "font-size--1";
          divTitle.innerHTML = attTitle;
          attributeDiv.appendChild(divTitle);

          const divScale = document.createElement("h3");
          const attScale = feature.attributes.scale;
          // divScale.className = "padding-leader-half font-size--1";
          divScale.innerHTML = attScale;
          attributeDiv.appendChild(divScale);

          const divPrintedYear = document.createElement("h3");
          const attPrintedYear = feature.attributes.print_year_en;
          // divPrintedYear.className = "padding-leader-half font-size--1";
          divPrintedYear.innerHTML = "Printed in " + attPrintedYear;
          attributeDiv.appendChild(divPrintedYear);

          const divSize = document.createElement("h3");
          const attSize = feature.attributes.height_width;
          // divSize.className = "padding-leader-half font-size--1";
          divSize.innerHTML = attSize + " (cm)";
          if (attSize !== "-"){
            attributeDiv.appendChild(divSize);
          }

          const divId = document.createElement("h3");
          const attId = feature.attributes.id;
          // divId.className = "padding-leader-half font-size--1";
          divId.innerHTML = attId;
          attributeDiv.appendChild(divId);
          

          const details = document.createElement("details");
          // details.className = "padding-leader-half font-size--1";
          attributeDiv.appendChild(details);

          const summary = document.createElement("summary");
          summary.innerHTML = "Details in Japanese";
          details.appendChild(summary);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            const attribute = document.createElement("h4");
            // attribute.className = "padding-leader-half padding-left-half font-size--1";
            details.appendChild(attribute);

            const title = document.createElement("h4");
            attribute.appendChild(title);
            title.style.color = "gray";
            title.innerHTML = arrayAtt[i]["title"];

            const value = document.createElement("h4");
            attribute.appendChild(value);

            value.innerHTML = attValue;
          };
          

        };

        //////////////////////////////////////////////
        //   Image settings
        /////////////////////////////////////////////

        imageSettingsAction.addEventListener("click", function(event) {
          addImageSettingsCalciteFlow();
        });

        function addImageSettingsCalciteFlow () {
          
          // 既存の内容を削除
          deleteAllExistedCalciteFlow();

          // すべてのActionItemのActive状態を解除
          resetActiveActionItems();

          // 該当するActiveItemをAcitiveにする
          imageSettingsAction.setAttribute("active", null);

          // opacity
          const opacityCalciteFlow = document.createElement("calcite-flow");
          opacityCalciteFlow.setAttribute('id', 'opacityCalciteFlow');
          primaryPanel.appendChild(opacityCalciteFlow);

          const opacityCalcitePanel = document.createElement("calcite-panel");
          opacityCalcitePanel.setAttribute("heading", "Opacity");
          // opacityCalcitePanel.setAttribute("summary", "Change the opacity to ...............................................");
          opacityCalciteFlow.appendChild(opacityCalcitePanel);

          const opacityDiv = document.createElement("div");
          opacityDiv.style.padding = "20px";
          opacityCalcitePanel.appendChild(opacityDiv);

          const opacityCalciteSlider = document.createElement("calcite-slider");
          opacityCalciteSlider.setAttribute("min", "0");
          opacityCalciteSlider.setAttribute("max", "100");
          opacityCalciteSlider.setAttribute("value", defaultTransparency);
          opacityCalciteSlider.setAttribute("scale", "l");
          opacityCalciteSlider.setAttribute("label-handles", "true");
          opacityCalciteSlider.setAttribute("precise", "true");
          opacityCalciteSlider.setAttribute("snap", "true");
          opacityCalciteSlider.setAttribute("step", "5");
          opacityCalciteSlider.setAttribute("max-label", "100");
          opacityDiv.appendChild(opacityCalciteSlider);

          // event
          opacityCalciteSlider.addEventListener('calciteSliderChange', transparencyChanged);

          // Exaggerating elevation
          const exaggerationCalciteFlow = document.createElement("calcite-flow");
          exaggerationCalciteFlow.setAttribute('id', 'exaggerationCalciteFlow');
          primaryPanel.appendChild(exaggerationCalciteFlow);

          const exaggerationCalcitePanel = document.createElement("calcite-panel");
          exaggerationCalcitePanel.setAttribute("heading", "Exaggerating elevation");
          // exaggerationCalcitePanel.setAttribute("summary", "hogehogehoge");
          exaggerationCalciteFlow.appendChild(exaggerationCalcitePanel);

          const exaggerationRadioGroup = document.createElement("calcite-radio-group");
          exaggerationRadioGroup.setAttribute("width", "full");
          exaggerationCalcitePanel.appendChild(exaggerationRadioGroup);

          const x1RadioButton = document.createElement("calcite-radio-group-item");
          x1RadioButton.setAttribute("value", "1");
          x1RadioButton.setAttribute("checked", null);
          x1RadioButton.innerHTML = "1x";
          exaggerationRadioGroup.appendChild(x1RadioButton);
           
          const x3RadioButton = document.createElement("calcite-radio-group-item");
          x3RadioButton.setAttribute("value", "3");
          x3RadioButton.innerHTML = "3x";
          exaggerationRadioGroup.appendChild(x3RadioButton);

          const x5RadioButton = document.createElement("calcite-radio-group-item");
          x5RadioButton.setAttribute("value", "5");
          x5RadioButton.innerHTML = "5x";
          exaggerationRadioGroup.appendChild(x5RadioButton);

          // adjacent map
          const adjacentCalciteFlow = document.createElement("calcite-flow");
          adjacentCalciteFlow.setAttribute('id', 'adjacentCalciteFlow');
          primaryPanel.appendChild(adjacentCalciteFlow);

          const adjacentCalcitePanel = document.createElement("calcite-panel");
          adjacentCalcitePanel.setAttribute("heading", "Show adjacent map");
          // adjacentCalcitePanel.setAttribute("summary", "hogehogehoge");
          adjacentCalcitePanel.setAttribute("id", "adjacentCalcitePanel");
          adjacentCalciteFlow.appendChild(adjacentCalcitePanel);

          // 東西南北ボタンを追加
          addAllDirectionBtn2View();

          // copy tile service url
          // const copyCalciteFlow = document.createElement("calcite-flow");
          // copyCalciteFlow.setAttribute('id', 'adjacentCalciteFlow');
          // primaryPanel.appendChild(copyCalciteFlow);

          // const copyCalcitePanel = document.createElement("calcite-panel");
          // copyCalcitePanel.setAttribute("heading", "Copy tile service URL");
          // // copyCalcitePanel.setAttribute("summary", "hogehogehoge");
          // copyCalcitePanel.setAttribute("id", "copyCalcitePanel");
          // copyCalciteFlow.appendChild(copyCalcitePanel);

          // const copyButton = document.createElement('calcite-button');
          // copyButton.setAttribute("icon-start", "copy-to-clipboard");
          // copyButton.innerHTML = "Copy URL";
          // copyButton.className = "legendbutton";
          // copyCalcitePanel.appendChild(copyButton);
          
        };

        //////////////////////////////////////////////
        //   2D3Dボタン
        /////////////////////////////////////////////

        function add2d3dRadioButton () {
          const mapSceneRadioGroup = document.createElement("calcite-radio-group");
          mapSceneRadioGroup.setAttribute("scale", "l");
          
          const mapRadioGroupItem = document.createElement("calcite-radio-group-item");
          mapRadioGroupItem.setAttribute("value", "map");
          mapRadioGroupItem.innerHTML = "2D";
          mapSceneRadioGroup.appendChild(mapRadioGroupItem);
           
          const sceneRadioGroupItem = document.createElement("calcite-radio-group-item");
          sceneRadioGroupItem.setAttribute("value", "area");
          sceneRadioGroupItem.setAttribute("checked", null);
          sceneRadioGroupItem.innerHTML = "3D";
          mapSceneRadioGroup.appendChild(sceneRadioGroupItem);

          sceneView.ui.add(mapSceneRadioGroup, "top-left");
        };

        //////////////////////////////////////////////
        //   東西南北ボタン
        /////////////////////////////////////////////
        function addAllDirectionBtn2View (view) {
          all([createDirectionBtn(northId, "northBtn", "arrow-bold-up", "North"), 
               createDirectionBtn(southId, "southBtn", "arrow-bold-down", "South"),
               createDirectionBtn(westId, "westBtn", "arrow-bold-left", "West"),
               createDirectionBtn(eastId, "eastBtn", "arrow-bold-right", "East")
              ])
          .then(function(results){
            
            for (let i in results) {
              
              if (results[i].id) {
                
                const adjacentCalcitePanel = document.getElementById("adjacentCalcitePanel");
                adjacentCalcitePanel.appendChild(results[i]);
                // results[i].addEventListener("click", showNextImage);
              };
            }
          });
        };
        
        function createDirectionBtn (id, attId, classIcon, text) {
          const deferred = new Deferred();
          
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["georeference"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
            .then(function(response){
              
              const arrowBtn = document.createElement('calcite-button');
              
              if (response.features.length > 0){
                const feature = response.features[0];

                const georeferenceflg = feature.attributes.georeference;
                // 隣接図郭のサービスはあがっているとは限らない
                if (georeferenceflg === 1) {
                  
                  arrowBtn.setAttribute("id", attId);
                  arrowBtn.setAttribute("data-id", id);
                  arrowBtn.setAttribute("width", "full");
                  arrowBtn.setAttribute("appearance", "outline");
                  arrowBtn.setAttribute("icon-start", classIcon);
                  arrowBtn.className = "legendbutton";
                  arrowBtn.innerHTML = text;
                  // arrowBtn.className = "esri-button direction";

                  // const arrowIconDiv = document.createElement('div');
                  // arrowIconDiv.className = "padding-right-half " + classIcon;
                  // arrowIconDiv.setAttribute("data-id", id);
                  // arrowBtn.appendChild(arrowIconDiv);

                  // arrowBtn.insertAdjacentHTML('beforeend', text);

                }
              }
              deferred.resolve(arrowBtn);

            }).catch(function(error) {
              console.error("query failed: ", error);
            });
          
          return deferred.promise;

        };

        //////////////////////////////////////////////
        //   透過率
        /////////////////////////////////////////////
        function transparencyChanged(event) {
          defaultTransparency = event.target.attributes.getNamedItem("value").value;
          tileLayer.opacity = defaultTransparency/100;
        };

      });
    </script>
  </head>

  <body>

    <calcite-modal aria-labelledby="modal-title">
      <div slot="header" id="modal-title">Gaihozu Viewer : Indonesian-territory version (GV-I)</div>
      <div slot="content">Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands made by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS Online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
        <p>Clicking a shaded box on the index map enable you to show the corresponding geo-referenced map in 3D scene with its metadata, such as map scale and printed year. Clicking a button of ratio like 1:500,000 switched the index map of the corresponding map scale.</p>
        <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a> maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University.</p>
        <p>Copyright (C) 2020-  Human Geography Research Group at Tohoku University (Environmental Geography Lab at the Graduate School of Environmental Studies and the Institute of Geography, the Graduate School of Science, Tohoku University)</p>
        <p>Project team members: T. Nakaya, S. Nagata, Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
      </div>
      <!-- <calcite-button slot="back" color="light" appearance="outline" icon="chevron-left" width="full">
          Back</calcite-button> -->
      <!-- <calcite-button slot="secondary" width="full" appearance="outline">Cancel</calcite-button> -->
      <calcite-button slot="primary" width="full">OK</calcite-button>
    </calcite-modal>

    <!-- <calcite-modal aria-labelledby="modal-title" active>
      
    </calcite-modal> -->

    

    <calcite-shell theme="light">

      <div slot="shell-header">
        
        <header>
          
          <div id="divHeader">
            <div id="headerTitle">
              <h2>Gaihozu Viewer
                <!-- <span> : Indonesian-territory version (GV-I)</span> -->
              </h2>
            </div>
            <div id="buttonInfo">
              <calcite-button icon-start="information" scale="l" appearance="transparent" color="neutral"></calcite-button>
            </div>
            <div id="imgTohoku">
              
              <span>
                <img src="./img/Toh_E_S_N_G.gif" height="56px" width="56px">
              </span>
            </div>
          </div>    
        </header>
      </div>

      <calcite-shell-panel slot="primary-panel" position="start" detached id="primaryPanel">
          <calcite-action-bar slot="action-bar" expanded="true" id="actionBar">
            
            <calcite-action-group id="actionGroup">
              <calcite-action text="Back to Index" icon="x-circle" scale="l" id="backAction"></calcite-action>
              <calcite-action text="Image settings" icon="image-layer" scale="l" id="imageSettingsAction"></calcite-action>
              <calcite-action text="Metadata" icon="access-string-results" scale="l" id="metadataAction"></calcite-action>
              <!-- <calcite-action text="2D" icon="map" scale="l" id="mapSceneAction"></calcite-action> -->
              <calcite-action text="ArcGIS Online" icon="arcgis-online" scale="l" id="agoAction"></calcite-action>
              <calcite-action text="Filter" active icon="filter" scale="l" id="filterAction"></calcite-action>
              <calcite-action text="Search" icon="search" scale="l" id="searchAction"></calcite-action>
              <calcite-action text="Basemap" icon="basemap" scale="l" id="basemapAction"></calcite-action>
              <calcite-action text="Measurement" icon="measure" scale="l" id="measurementAction"></calcite-action>
            </calcite-action-group>
            <!-- <calcite-action-group id="actionGroup3D">
              <calcite-action text="Search" icon="search" scale="l"></calcite-action>
              <calcite-action text="Basemap" active icon="basemap" scale="l"></calcite-action>
              <calcite-action text="Measurement" active icon="measure" scale="l"></calcite-action>
            </calcite-action-group> -->

          </calcite-action-bar>
          
          
          <!-- <calcite-flow>
            <calcite-panel heading="Printed year">
              <div id="">
                <calcite-button scale = "m" width="full" icon-start="polygon">
                  Show all
                </calcite-button>

                <calcite-button scale = "m" width="full" disabled appearance="outline" color="neutral">
                  <div style="opacity: 0.51; margin-right: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      
                      <g transform="matrix(1.0909091234207153,0,0,1.0909091234207153,12,12)">
                        <path fill="rgba(255, 0, 0, 1)" fill-rule="evenodd" stroke="rgba(255, 255, 255, 0.25098039215686274)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" stroke-miterlimit="4" d="M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 Z">
                        </path>
                      </g>
                    </svg>
                  </div>
                  1939
                </calcite-button>

                <calcite-button scale = "m" width="full" appearance="outline" color="neutral">
                  <div style="opacity: 0.51; margin-right: 10px;">
                    <svg class="svg" fill="currentColor"  width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                      <path fill="rgba(255, 0, 0, 1)" fill-rule="nonzero" d="M15 1L6.833 7 1 4v11h14zm-1 13H2V5.639l4.927 2.534L14 2.976z"></path>
                    </svg>
                  </div>
                  1940
                </calcite-button>

                <calcite-button scale = "m" width="full" appearance="outline" color="blue" theme="dark">
                  <div style="opacity: 0.51; margin-right: 10px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                      
                      <g transform="matrix(1.0909091234207153,0,0,1.0909091234207153,12,12)">
                        <path fill="rgba(255, 0, 0, 1)" fill-rule="evenodd" stroke="rgba(255, 255, 255, 0.25098039215686274)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="none" stroke-miterlimit="4" d="M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 Z">
                        </path>
                      </g>
                    </svg>
                  </div>
                  <div>1941</div>
                </calcite-button>
              </div>
              
            </calcite-panel>
          </calcite-flow> -->
      </calcite-shell-panel>
      
      <calcite-loader type="indeterminate" id="loaderDiv"></calcite-loader>  
      
      <div id="viewDiv" class="esri-widget"></div>
      
  </calcite-shell>
    


  </body>
</html>
