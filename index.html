<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Gaihozu Viewer</title>

    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      #viewDiv {
        position: absolute;
        left: 75px;
        right: 0;
        top: 0;
        bottom: 0;
        height: 100%;
      }
      #attributeDiv {
        top: 55px;
        bottom: 0px;
        left: 75px;
        right: 0px;
        height: calc(100% - 55px);
        width: 180px;
        position: absolute;
        display: none;
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 10px;
        border-color: #464646;
        border-width: 1px;
        border-left-style: solid;
        border-right-style: solid;
        overflow-y: scroll;
        background: #f8f8f8;
      }
      #titleDiv {
        position: absolute;
        height: 55px;
        left: 0px;
        right: 0px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        background: #464646;
        z-index: 1;
      }

      .top-nav-title {
        color: #f8f8f8 !important;
      }
      #menuDiv {
        position: absolute;
        top: 55px;
        left: 0;
        right: 0;
        height: calc(100% - 55px);
        width: 75px;
        overflow-y: auto;
        background: #f8f8f8;
      }
      #menuDiv [class*="esri-icon"] {
        font-size: 25px !important;
      }
      .menu-area {
        cursor : pointer;
      }
      @media screen and (min-width: 1367px) {
        .menu-area:hover {
          background-color: lightgray;
          color: #59d6ff;
        }
      }
      #backDiv, #metadataDiv {
        display: none;
      }
      .loader{
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        /* z-index: 4999 ; */
        position: absolute !important;
      }
      .loader-bars{
        width: 100%;
        height: 100%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translateY(-50%) translateX(-50%);
        -webkit-transform: translateY(-50%) translateX(-50%);
      }
      .active-menu {
        background-color: #464646 !important;
        color: #59d6ff !important;
      }
      button {
        background-color: #0079c1 !important;
        color: #f8f8f8 !important;
      }
      button[disabled] {
        opacity: 100 !important;
        background-color: lightgray !important;
        color: #0079c1 !important;
      } 
      #toolbarMeasureDiv {
        flex-direction: row;
        flex-wrap: nowrap;
        display: flex;
      }
      .esri-widget--button {
        background-color: #efefef !important;
        color: #464646 !important;
        /* width: 40px !important;
        height: 40px !important;
        font-size: 16px !important; */
      }
      .esri-widget--button.active,
      .esri-widget--button.active:hover,
      .esri-widget--button.active:focus {
        cursor: default;
        background-color: #999696 !important;
      }
      .esri-widget--button.active path,
      .esri-widget--button.active:hover path,
      .esri-widget--button.active:focus path {
        fill: #e4e4e4 !important;
      }
      .esri-legend__layer-caption {
        display: none !important;
      }
      .esri-legend {
        width: 200px !important;
      }
      .slider {
        width: 100%;
        height: 60px;
      }
      #opacityDiv {
        width: 250px;
        background: #f8f8f8;
        display: none;
        /* height: 60px; */
      }
      .esri-slider {
        background: #f8f8f8 !important;
      }
      .direction {
        width: 100px !important;
      }
      #opacityDiv{
        display: none;
      }
      fieldset{
        float: left;
      }
      article, aside, details, figcaption, figure, footer, header, hgroup, nav, section, summary{
        display: revert !important;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.15/esri/themes/light/main.css"
    />
    <link rel="stylesheet" href="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/css/calcite-web.min.css">
    <script src="https://s3-us-west-1.amazonaws.com/patterns.esri.com/files/calcite-web/1.2.5/js/calcite-web.min.js"></script>
    <!-- interactive patterns need to be initialized -->
    <script>
       calcite.init()
    </script>
    <script>
      // set locale before JSAPI is loaded
      dojoConfig = {
        locale: "en",
        parseOnLoad: true
      };
    </script>
    <script src="https://js.arcgis.com/4.15/"></script>
    
    <script>
      require([
        "esri/views/MapView",
        "esri/widgets/Expand",
        "esri/layers/FeatureLayer",
        "esri/Map",
        // "esri/widgets/HistogramRangeSlider",
        // "esri/renderers/smartMapping/statistics/histogram",
        // "esri/widgets/HistogramRangeSlider/HistogramRangeSliderViewModel",
        "esri/widgets/Search",
        "esri/layers/GraphicsLayer",
        "esri/Graphic",
        "esri/portal/Portal",
        "esri/portal/PortalItem",
        "esri/core/watchUtils",
        "esri/request",
        "esri/layers/TileLayer",
        "esri/widgets/Slider",
        "esri/widgets/Measurement",
        "esri/widgets/BasemapGallery",
        "esri/widgets/BasemapGallery/support/PortalBasemapsSource",
        "esri/widgets/Legend",
        "dojo/Deferred",
        "dojo/promise/all"
      ], function(
        MapView, 
        Expand,
        FeatureLayer,
        Map,
        // HistogramRangeSlider,
        // histogram,
        // HistogramRangeSliderVM,
        Search,
        GraphicsLayer,
        Graphic,
        Portal,
        PortalItem,
        watchUtils,
        esriRequest,
        TileLayer,
        Slider,
        Measurement,
        BasemapGallery,
        PortalBasemapsSource,
        Legend,
        Deferred,
        all
      ) {
        
        const URL_FL = "https://services1.arcgis.com/qvPIahekAMWThrhc/arcgis/rest/services/zukaku/FeatureServer/0";
        const QUERYTXT = "owner: Y.Hoshida AND group: 3f221abcf0cc4633a868f8dd49f99f8b AND type: 'Map Service' AND tags: ";

        // メニューのリスト
        const listMenu = [
          {'text': 'measure ment', 'icon': "esri-icon-measure", 'phone-hide': true},
          {'text': 'basemap', 'icon': "esri-icon-basemap", 'phone-hide': false},
          {'text': 'search', 'icon': "esri-icon-search", 'phone-hide': true},
          {'text': 'legend', 'icon': "esri-icon-layer-list", 'phone-hide': false},
          {'text': 'info', 'icon': "esri-icon-description", 'phone-hide': false},
          {'text': 'metadata', 'icon': "esri-icon-documentation", 'phone-hide': false},
          {'text': 'back to index map', 'icon': "esri-icon-close-circled", 'phone-hide': false}
        ];
        const menuDiv = document.getElementById("menuDiv");

        // メニューボタンを追加
        for (let i in listMenu) {

          listMenu[i].elm = document.createElement('div');
          if (listMenu[i]['phone-hide'] === false) {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area";
          } else {
            listMenu[i].elm.className = "padding-leader-half padding-trailer-half menu-area phone-hide";
          };
          listMenu[i].elm.setAttribute("menu-id", i);
          menuDiv.insertBefore(listMenu[i].elm, menuDiv.firstChild);
          
          const menuIconDiv = document.createElement('div');
          menuIconDiv.className = listMenu[i]['icon'];
          menuIconDiv.setAttribute("menu-id", i);
          listMenu[i].elm.insertBefore(menuIconDiv, listMenu[i].elm.firstChild);
          
          const menuTextDiv = document.createElement('div');
          menuTextDiv.className = "font-size--2";
          menuTextDiv.innerHTML = listMenu[i]['text'];
          menuTextDiv.setAttribute("menu-id", i);
          menuIconDiv.parentNode.insertBefore(menuTextDiv, menuIconDiv.nextSibling);

        };

        function removeActiveMenu (indexes) {
          for (let i in listMenu) {
            if (!indexes.includes(Number(i))) {
              listMenu[i].elm.classList.remove("active-menu");
            };
          };
        };

        listMenu[5].elm.style.display = "none";
        listMenu[6].elm.style.display = "none";

        // マップ 
        const portal = new Portal();

        const map = new Map({
          basemap: 'streets-vector'
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [118.4985351561923, -2.0326589312043144],
          zoom: 4,
          padding: {
            top: 55
          }
        });

        view.ui.remove("zoom");

        const zukakuFeatureLayer = new FeatureLayer({
          url: URL_FL,
          outFields: ["*"],
          title: "図郭"
        });
        map.add(zukakuFeatureLayer);

        const graphicsLayerMouseOveredZukaku = new GraphicsLayer();

        map.add(graphicsLayerMouseOveredZukaku);

        // フィーチャレイヤービュー
        let zukakuLayerView　;
        const defaultWhereClause = "georeference = 1";
        let whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;

        view.whenLayerView(zukakuFeatureLayer).then(function(layerView) {

          zukakuLayerView = layerView;
          zukakuLayerView.filter = {
            where: whereClause
          };

          // ポインターが重なった時
          // view.on('pointer-move', function(evt){
          //   if (view.map === map) {
          //     queryFeaturesMouseOvered(evt);
          //   };
          // });

        });

        function addUI (index) {

          if (index === 0) {
            view.ui.add(toolbarMeasureDiv, "bottom-left");
            view.ui.add(measurement, "bottom-right");
          } else if (index === 1) {
            view.ui.add(basemapGallery, "bottom-left");
          } else if (index === 2 && view.map === map) {
            view.ui.add(searchWidgetWithSources, "bottom-left");
          } else if (index === 2 && view.map === mapSecond) {
            view.ui.add(searchWidget, "bottom-left");
          } else if (index === 3) {
            view.ui.add(legend, "bottom-left");
          };

        };

        function removeUI (index) {

          if (index === 0) {
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
          } else if (index === 1) {
            view.ui.remove(basemapGallery, "bottom-left");
          } else if (index === 2 && view.map === map) {
            view.ui.remove(searchWidgetWithSources, "bottom-left");
          } else if (index === 2 && view.map === mapSecond) {
            view.ui.remove(searchWidget, "bottom-left");
          } else if (index === 3) {
            view.ui.remove(legend, "bottom-left");
          };

        };

        function removeOtherUI (index) {

          if (index !== 0) {
            view.ui.remove(toolbarMeasureDiv, "bottom-left");
            view.ui.remove(measurement, "bottom-right");
            measurement.clear();
          }
          if (index !== 1) {
            view.ui.remove(basemapGallery, "bottom-left");
          }
          if (index !== 2 && view.map === map) {
            view.ui.remove(searchWidgetWithSources, "bottom-left");
          };
          if (index !== 2 && view.map === mapSecond) {
            view.ui.remove(searchWidget, "bottom-left");
          };
          if (index !== 3) {
            view.ui.remove(legend, "bottom-left");
          }

        };

        // 計測ウィジェット
        const toolbarMeasureDiv = document.getElementById("toolbarMeasureDiv");
        const measurement = new Measurement({
          view: view
        });
        
        listMenu[0].elm.onclick = function(){
          if (!listMenu[0].elm.classList.contains("active-menu")) {
            listMenu[0].elm.classList.add("active-menu");
            addUI(0);
            removeOtherUI(0);
          } else {
            listMenu[0].elm.classList.remove("active-menu");
            removeUI(0);
            distanceMeasureBtn.classList.remove("active");
            areaMeasureBtn.classList.remove("active");
          }
          removeActiveMenu([0,5]);
        };

        const distanceMeasureBtn = document.getElementById("distanceMeasureBtn");
        const areaMeasureBtn = document.getElementById("areaMeasureBtn");
        const clearMeasureBtn = document.getElementById("clearMeasureBtn");

        distanceMeasureBtn.addEventListener("click", function() {
          measurement.activeTool = "distance";
          distanceMeasureBtn.classList.add("active");
          areaMeasureBtn.classList.remove("active");
        });

        areaMeasureBtn.addEventListener("click", function() {
          measurement.activeTool = "area";
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.add("active");
        });

        clearMeasureBtn.addEventListener("click", function() {
          measurement.clear();
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.remove("active");
        });

        // ベースマップウィジェット
        const portalSource = new PortalBasemapsSource({  
          query:{title: "Vector Basemaps",owner: "Esri_cy_US"}    
        });
                 
        const basemapGallery = new BasemapGallery({       
          view: view,     
          container: document.createElement("div"),       
          source: portalSource
        }); 

        listMenu[1].elm.onclick = function(){
          if (!listMenu[1].elm.classList.contains("active-menu")) {
            listMenu[1].elm.classList.add("active-menu");
            addUI(1);
            removeOtherUI(1);
          } else {
            listMenu[1].elm.classList.remove("active-menu");
            removeUI(1);
          }
          removeActiveMenu([1,5]);
        };

        // 検索ウィジェット
        const sources = [{
          layer: zukakuFeatureLayer,
          searchFields: ["id"],
          displayField: "id",
          exactMatch: false,
          outFields: ["*"],
          name: "Search by ID",
          placeholder: "example: TH008053",
          maxResults: 6,
          maxSuggestions: 6,
          suggestionsEnabled: true,
          minSuggestCharacters: 0
        }];

        const searchWidget = new Search({
          view: view
        });

        const searchWidgetWithSources = new Search({
          view: view,
          sources: sources
        });

        listMenu[2].elm.onclick = function(){
          if (!listMenu[2].elm.classList.contains("active-menu")) {
            listMenu[2].elm.classList.add("active-menu");
            addUI(2);
            removeOtherUI(2);
          } else {
            listMenu[2].elm.classList.remove("active-menu");
            removeUI(2);
          }
          removeActiveMenu([2,5]);
        };

        // 凡例
        const legend = new Legend({
          view: view,
          layerInfos: [
            {
              layer: zukakuFeatureLayer,
              title: "Printed year"
            }
          ]
        });
        

        listMenu[3].elm.onclick = function(){
          if (!listMenu[3].elm.classList.contains("active-menu")) {
            listMenu[3].elm.classList.add("active-menu");
            addUI(3);
            removeOtherUI(3);
          } else {
            listMenu[3].elm.classList.remove("active-menu");
            removeUI(3);
          }
          removeActiveMenu([3,5]);
        };

        // モーダル
        const modal = document.getElementById("modal");

        listMenu[4].elm.onclick = function(){
          if (!listMenu[4].elm.classList.contains("active-menu")) {
            listMenu[4].elm.classList.add("active-menu");
            modal.classList.add("is-active");
            removeOtherUI(-9999);
          } else {
            listMenu[4].elm.classList.remove("active-menu");
            modal.classList.remove("is-active");
          }
          removeActiveMenu([4,5]);
        };

        // 初回は強制的に表示
        if(localStorage.getItem('flgNotShowAgain') === null) {
          modal.classList.add("is-active");
        };

        // 右上の×ボタン
        const closeModal = document.getElementById("closeModal");
        closeModal.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };  

        // 閉じるボタン
        const closeModalBtn = document.getElementById("closeModalBtn");
        closeModalBtn.onclick = function(){
          if (modal.classList.contains("is-active")) {
            modal.classList.remove("is-active");
            listMenu[4].elm.classList.remove("active-menu");
          }
          if(notShowAgainChk.checked) {
            localStorage.setItem('flgNotShowAgain', "1");
          }
        };

        // 属性
        const viewDiv = document.getElementById("viewDiv");
        const attributeDiv = document.getElementById("attributeDiv");

        function openAttributeDiv () {
          viewDiv.style.left = "275px";
          attributeDiv.style.display = "block";
        };

        function closeAttributeDiv () {
          viewDiv.style.left = "75px";
          attributeDiv.style.display = "none";
        };

        listMenu[5].elm.onclick = function(){
          if (!listMenu[5].elm.classList.contains("active-menu")) {
            listMenu[5].elm.classList.add("active-menu");
            openAttributeDiv();
          } else {
            listMenu[5].elm.classList.remove("active-menu");
            closeAttributeDiv();
          };
        };
        
        function refreshMenu () {
          removeActiveMenu([-9999]);
          view.ui.remove(basemapGallery, "bottom-left");
          view.ui.remove(searchWidget, "bottom-left");
          view.ui.remove(toolbarMeasureDiv, "bottom-left");
          view.ui.remove(measurement, "bottom-right");
          view.ui.remove(legend, "bottom-left");

          measurement.clear();
          distanceMeasureBtn.classList.remove("active");
          areaMeasureBtn.classList.remove("active");
          closeAttributeDiv();
        }

        // メニューバーの余白をクリックした時
        menuDiv.addEventListener("click", function(event) {
          if (event.path.length <= 6) {
            refreshMenu();
          }
        });
        
        // 縮尺のリスト
        const listScale = [
          {'text': "- 1:150K (522)"}, 
          {'text': "1:150K - 1:300K (104)"}, 
          {'text': "1:500K (40)"}, 
          {'text': "1:750K - 1:1M (9)"}, 
          {'text': "1:2.5M (5)"}
        ];

        function addScaleButton (index) {

          // 縮尺ボタンを追加
          for (let i in listScale) {
            listScale[i].elm = document.createElement('button');
            listScale[i].elm.className = "esri-button scale-btn-switch";
            listScale[i].elm.setAttribute("scale-id", i);

            if (i === String(index)) {
              listScale[i].elm.disabled = true;
            }

            listScale[i].elm.innerHTML = listScale[i].text;
            viewDiv.parentNode.insertBefore(listScale[i].elm, viewDiv.nextSibling);
            view.ui.add(listScale[i].elm, "top-left");
          }
        };

        let scaleId = '0';
        view.when(function(){

          addScaleButton(scaleId);

        })

        // 縮尺の切り替え
        document
        .querySelector(".esri-ui-top-left")
        .addEventListener("click", function(event) {
          if (view.map === mapSecond) {
            return;
          }
          scaleId = event.target.getAttribute("scale-id");
          if (scaleId) {
            const nodes = document.querySelectorAll(".scale-btn-switch");
            for (var idx = 0; idx < nodes.length; idx++) {
              const node = nodes[idx];
              const scaleIndex = node.getAttribute("scale-id");
              if (scaleIndex === scaleId) {
                node.disabled = true;
                if (scaleId === '0') {
                  whereClause = defaultWhereClause + " AND scale_num IN (1,2,3,4)" ;
                  
                } else if (scaleId === '1') {
                  whereClause = defaultWhereClause + " AND scale_num IN (5,6,7)" ;
                  
                } else if (scaleId === '2') {
                  whereClause = defaultWhereClause + " AND scale_num IN (8)" ;
                  
                } else if (scaleId === '3') {
                  whereClause = defaultWhereClause + " AND scale_num IN (9,10)" ;
                  
                } else if (scaleId === '4') {
                  whereClause = defaultWhereClause + " AND scale_num IN (11)" ;
                  
                };
                zukakuLayerView.filter = {
                  where: whereClause
                };
              } else {
                node.disabled = false;
              }
            }
          }
        });

        // ローダーの表示を止める
        const loaderDiv = document.getElementById("loaderDiv");
        view.watch('updating', function(evt){
          if(!evt){
            loaderDiv.classList.remove('is-active');

          };
        });

        // マップの中心とズームレベルを取得、外邦図から図郭検索地図に戻る際に使用
        watchUtils.whenTrue(view, "stationary", function() {
          if (view.map === map) {
            if (view.extent) {
              viewZoom = view.zoom;
              viewCenter = view.center;
            };
          };   
        });

        // // ポリゴンにマウスオーバー
        // const symbolMouseOveredZukaku = {
        //   type: "simple-fill", // autocasts as new SimpleFillSymbol()
        //   color: [255, 255, 255, 0],
        //   outline: {
        //     // autocasts as new SimpleLineSymbol()
        //     color: [0, 94, 148, 1],
        //     width: 2
        //   }
        // };

        // function queryFeaturesMouseOvered(evt){
        //   const pointermove = view.toMap({x: evt.x, y: evt.y});
        //   graphicsLayerMouseOveredZukaku.removeAll();
          
        //   // フィルターのかかったレイヤービューに対してクエリする
        //   const queryParams = zukakuLayerView.filter.createQuery();
        //   queryParams.geometry = pointermove;
        //   queryParams.spatialRelationship = "intersects";
        //   queryParams.returnGeometry = true;
        //   queryParams.outFields = ["Shape__Area"];
        //   queryParams.orderByFields = ["Shape__Area DESC"];

        //   zukakuLayerView.queryFeatures(queryParams)
        //   .then(addGraphicsMouseOveredFeatures)
        //   .catch(function(error) {
        //     console.log(error);
        //   });

        // };

        // function addGraphicsMouseOveredFeatures (response){
        //   const featuresQuery = response.features;
        //   const length = featuresQuery.length;
        //   // フィーチャがない場所にマウスオーバーした時
        //   if (length === 0){
        //     return;
        //   } else {
        //     featuresQuery.forEach(function(featureQuery) {

        //       addZukakuGraphics(featureQuery, graphicsLayerMouseOveredZukaku, symbolMouseOveredZukaku);

        //     });
        //   };
        // };

        function addZukakuGraphics(feature, graphicsLayer, symbol){
          // 取得したフィーチャをグラフィックスに追加
          const graphicSelectedZukaku = new Graphic({  // graphic with point geometry
            geometry: feature.geometry, // set geometry here
            symbol: symbol // set symbol here
          });
          graphicsLayer.add(graphicSelectedZukaku);
        };

        // ビューをクリック
        view.on("click", function(event) {
          if(view.map === map){
            queryFeaturesClickedPoint(event);
          } else {
            return;
          };
          
        });

        // ポリゴンをクリック
        function queryFeaturesClickedPoint(screenPoint) {

          const clickedPoint = view.toMap(screenPoint);

          // フィルターのかかったレイヤービューに対してクエリする
          const queryParams = zukakuLayerView.filter.createQuery();
          queryParams.geometry = clickedPoint;
          queryParams.spatialRelationship = "intersects";
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];

          // ベースマップギャラリーがアクティブな場合は削除
          if (document.getElementsByClassName("esri-basemap-gallery").length > 0) {
            document.getElementsByClassName("esri-basemap-gallery")[0].parentNode.removeChild(document.getElementsByClassName("esri-basemap-gallery")[0]);
            if (listMenu[1].elm.classList.contains("active-menu")) {
              listMenu[1].elm.classList.remove("active-menu");
            };
          } else if (document.getElementsByClassName("esri-legend").length > 0) {
            // 凡例ウィジェットがアクティブな場合は削除
            document.getElementsByClassName("esri-legend")[0].parentNode.removeChild(document.getElementsByClassName("esri-legend")[0]);
            if (listMenu[3].elm.classList.contains("active-menu")) {
              listMenu[3].elm.classList.remove("active-menu");
            };
          } else if (listMenu[0].elm.classList.contains("active-menu")) {
            // 計測ウィジェットがアクティブな場合は削除
            listMenu[0].elm.classList.remove("active-menu");
            view.ui.remove(toolbarMeasureDiv);
          } else if (view.map === map && !measurement.activeWidget){
            // ビューがmapで、計測ウィジェットがアクティブでないときのみ
            zukakuLayerView.queryFeatures(queryParams)
            .then(queryArcGISOnline)
            .then(addZukakuAttribute)
            .catch(function(error) {
              console.log(error);
            });
          };

        };

        const mapSecond = new Map({
          basemap: map.basemap
        });;
        const defaultTransparency = 75;
        
        let tileLayer;
        let northId;
        let southId;
        let westId;
        let eastId;

        // AGOLから該当するタイルレイヤーを検索
        function queryArcGISOnline(response){

          const featuresQuery = response.features;
          
          const length = featuresQuery.length;
          // フィーチャがない場所をクリックしたとき
          if (length === 0){
            
            return;

          // タイルレイヤーを検索する
          } else if (length === 1) {
            loaderDiv.classList.add("is-active");

            const feature = response.features[0];

            const id = feature.attributes.id;
            console.log(id);
            northId = feature.attributes.north;
            southId = feature.attributes.south;
            westId = feature.attributes.west;
            eastId = feature.attributes.east;
            
            portal.load().then(function() {
              const queryParams = {
                query: QUERYTXT + id,
                sortField: "numViews",
                sortOrder: "desc",
                num: 20
              };
              portal.queryItems(queryParams).then(addTileLayer);
            });
            return response;
          };
        };

        

        

        

        function addTileLayer(response){
          const itemId = response.results[0].id;

          const tileLayerUrl = response.results[0].url;
          tileLayer = new TileLayer({
            url: tileLayerUrl
          });
          
          // すでに追加されている外邦図を削除
          mapSecond.removeAll();
          mapSecond.add(tileLayer);
          tileLayer.opacity = defaultTransparency/100;

          var options = {
            query: {
              f: "json"
            },
            responseType: "json"
          };

          esriRequest(tileLayerUrl, options)
            .then(createTileView)
        };

        const opacitySlider = new Slider({
          container: "opacitySlider",
          min: 0,
          max: 100,
          steps: 0.1,
          values: [defaultTransparency],
          visibleElements: {
            labels: false,
            rangeLabels: true
          }
        });


        function createDirectionBtn (id, attId, classIcon, text) {
          const deferred = new Deferred();
          
          const queryParams = zukakuFeatureLayer.createQuery();
          queryParams.returnGeometry = false;
          queryParams.outFields = ["georeference"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
            .then(function(response){

              const arrowBtn = document.createElement('button');

              if (response.features.length > 0){
                const feature = response.features[0];

                const georeferenceflg = feature.attributes.georeference;
                // 隣接図郭のサービスはあがっているとは限らない
                if (georeferenceflg === 1) {
                  
                  arrowBtn.setAttribute("id", attId);
                  arrowBtn.setAttribute("data-id", id);
                  arrowBtn.className = "esri-button direction";

                  const arrowIconDiv = document.createElement('div');
                  arrowIconDiv.className = "padding-right-half " + classIcon;
                  arrowBtn.appendChild(arrowIconDiv);

                  arrowBtn.insertAdjacentHTML('beforeend', text);

                }
              }

              deferred.resolve(arrowBtn);

            }).catch(function(error) {
              console.error("query failed: ", error);
            });
          
          return deferred.promise;

        };

        function createTileView(response){

          const maxLOD = response.data.maxLOD;
          const minLOD = response.data.minLOD;

          tileLayer.when(function() {
            view.goTo(tileLayer.fullExtent);
          });

          view.map = mapSecond;
          view.constraints = {minZoom: minLOD, maxZoom: maxLOD};

          // メニューボタンの表示、非表示の切り替え
          listMenu[3].elm.style.display = "none";
          listMenu[5].elm.style.display = "block";
          listMenu[6].elm.style.display = "block";

          // 左上のUIの削除
          view.ui.empty("top-left");

          // 透過スライダーを追加
          addOpacitySlider();

          // 東西南北ボタンを追加、ボタンが順番に追加されるようにする
          all([createDirectionBtn(northId, "northBtn", "esri-icon-arrow-up-circled", "North"), 
               createDirectionBtn(southId, "southBtn", "esri-icon-arrow-down-circled", "South"),
               createDirectionBtn(westId, "westBtn", "esri-icon-arrow-left-circled", "West"),
               createDirectionBtn(eastId, "eastBtn", "esri-icon-arrow-right-circled", "East")
              ])
          .then(function(results){
            
            for (let i in results) {
              if (results[i].firstElementChild) {
                view.ui.add(results[i], "top-left");
                results[i].addEventListener("click", showNextImage);
              };
            }
          });

          // ローダーの表示をとめる
          loaderDiv.classList.remove("is-active");
        };

        function showNextImage (event) {

          const id = event.target.dataset.id;
            
          const queryParams = zukakuFeatureLayer.createQuery();
          // set a geometry for querying features by the view's extent
          queryParams.returnGeometry = true;
          queryParams.outFields = ["*"];
          queryParams.where = "id = '" + id + "'";

          zukakuFeatureLayer.queryFeatures(queryParams)
          .then(queryArcGISOnline)
          .then(addZukakuAttribute)
          .catch(function(error) {
            console.log(error);
          });
        };

        // 透過スライダーを追加
        const opacityDiv = document.getElementById("opacityDiv");
        
        function addOpacitySlider () {
          
          opacityDiv.style.display = "block";
          view.ui.add(opacityDiv, "top-left");

          opacitySlider.on(
            ["thumb-change", "thumb-drag"],
            transparencyChanged
          );
        };

        function transparencyChanged(event) {
          const value = event.value;
          tileLayer.opacity = value/100;
        };

        const arrayAtt = [
          {"title": "記号", "att": "area3"},
          {"title": "図幅名", "att": "area_name"},
          {"title": "測量機関", "att": "surveyed_by"},
          {"title": "測量時期（修正含む）", "att": "survey_year"},
          {"title": "製版・印刷機関", "att": "printed_by"},
          {"title": "製版時期", "att": "print_year"},
          {"title": "発行時期", "att": "publish_year"},
          {"title": "大きさ", "att": "size"},
          {"title": "色", "att": "color"},
          {"title": "備考", "att": "notes"},
          {"title": "枚数（実物）", "att": "copies"}
        ];

        function addZukakuAttribute (response) {

          if (typeof response === 'undefined') {
            return;
          }

          const feature = response.features[0];

          
          attributeDiv.innerHTML = "";

          const divArea3_en = document.createElement("div");
          const attArea3_en = feature.attributes.area3_en;
          divArea3_en.className = "padding-leader-half font-size--1";
          divArea3_en.innerHTML = attArea3_en;
          attributeDiv.appendChild(divArea3_en);

          const divTitle = document.createElement("div");
          const attTitle = feature.attributes.title;
          divTitle.className = "font-size--1";
          divTitle.innerHTML = attTitle;
          attributeDiv.appendChild(divTitle);

          const divScale = document.createElement("div");
          const attScale = feature.attributes.scale;
          divScale.className = "padding-leader-half font-size--1";
          divScale.innerHTML = attScale;
          attributeDiv.appendChild(divScale);

          const divPrintedYear = document.createElement("div");
          const attPrintedYear = feature.attributes.print_year_en;
          divPrintedYear.className = "padding-leader-half font-size--1";
          divPrintedYear.innerHTML = "Printed in " + attPrintedYear;
          attributeDiv.appendChild(divPrintedYear);

          const divSize = document.createElement("div");
          const attSize = feature.attributes.height_width;
          divSize.className = "padding-leader-half font-size--1";
          divSize.innerHTML = attSize + " (cm)";
          if (attSize !== "-"){
            attributeDiv.appendChild(divSize);
          }

          const divId = document.createElement("div");
          const attId = feature.attributes.id;
          divId.className = "padding-leader-half font-size--1";
          divId.innerHTML = attId;
          attributeDiv.appendChild(divId);
          

          const details = document.createElement("details");
          details.className = "padding-leader-half font-size--1";
          attributeDiv.appendChild(details);

          const summary = document.createElement("summary");
          summary.innerHTML = "Details in Japanese";
          details.appendChild(summary);

          for(let i = 0; i < arrayAtt.length; i++) {

            const field = arrayAtt[i]["att"];
            const attValue = feature.attributes[field];

            const attribute = document.createElement("div");
            attribute.className = "padding-leader-half padding-left-half font-size--1";
            details.appendChild(attribute);
            
            const title = document.createElement("div");
            attribute.appendChild(title);
            title.style.color = "gray";
            title.innerHTML = arrayAtt[i]["title"];

            const value = document.createElement("div");
            attribute.appendChild(value);
            
            value.innerHTML = attValue;
          };
        };

        // back to index map
        listMenu[6].elm.onclick = function(){

          loaderDiv.classList.add('is-active');

          view.map = map;
          // 背景図をセットする
          map.basemap = mapSecond.basemap;

          refreshMenu();

          // 透過スライダーを非表示にする
          opacityDiv.style.display = "none";

          // 左上のUIを全て削除する
          view.ui.empty("top-left");

          // 縮尺ボタンを追加する
          addScaleButton(scaleId);

          // 属性表示を閉じる
          // closeAttributeDiv();

          // 縮尺制限を解除する
          view.constraints = {minZoom: 0, maxZoom: 23};

          view.on("layerview-create", function(event) {
            // The event contains the layer and its layer view that has just been
            // created. Here we check for the creation of a layer view for a layer with
            // a specific id, and log the layer view
            if (event.layer.title === "図郭") {
              // The LayerView for the desired layer
              zukakuLayerView = event.layerView;
              zukakuLayerView.filter = {
                where: whereClause
              };
            };
          });

          watchUtils.whenOnce(view, "ready")
          .then(function(){
            view.goTo({
              target: viewCenter,
              zoom: viewZoom
            });
          });

          // メニューボタンの表示、非表示の切り替え
          listMenu[3].elm.style.display = "block";
          listMenu[5].elm.style.display = "none";
          listMenu[6].elm.style.display = "none";

          view.watch('updating', function(evt){
            if(!evt){
              loaderDiv.classList.remove('is-active');
            };
          });

        };
        
      });
    </script>
  </head>

  <body>
    
    <div class="wrapper">

      <div class="js-modal modal-overlay" data-modal="foo" id="modal">
        <div class="modal-content column-12" role="dialog" aria-labelledby="modal">
          <a class="js-modal-toggle right" href="#" aria-label="close-modal" id="closeModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" viewBox="0 0 32 32" class="svg-icon"><path d="M18.404 16l9.9 9.9-2.404 2.404-9.9-9.9-9.9 9.9L3.696 25.9l9.9-9.9-9.9-9.898L6.1 3.698l9.9 9.899 9.9-9.9 2.404 2.406-9.9 9.898z"/></svg>
          </a>
          <h3 class='trailer-half'>About</h3>
            <p>Gaihozu meaning “maps of outer lands” is the maps of areas outside the Japanese Islands by former Japanese Imperial Army before the end of the World War II. Despite the fact that these maps were prepared for military purpose, they contain the valuable records of detailed landscapes including landuse and landcover in the past. This site was designed with ArcGIS online technology to interactively view about 680 geo-referenced maps in Indonesian territory from the collection of Gaihozu at Tohoku University.</p>
            <p>Clicking a shaded box on the index map enable you to show the corresponding map with its cartographic information, such as map scale and printed year. The histograms on the right-side of this site displays the count distributions of available maps by printed year and map scale.</p>
            <p>If you need further information on Gaihozu, visit the <a href="http://chiri.es.tohoku.ac.jp/~gaihozu/index.php?lang=en-US" target="_blank">Gaihozu Digital Archive </a>maintained by the Tohoku University Library and the Institute of Geography, Graduate School of Science, Tohoku University.</p>
            <p>Copyright: Human Geography Group at Tohoku University, 2020</p>
            <p>Project team members: Nakaya, T., Nagata, S., Y. Isoda and R. Sekine (Tohoku University) + Y. Hoshida (<a href="http://www.openconcierge.org/" target="_blank">OpenConcierge</a>)</p>
          
          <div class="right">
            <fieldset class="fieldset-checkbox padding-right-2">
              <label><input type="checkbox" id="notShowAgainChk">Don't show this message again.</label>
            </fieldset>
            <button class="btn js-modal-toggle" id="closeModalBtn">Close</button>
            <!-- <button class="btn btn-clear js-modal-toggle">cancel</button> -->
          </div>
        </div>
      </div>

      <div id="titleDiv" class="esri-widget">
        <a class="top-nav-title margin-left-1">
          Gaihozu Viewer
          <span class="tablet-hide phone-hide"> : Indonesian-territory version (GV-I)</span>
        </a>
      </div>
      
      <div id="viewDiv"></div>

      <div id="toolbarMeasureDiv" class="esri-component esri-widget">
        <button
          id="distanceMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-measure-line"
          title="Distance Measurement Tool"
        ></button>
        <button
          id="areaMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-measure-area"
          title="Area Measurement Tool"
        ></button>
        <button
          id="clearMeasureBtn"
          class="esri-widget--button esri-interactive esri-icon-trash"
          title="Clear Measurements"
        ></button>
      </div>

      <div id="opacityDiv" class="esri-widget padding-leader-half padding-trailer-half padding-left-half padding-right-half">
        <div class="padding-trailer-half">Opacity</div>
        <div id="opacitySlider" class="slider"></div>
      </div>

      <!-- <button class="esri-button direction" id="northBtn" type="button">
        <div class="esri-icon-arrow-up-circled padding-right-half"></div>
        north
      </button>
      <button class="esri-button direction" id="southBtn" type="button">
        <div class="esri-icon-arrow-down-circled padding-right-half"></div>
        south
      </button>
      <button class="esri-button direction" id="westBtn" type="button">
        <div class="esri-icon-arrow-left-circled padding-right-half"></div>
        west
      </button>
      <button class="esri-button direction" id="eastBtn" type="button">
        <div class="esri-icon-arrow-right-circled padding-right-half"></div>
        east
      </button> -->

      <div class="loader is-active" id="loaderDiv">
        <div class="loader-bars"></div>
        <!-- <div class="loader-text">Loading...</div> -->
      </div>


      <div id="menuDiv" class="text-center"></div>

      <div id="attributeDiv"></div>

    </div>
  </body>
</html>
